<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Mini CRM Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f1f5f9;
        color: #0f172a;
      }
      .app-shell {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      header {
        background: #0f172a;
        color: #e5e7eb;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }
      header .user-info {
        font-size: 13px;
        opacity: 0.9;
      }
      main {
        flex: 1;
        max-width: 1120px;
        margin: 16px auto 24px;
        padding: 0 12px;
        width: 100%;
      }
      .card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        padding: 16px 18px;
      }
      .login-title {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 18px;
        font-weight: 600;
      }
      .field {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      label {
        font-size: 13px;
        color: #4b5563;
      }
      input {
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-size: 14px;
        font-family: inherit;
      }
      input:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }
      button {
        border-radius: 999px;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: #0ea5e9;
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: default;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .login-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 4px;
      }
      .status {
        font-size: 13px;
        margin-top: 8px;
      }
      .status.error {
        color: #b91c1c;
      }
      .status.ok {
        color: #15803d;
      }
      .tabs {
        margin-top: 16px;
        margin-bottom: 8px;
        display: inline-flex;
        border-radius: 999px;
        background: #e5e7eb;
        padding: 2px;
      }
      .tab-btn {
        border-radius: 999px;
        border: none;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        background: transparent;
        color: #4b5563;
      }
      .tab-btn.active {
        background: #ffffff;
        color: #0f172a;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.18);
      }
      .table-wrap {
        margin-top: 12px;
        overflow-x: auto;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
      }
      thead {
        background: #f8fafc;
      }
      th, td {
        padding: 8px 10px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: top;
      }
      th {
        font-weight: 600;
        color: #475569;
        white-space: nowrap;
      }
      tbody tr:hover {
        background: #f9fafb;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #e0f2fe;
        color: #0369a1;
      }
      .status-select {
        border-radius: 999px;
        border: 1px solid #cbd5e1;
        padding: 2px 8px;
        font-size: 11px;
        background: #ffffff;
      }
      .muted {
        color: #9ca3af;
        font-size: 12px;
      }
      .pill {
        border-radius: 999px;
        padding: 2px 8px;
        background: #f3f4f6;
        font-size: 11px;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 40;
      }
      .modal {
        background: #ffffff;
        border-radius: 12px;
        max-width: 640px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      }
      .modal-header,
      .modal-footer {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-footer {
        border-bottom: none;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }
      .modal-body {
        padding: 12px 16px;
        overflow-y: auto;
      }
      #case-modal-internal-note {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
      }
      #case-modal-internal-note:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }
      tr.case-row {
        cursor: pointer;
      }
      tr.case-row:hover {
        background: #eef2ff;
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }
        main {
          margin-top: 12px;
        }
      }
    
      .filters-row {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn-ghost {
        background: transparent;
        color: #0f172a;
        border: 1px solid #cbd5f5;
      }
      .btn-ghost.active {
        background: #1d4ed8;
        color: #ffffff;
        border-color: #1d4ed8;
      }

      .filters-row {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn-ghost {
        background: transparent;
        color: #0f172a;
        border: 1px solid #cbd5f5;
      }
      .btn-ghost .filter-counter {
        margin-left: 4px;
        font-size: 12px;
        opacity: 0.8;
      }
      .btn-ghost.active {
        border-color: #1d4ed8;
      }
      .case-filter-btn[data-filter="all"].active {
        background: #e5e7eb;
        color: #111827;
      }
      .case-filter-btn[data-filter="new"].active {
        background: #fee2e2;
        color: #b91c1c;
      }
      .case-filter-btn[data-filter="in_progress"].active {
        background: #fef9c3;
        color: #92400e;
      }
      .case-filter-btn[data-filter="done"].active {
        background: #dcfce7;
        color: #166534;
      }
      .status-row-new td {
        background: #fef2f2;
      }
      .status-row-in_progress td {
        background: #fffbeb;
      }
      .status-row-done td {
        background: #ecfdf3;
      }

      .case-tasks-form {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .case-tasks-form input {
        flex: 1;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        padding: 6px 8px;
        font-family: inherit;
        font-size: 14px;
      }

      .case-tasks-form input:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }

      .case-tasks-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .case-task-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .case-task-item input[type='checkbox'] {
        margin: 0;
      }

      .case-task-done {
        text-decoration: line-through;
        opacity: 0.6;
      }

      .case-task-delete-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        padding: 0 4px;
        color: #64748b;
      }

      .case-task-delete-btn:hover {
        color: #ef4444;
      }

      .case-tasks-empty {
        font-size: 13px;
        color: #94a3b8;
      }
</style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <h1>Mini CRM Admin</h1>
        <div class="user-info" id="user-info">Не авторизовано</div>
      </header>
      <main>
        <div class="card" id="login-card">
          <h2 class="login-title">Вхід до CRM</h2>
          <form id="login-form">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="username" required />
            </div>
            <div class="field">
              <label for="password">Пароль</label>
              <input id="password" name="password" type="password" autocomplete="current-password" required />
            </div>
            <div class="login-actions">
              <button type="submit" id="login-btn">Увійти</button>
              <button type="button" class="btn-secondary" id="logout-btn" style="display:none;">Вийти</button>
            </div>
            <div class="status" id="login-status"></div>
          </form>
        </div>

        <div class="card" id="data-card" style="margin-top: 16px; display:none;">
          <div class="tabs">
            <button class="tab-btn active" data-tab="cases">Звернення (Cases)</button>
            <button class="tab-btn" data-tab="contacts">Контакти (Contacts)</button>
          </div>

          <div id="cases-view">
            <div class="muted">Показуються останні звернення по поточному проєкту користувача.</div>
            <div class="filters-row">
              <button class="btn btn-secondary btn-ghost case-filter-btn active" data-filter="all">
                Усі <span class="filter-counter" data-counter-for="all">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="new">
                New <span class="filter-counter" data-counter-for="new">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="in_progress">
                In progress <span class="filter-counter" data-counter-for="in_progress">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="done">
                Done <span class="filter-counter" data-counter-for="done">0</span>
              </button>
            </div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Статус</th>
                    <th>Заголовок</th>
                    <th>Контакт</th>
                    <th>Джерело</th>
                    <th>Створено</th>
                    <th>Нотатки</th>
                  </tr>
                </thead>
                <tbody id="cases-tbody">
                  <tr><td colspan="6" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div id="contacts-view" style="display:none;">
            <div class="muted">Контакти, привʼязані до поточного проєкту користувача.</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Імʼя</th>
                    <th>Email</th>
                    <th>Телефон</th>
                    <th>Створено</th>
                  </tr>
                </thead>
                <tbody id="contacts-tbody">
                  <tr><td colspan="4" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="modal-backdrop" id="case-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2 id="case-modal-title">Кейс</h2>
              <button type="button" class="btn-secondary" id="case-modal-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div class="field">
                <label>Статус</label>
                <span class="pill" id="case-modal-status"></span>
              </div>
              <div class="field">
                <label>Заголовок</label>
                <div id="case-modal-main-title"></div>
              </div>
              <div class="field">
                <label>Опис (з форми)</label>
                <div class="muted" id="case-modal-description"></div>
              </div>
              <div class="field">
                <label>Контакт</label>
                <div id="case-modal-contact"></div>
              </div>
              <div class="field">
                <label>Джерело</label>
                <div id="case-modal-source"></div>
              </div>
              <div class="field">
                <label>Внутрішні нотатки</label>
                <textarea id="case-modal-internal-note" rows="4" placeholder="Нотатки менеджера по цьому зверненню"></textarea>
              </div>
              <div class="field">
                <label>Tasks</label>
                <form id="case-tasks-form" class="case-tasks-form">
                  <input
                    id="case-task-input"
                    type="text"
                    placeholder="Нова задача…"
                    autocomplete="off"
                  />
                  <button type="submit">Додати</button>
                </form>
                <ul id="case-tasks-list" class="case-tasks-list"></ul>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="case-modal-save">Зберегти</button>
              <button type="button" class="btn-secondary" id="case-modal-cancel">Скасувати</button>
            </div>
          </div>
        </div>

      </main>
    </div>

    <script>
      (function () {
        var apiBase = window.location.origin;
        var tokenKey = 'mini-crm-admin-token';
        var CASE_STATUSES = ['new', 'in_progress', 'done'];
        var currentCaseFilter = 'all';
        var caseFilterButtons = document.querySelectorAll('.case-filter-btn');
        console.log('mini-crm admin: filters found', caseFilterButtons.length);

        if (caseFilterButtons && caseFilterButtons.length) {
          caseFilterButtons.forEach(function (btn) {
            btn.addEventListener('click', function () {
              var value = btn.getAttribute('data-filter') || 'all';
              caseFilterButtons.forEach(function (b) {
                b.classList.toggle('active', b === btn);
              });
              applyCaseFilter(value);
            });
          });
        }


        function applyCaseFilter(filter) {
          if (typeof filter === 'string') {
            currentCaseFilter = filter;
          }
          renderCases(lastCases);
        }


        var loginForm = document.getElementById('login-form');
        var loginBtn = document.getElementById('login-btn');
        var logoutBtn = document.getElementById('logout-btn');
        var loginStatus = document.getElementById('login-status');
        var userInfoEl = document.getElementById('user-info');
        var dataCard = document.getElementById('data-card');
        var casesTbody = document.getElementById('cases-tbody');
        var contactsTbody = document.getElementById('contacts-tbody');
        var loginCard = document.getElementById('login-card');
        var tabs = document.querySelectorAll('.tab-btn');
        var casesView = document.getElementById('cases-view');
        var contactsView = document.getElementById('contacts-view');

        var caseModalBackdrop = document.getElementById('case-modal-backdrop');
        var caseModalClose = document.getElementById('case-modal-close');
        var caseModalCancel = document.getElementById('case-modal-cancel');
        var caseModalSave = document.getElementById('case-modal-save');
        var caseModalTitle = document.getElementById('case-modal-title');
        var caseModalMainTitle = document.getElementById('case-modal-main-title');
        var caseModalStatusEl = document.getElementById('case-modal-status');
        var caseModalDescription = document.getElementById('case-modal-description');
        var caseModalContact = document.getElementById('case-modal-contact');
        var caseModalSource = document.getElementById('case-modal-source');
        var caseModalInternalNote = document.getElementById('case-modal-internal-note');
        var currentCaseId = null;
        var currentCaseInitialInternalNote = '';
        var lastCases = [];
        var caseTasksForm = document.getElementById('case-tasks-form');
        var caseTaskInput = document.getElementById('case-task-input');
        var caseTasksList = document.getElementById('case-tasks-list');
        var currentCaseTasks = [];



        function setStatus(message, isError) {
          loginStatus.textContent = message || '';
          loginStatus.className = 'status' + (isError ? ' error' : message ? ' ok' : '');
        }

        function setUserInfo(user) {
          if (!user) {
            userInfoEl.textContent = 'Не авторизовано';
            return;
          }
          userInfoEl.textContent =
            user.email + ' · роль: ' + user.role + ' · проєкт #' + user.projectId;
        }

        function getToken() {
          return window.localStorage.getItem(tokenKey);
        }

        function setToken(token) {
          if (token) {
            window.localStorage.setItem(tokenKey, token);
          } else {
            window.localStorage.removeItem(tokenKey);
          }
        }

        function authedFetch(path, options) {
          var token = getToken();
          if (!token) {
            return Promise.reject(new Error('No token'));
          }
          var headers = Object.assign(
            { 'Content-Type': 'application/json' },
            (options && options.headers) || {}
          );
          headers['Authorization'] = 'Bearer ' + token;
          return fetch(apiBase + path, Object.assign({}, options, { headers: headers }));
        }

        function formatDate(iso) {
          if (!iso) return '';
          try {
            var d = new Date(iso);
            if (Number.isNaN(d.getTime())) return iso;
            return d.toLocaleString();
          } catch (e) {
            return iso;
          }
        }


        function formatContactForModal(contact) {
          if (!contact) return '<span class="muted">нема даних</span>';
          var parts = [];
          if (contact.name) parts.push(contact.name);
          if (contact.email) parts.push(contact.email);
          if (contact.phone) parts.push(contact.phone);
          if (parts.length === 0) return '<span class="muted">нема даних</span>';
          return parts.join(' · ');
        }

        function renderCases(cases) {
          lastCases = Array.isArray(cases) ? cases : [];
          var list = lastCases;
          var counts = { all: lastCases.length, new: 0, in_progress: 0, done: 0 };
          lastCases.forEach(function (c) {
            var st = c.status || 'new';
            if (st === 'new') counts.new++;
            else if (st === 'in_progress') counts.in_progress++;
            else if (st === 'done') counts.done++;
          });
          if (caseFilterButtons && caseFilterButtons.length) {
            caseFilterButtons.forEach(function (btn) {
              var f = btn.getAttribute('data-filter') || 'all';
              var span = btn.querySelector('.filter-counter[data-counter-for="' + f + '"]');
              if (span) {
                var value = f === 'all' ? counts.all : (counts[f] || 0);
                span.textContent = value;
              }
            });
          }

          if (currentCaseFilter && currentCaseFilter !== 'all') {
            list = list.filter(function (c) {
              var status = c.status || 'new';
              return status === currentCaseFilter;
            });
          }
          if (!Array.isArray(list) || list.length === 0) {
            casesTbody.innerHTML = '<tr><td colspan="6" class="muted">Немає даних</td></tr>';
            return;
          }
          var rows = list
            .map(function (c) {
              var contact = c.contact || {};
              var contactStr =
                [contact.name, contact.email, contact.phone].filter(Boolean).join(' · ') ||
                '<span class="muted">нема даних</span>';
              var status = c.status || 'new';
              var source = c.source || '–';

              var statuses = CASE_STATUSES.slice();
              if (status && statuses.indexOf(status) === -1) {
                statuses.push(status);
              }

              var selectHtml =
                '<select class="status-select" data-case-id="' +
                c.id +
                '">' +
                statuses
                  .map(function (s) {
                    var selected = s === status ? ' selected' : '';
                    return '<option value="' + s + '"' + selected + '>' + s + '</option>';
                  })
                  .join('') +
                '</select>';

              var notePreview = c.internalNote ? 'є' : '—';
              var rowClass = 'status-row-' + status;

              return (
                '<tr class="case-row ' + rowClass + '" data-case-id="' + c.id + '">' +
                '<td>' + selectHtml + '</td>' +
                '<td>' +
                (c.title || '') +
                (c.description ? '<div class="muted">' + c.description + '</div>' : '') +
                '</td>' +
                '<td>' + contactStr + '</td>' +
                '<td><span class="pill">' + source + '</span></td>' +
                '<td>' + formatDate(c.createdAt) + '</td>' +
                '<td>' + notePreview + '</td>' +
                '</tr>'
              );
            })
            .join('');
          casesTbody.innerHTML = rows;

          var selects = casesTbody.querySelectorAll('.status-select');
          var rows = casesTbody.querySelectorAll('tr.case-row');
          rows.forEach(function (row) {
            row.addEventListener('click', function (e) {
              if (e.target && e.target.closest && e.target.closest('.status-select')) {
                return;
              }
              var idAttr = row.getAttribute('data-case-id');
              var id = Number(idAttr);
              if (!idAttr || Number.isNaN(id)) return;
              openCaseModal(id);
            });
          });

          selects.forEach(function (sel) {
            sel.addEventListener('change', function () {
              var idAttr = sel.getAttribute('data-case-id');
              var id = Number(idAttr);
              if (!idAttr || Number.isNaN(id)) {
                console.warn('Invalid case id on select', idAttr);
                return;
              }
              var newStatus = sel.value;
              setStatus('Оновлення статусу кейсу...', false);

              authedFetch('/cases/' + id, {
                method: 'PATCH',
                body: JSON.stringify({ status: newStatus }),
              })
                .then(function (res) {
                  if (!res.ok) {
                    return res
                      .json()
                      .catch(function () {
                        return { error: 'Failed to update case' };
                      })
                      .then(function (data) {
                        throw new Error(data.error || 'Failed to update case');
                      });
                  }
                  return res.json();
                })
                .then(function () {
                  setStatus('Статус кейсу оновлено', false);
                  loadData();
                })
                .catch(function (err) {
                  console.error('Failed to update case', err);
                  setStatus(err.message || 'Не вдалося оновити статус кейсу', true);
                });
            });
          });
        }

        function renderContacts(contacts) {
          if (!Array.isArray(contacts) || contacts.length === 0) {
            contactsTbody.innerHTML = '<tr><td colspan="4" class="muted">Немає даних</td></tr>';
            return;
          }
          var rows = contacts
            .map(function (c) {
              return (
                '<tr>' +
                '<td>' + (c.name || '<span class="muted">Без імені</span>') + '</td>' +
                '<td>' + (c.email || '<span class="muted">–</span>') + '</td>' +
                '<td>' + (c.phone || '<span class="muted">–</span>') + '</td>' +
                '<td>' + formatDate(c.createdAt) + '</td>' +
                '</tr>'
              );
            })
            .join('');
          contactsTbody.innerHTML = rows;
        }

        function loadData() {
          Promise.all([
            authedFetch('/cases').then(function (res) {
              if (!res.ok) throw new Error('Failed to load cases');
              return res.json();
            }),
            authedFetch('/contacts').then(function (res) {
              if (!res.ok) throw new Error('Failed to load contacts');
              return res.json();
            }),
          ])
            .then(function (results) {
              renderCases(results[0]);
              renderContacts(results[1]);
            })
            .catch(function (err) {
              console.error('Failed to load data', err);
              setStatus('Не вдалося завантажити дані. Перевірте токен / права доступу.', true);
            });
        }

        tabs.forEach(function (btn) {
          btn.addEventListener('click', function () {
            tabs.forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');

            var tab = btn.getAttribute('data-tab');
            if (tab === 'cases') {
              casesView.style.display = '';
              contactsView.style.display = 'none';
            } else {
              casesView.style.display = 'none';
              contactsView.style.display = '';
            }
          });
        });

        loginForm.addEventListener('submit', function (e) {
          e.preventDefault();
          setStatus('', false);
          loginBtn.disabled = true;
          var email = (document.getElementById('email')).value;
          var password = (document.getElementById('password')).value;

          fetch(apiBase + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, password: password }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res.json().catch(function () {
                  return { error: 'Login failed' };
                }).then(function (data) {
                  throw new Error(data.error || 'Login failed');
                });
              }
              return res.json();
            })
            .then(function (data) {
              setToken(data.token);
              setUserInfo(data.user);
              setStatus('Успішний вхід', false);
              dataCard.style.display = '';
              logoutBtn.style.display = 'inline-flex';
              loadData();
            })
            .catch(function (err) {
              console.error('Login error', err);
              setToken(null);
              setUserInfo(null);
              dataCard.style.display = 'none';
              logoutBtn.style.display = 'none';
              setStatus(err.message || 'Помилка входу', true);
            })
            .finally(function () {
              loginBtn.disabled = false;
            });
        });

        logoutBtn.addEventListener('click', function () {
          setToken(null);
          setUserInfo(null);
          dataCard.style.display = 'none';
          logoutBtn.style.display = 'none';
          setStatus('Вийшли з системи', false);
        });

        // Try to restore existing token

        function openCaseModal(id) {
          if (!lastCases || !Array.isArray(lastCases)) return;
          var c = lastCases.find(function (item) { return item.id === id; });
          if (!c) return;
          currentCaseId = id;
          caseModalTitle.textContent = 'Кейс #' + id;
          caseModalMainTitle.textContent = c.title || '';
          caseModalStatusEl.textContent = c.status || 'new';
          caseModalDescription.textContent = c.description || '';
          caseModalContact.innerHTML = formatContactForModal(c.contact || null);
          caseModalSource.textContent = c.source || '–';
          currentCaseInitialInternalNote = c.internalNote || '';
          caseModalInternalNote.value = currentCaseInitialInternalNote;
          caseModalBackdrop.style.display = 'flex';

          currentCaseTasks = [];
          renderCaseTasks();
          loadCaseTasks(id);
        }


        function loadCaseTasks(caseId) {
          if (!caseTasksList) return;
          authedFetch('/cases/' + caseId + '/tasks')
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to load tasks');
              }
              return res.json();
            })
            .then(function (data) {
              if (!Array.isArray(data)) {
                currentCaseTasks = [];
              } else {
                currentCaseTasks = data;
              }
              renderCaseTasks();
            })
            .catch(function (err) {
              console.error('Failed to load tasks', err);
              currentCaseTasks = [];
              renderCaseTasks();
            });
        }

        function renderCaseTasks() {
          if (!caseTasksList) return;
          caseTasksList.innerHTML = '';

          if (!currentCaseTasks || currentCaseTasks.length === 0) {
            var emptyLi = document.createElement('li');
            emptyLi.textContent = 'Поки що немає задач.';
            emptyLi.className = 'case-tasks-empty';
            caseTasksList.appendChild(emptyLi);
            return;
          }

          currentCaseTasks.forEach(function (task) {
            var li = document.createElement('li');
            li.className = 'case-task-item';

            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!task.done;
            checkbox.addEventListener('change', function () {
              updateTaskDone(task.id, checkbox.checked);
            });

            var span = document.createElement('span');
            span.textContent = task.title || '';
            if (task.done) {
              span.classList.add('case-task-done');
            }

            var delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.textContent = '✕';
            delBtn.className = 'case-task-delete-btn';
            delBtn.addEventListener('click', function () {
              deleteTask(task.id);
            });

            li.appendChild(checkbox);
            li.appendChild(span);
            li.appendChild(delBtn);

            caseTasksList.appendChild(li);
          });
        }

        function addCaseTask(title) {
          if (!currentCaseId) return;
          setStatus('Створення задачі...', false);
          authedFetch('/cases/' + currentCaseId + '/tasks', {
            method: 'POST',
            body: JSON.stringify({ title: title }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to create task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to create task');
                  });
              }
              return res.json();
            })
            .then(function (task) {
              caseTaskInput.value = '';
              currentCaseTasks.push(task);
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу створено', false);
            })
            .catch(function (err) {
              console.error('Failed to create task', err);
              setStatus(err.message || 'Не вдалося створити задачу', true);
            });
        }

        function updateTaskDone(taskId, done) {
          setStatus('Оновлення задачі...', false);
          authedFetch('/tasks/' + taskId, {
            method: 'PATCH',
            body: JSON.stringify({ done: !!done }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update task');
                  });
              }
              return res.json();
            })
            .then(function (updated) {
              currentCaseTasks = currentCaseTasks.map(function (t) {
                return t.id === updated.id ? updated : t;
              });
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу оновлено', false);
            })
            .catch(function (err) {
              console.error('Failed to update task', err);
              setStatus(err.message || 'Не вдалося оновити задачу', true);
            });
        }

        function deleteTask(taskId) {
          setStatus('Видалення задачі...', false);
          authedFetch('/tasks/' + taskId, {
            method: 'DELETE',
          })
            .then(function (res) {
              if (!res.ok && res.status !== 204) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to delete task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to delete task');
                  });
              }
            })
            .then(function () {
              currentCaseTasks = currentCaseTasks.filter(function (t) {
                return t.id !== taskId;
              });
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу видалено', false);
            })
            .catch(function (err) {
              console.error('Failed to delete task', err);
              setStatus(err.message || 'Не вдалося видалити задачу', true);
            });
        }

        function syncCaseStatusWithTasks() {
          if (!currentCaseId || !Array.isArray(currentCaseTasks)) {
            return;
          }

          var nextStatus;
          if (currentCaseTasks.length === 0) {
            // Якщо задач немає — кейс повертається в стан "new"
            nextStatus = 'new';
          } else {
            var anyOpen = currentCaseTasks.some(function (t) { return !t.done; });
            nextStatus = anyOpen ? 'in_progress' : 'done';
          }

          var c = lastCases.find(function (item) { return item.id === currentCaseId; });
          if (!c || c.status === nextStatus) {
            return;
          }

          setStatus('Оновлення статусу кейсу за задачами...', false);
          authedFetch('/cases/' + currentCaseId, {
            method: 'PATCH',
            body: JSON.stringify({ status: nextStatus }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update case status' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update case status');
                  });
              }
              return res.json();
            })
            .then(function () {
              c.status = nextStatus;
              caseModalStatusEl.textContent = nextStatus;
              loadData();
              setStatus('Статус кейсу оновлено за задачами', false);
            })
            .catch(function (err) {
              console.error('Failed to auto-update case status', err);
              setStatus(err.message || 'Не вдалося оновити статус кейсу', true);
            });
        }

        function closeCaseModal() {
          currentCaseId = null;
          caseModalBackdrop.style.display = 'none';
        }

        caseModalClose.addEventListener('click', function () {
          closeCaseModal();
        });
        caseModalCancel.addEventListener('click', function () {
          if (!currentCaseId) {
            closeCaseModal();
            return;
          }
          // Відкатити внутрішні нотатки до початкового стану
          caseModalInternalNote.value = currentCaseInitialInternalNote || '';
          // Очистити поле введення нової задачі (якщо щось було набрано)
          if (typeof caseTaskInput !== 'undefined' && caseTaskInput) {
            caseTaskInput.value = '';
          }
          setStatus('Зміни скасовано', false);
        });

        // Закривати модальне вікно по Esc
        document.addEventListener('keydown', function (event) {
          if (event.key === 'Escape' || event.key === 'Esc') {
            if (caseModalBackdrop && caseModalBackdrop.style.display === 'flex') {
              closeCaseModal();
            }
          }
        });

// Клік поза модальним вікном більше не закриває його, щоб випадково не втрачати контекст
        caseModalSave.addEventListener('click', function () {
          if (!currentCaseId) return;
          var note = caseModalInternalNote.value || '';
          setStatus('Збереження нотаток кейсу...', false);
          authedFetch('/cases/' + currentCaseId, {
            method: 'PATCH',
            body: JSON.stringify({ internalNote: note }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update case' }; })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update case');
                  });
              }
              return res.json();
            })
            .then(function () {
              setStatus('Нотатки кейсу збережено', false);
              closeCaseModal();
              loadData();
            })
            .catch(function (err) {
              console.error('Failed to save case notes', err);
              setStatus(err.message || 'Не вдалося зберегти нотатки кейсу', true);
            });
        });

        if (caseTasksForm && caseTaskInput) {
          caseTasksForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!currentCaseId) return;
            var title = (caseTaskInput.value || '').trim();
            if (!title) return;
            addCaseTask(title);
          });
        }

        var existingToken = getToken();
        if (existingToken) {
          authedFetch('/auth/me')
            .then(function (res) {
              if (!res.ok) throw new Error('Not authenticated');
              return res.json();
            })
            .then(function (data) {
              setUserInfo(data.user);
              dataCard.style.display = '';
              logoutBtn.style.display = 'inline-flex';
              setStatus('Сесія відновлена', false);
              loadData();
            })
            .catch(function () {
              setToken(null);
              setUserInfo(null);
            });
        }
      })();
    
    
    </script>
  </body>
</html>
