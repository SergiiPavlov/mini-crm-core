<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Mini CRM Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f1f5f9;
        color: #0f172a;
      }
      .app-shell {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      header {
        background: #0f172a;
        color: #e5e7eb;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }
      header .user-info {
        font-size: 13px;
        opacity: 0.9;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .project-switcher {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .project-switcher select {
        max-width: 260px;
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #334155;
        background: #0b1220;
        color: #e5e7eb;
        font-size: 13px;
      }
      .project-switcher .btn-secondary {
        padding: 6px 10px;
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      main {
        flex: 1;
        max-width: 1120px;
        margin: 16px auto 24px;
        padding: 0 12px;
        width: 100%;
      }
      .card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        padding: 16px 18px;
      }
      .login-title {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 18px;
        font-weight: 600;
      }
      .field {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      label {
        font-size: 13px;
        color: #4b5563;
      }
      input {
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-size: 14px;
        font-family: inherit;
      }
      input:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }
      button {
        border-radius: 999px;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: #0ea5e9;
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: default;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .login-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 4px;
      }
      .status {
        font-size: 13px;
        margin-top: 8px;
      }
      .status.error {
        color: #b91c1c;
      }
      .status.ok {
        color: #15803d;
      }
      .tabs-row {
        margin-top: 16px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .tabs {
        margin-top: 0;
        margin-bottom: 0;
        display: inline-flex;
        border-radius: 999px;
        background: #e5e7eb;
        padding: 2px;
      }
      .tab-btn {
        border-radius: 999px;
        border: none;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        background: transparent;
        color: #4b5563;
      }
      .tab-btn.active {
        background: #ffffff;
        color: #0f172a;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.18);
      }
      .table-wrap {
        margin-top: 12px;
        overflow-x: auto;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
      }
      thead {
        background: #f8fafc;
      }
      th, td {
        padding: 8px 10px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: top;
      }
      th {
        font-weight: 600;
        color: #475569;
        white-space: nowrap;
      }
      tbody tr:hover {
        background: #f9fafb;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #e0f2fe;
        color: #0369a1;
      }
      .status-select {
        border-radius: 999px;
        border: 1px solid #cbd5e1;
        padding: 2px 8px;
        font-size: 11px;
        background: #ffffff;
      }
      .muted {
        color: #9ca3af;
        font-size: 12px;
      }
      .pill {
        border-radius: 999px;
        padding: 2px 8px;
        background: #f3f4f6;
        font-size: 11px;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 40;
      }
      .modal {
        background: #ffffff;
        border-radius: 12px;
        max-width: 640px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      }
      .modal-header,
      .modal-footer {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-footer {
        border-bottom: none;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }
      .modal-body {
        padding: 12px 16px;
        overflow-y: auto;
      }
      #case-modal-internal-note {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
      }
      #case-modal-internal-note:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }
      tr.case-row {
        cursor: pointer;
      }
      tr.case-row:hover {
        background: #eef2ff;
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }
        main {
          margin-top: 12px;
        }
      }
    
      .filters-row {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn-ghost {
        background: transparent;
        color: #0f172a;
        border: 1px solid #cbd5f5;
      }
      .btn-ghost.active {
        background: #1d4ed8;
        color: #ffffff;
        border-color: #1d4ed8;
      }

      .filters-row {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn-ghost {
        background: transparent;
        color: #0f172a;
        border: 1px solid #cbd5f5;
      }
      .btn-ghost .filter-counter {
        margin-left: 4px;
        font-size: 12px;
        opacity: 0.8;
      }
      .btn-ghost.active {
        border-color: #1d4ed8;
      }
      .case-filter-btn[data-filter="all"].active {
        background: #e5e7eb;
        color: #111827;
      }
      .case-filter-btn[data-filter="new"].active {
        background: #fee2e2;
        color: #b91c1c;
      }
      .case-filter-btn[data-filter="in_progress"].active {
        background: #fef9c3;
        color: #92400e;
      }
      .case-filter-btn[data-filter="done"].active {
        background: #dcfce7;
        color: #166534;
      }
      .status-row-new td {
        background: var(--case-row-bg-new, #fef2f2);
      }
      .status-row-in_progress td {
        background: var(--case-row-bg-in_progress, #fffbeb);
      }
      .status-row-done td {
        background: var(--case-row-bg-done, #ecfdf3);
      }

      .summary-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 12px 0;
      }
      .summary-card {
        flex: 1 1 140px;
        padding: 8px 12px;
        border-radius: 12px;
        background: #f3f4f6;
        font-size: 13px;
      }
      .summary-card-label {
        display: block;
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 2px;
      }
      .summary-card-value {
        font-weight: 600;
        font-size: 14px;
      }
      .summary-card.income {
        background: #ecfdf3;
      }
      .summary-card.expense {
        background: #fef2f2;
      }
      .summary-card.net {
        background: #eff6ff;
      }
      .transaction-row-income td {
        background: #f0fdf4;
      }
      .transaction-row-expense td {
        background: #fef2f2;
      }

      .transaction-row {
        cursor: pointer;
      }
      tr.transaction-row:hover td {
        background: #e0f2fe;
      }


      .case-tasks-form {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .case-tasks-form input {
        flex: 1;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        padding: 6px 8px;
        font-family: inherit;
        font-size: 14px;
      }

      .case-tasks-form input:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }

      .case-tasks-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .case-task-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .case-task-item input[type='checkbox'] {
        margin: 0;
      }

      .case-task-done {
        text-decoration: line-through;
        opacity: 0.6;
      }

      .case-task-delete-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        padding: 0 4px;
        color: #64748b;
      }

      .case-task-delete-btn:hover {
        color: #ef4444;
      }

      .case-tasks-empty {
        font-size: 13px;
        color: #94a3b8;
      }

      .config-panel {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
      }

      .config-panel-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #0f172a;
      }

      .config-panel-subtitle {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .config-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 8px;
      }

      .config-table th,
      .config-table td {
        font-size: 13px;
        padding: 4px 6px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: middle;
      }

      .config-table input[type="text"] {
        width: 100%;
        padding: 4px 6px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }

      .config-table input[type="color"] {
        width: 48px;
        height: 24px;
        padding: 0;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: transparent;
      }

      .config-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
      }
</style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <h1>Mini CRM Admin</h1>
        <div class="header-right">
          <div class="project-switcher" id="project-switcher" style="display:none;">
            <select id="project-select" title="Активний проєкт"></select>
            <button type="button" class="btn-secondary" id="project-switch-apply" title="Перемкнути проєкт">OK</button>
            <button type="button" class="btn-secondary" id="open-project-access" title="Доступ та інвайти">Доступ</button>
          </div>
          <div class="user-info" id="user-info">Не авторизовано</div>
          <button type="button" class="btn-secondary" id="logout-btn" style="display:none;" title="Вийти з CRM">Вийти</button>
        </div>
      </header>
      <main>
        <div class="card" id="login-card">
          <h2 class="login-title">Вхід до CRM</h2>
	          <form id="login-form" autocomplete="off">
            <div class="field">
              <label for="email">Email</label>
	              <input id="email" name="email" type="email" autocomplete="off" required />
            </div>
            <div class="field">
              <label for="password">Пароль</label>
	              <input id="password" name="password" type="password" autocomplete="new-password" required />
            </div>
            <div class="login-actions">
              <button type="submit" id="login-btn">Увійти</button>
	</div>
	            <div class="muted" style="margin-top: 10px; line-height: 1.45;">
	              <div style="font-weight: 600; margin-bottom: 4px;">Демо-доступ:</div>
	              <div><b>Власник (Owner)</b>: <code>owner@example.com</code> / <code>secret123</code></div>
	              <div><b>Адміністратор (Admin)</b>: <code>user2@example.com</code> / <code>secret123</code></div>
	            </div>
            <div class="status" id="login-status"></div>
          </form>
        </div>

        
<div class="card" id="invite-card" style="margin-top: 16px; display:none;">
  <h2 class="login-title">Прийняти запрошення</h2>
  <div class="muted" id="invite-card-subtitle" style="margin-bottom: 10px;">
    Введіть email та пароль, щоб прийняти інвайт і увійти в CRM.
  </div>

  <form id="invite-card-form">
    <div class="field">
      <label for="invite-card-token">Token</label>
      <input id="invite-card-token" name="inviteToken" type="text" readonly />
    </div>
    <div class="field">
      <label for="invite-card-email">Email</label>
      <input id="invite-card-email" name="inviteEmail" type="email" autocomplete="username" />
    </div>
    <div class="field">
      <label for="invite-card-password">Пароль</label>
      <input id="invite-card-password" name="invitePassword" type="password" autocomplete="new-password" />
    </div>

    <div class="login-actions" style="gap: 8px;">
      <button type="submit" id="invite-card-accept-btn">Прийняти інвайт</button>
      <button type="button" class="btn-secondary" id="invite-card-accept-authed-btn" style="display:none;">
        Прийняти як поточний користувач
      </button>
      <button type="button" class="btn-secondary" id="invite-card-back-btn">Назад</button>
    </div>
    <div class="status" id="invite-card-status"></div>
  </form>
</div>

<div class="card" id="data-card" style="margin-top: 16px; display:none;">
          <div class="tabs-row">
            <div class="tabs">
              <button class="tab-btn active" data-tab="cases">Звернення (Cases)</button>
              <button class="tab-btn" data-tab="contacts">Контакти (Contacts)</button>
              <button class="tab-btn" data-tab="transactions">Фінанси (Transactions)</button>
              <button class="tab-btn" data-tab="integration">Integration</button>
            </div>
            <button type="button" class="btn btn-secondary" id="integration-preview-btn" disabled>Preview</button>
          </div>

          <div id="cases-view">
            <div class="muted">Показуються останні звернення по поточному проєкту користувача.</div>
            <div class="filters-row">
              <button class="btn btn-secondary btn-ghost case-filter-btn active" data-filter="all">
                Усі <span class="filter-counter" data-counter-for="all">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="new">
                New <span class="filter-counter" data-counter-for="new">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="in_progress">
                In progress <span class="filter-counter" data-counter-for="in_progress">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="done">
                Done <span class="filter-counter" data-counter-for="done">0</span>
              </button>
            </div>

            <div class="filters-row" style="margin-top: 8px;">
              <button type="button" id="open-case-status-config">
                Налаштування статусів звернень
              </button>
              <button type="button" id="open-notifications-config" style="margin-left: 8px;">
                Налаштування сповіщень
              </button>
              <button type="button" id="open-public-forms-config" style="margin-left: 8px;">
                Налаштування форм
              </button>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Статус</th>
                    <th>Заголовок</th>
                    <th>Контакт</th>
                    <th>Джерело</th>
                    <th>Створено</th>
                    <th>Нотатки</th>
                  </tr>
                </thead>
                <tbody id="cases-tbody">
                  <tr><td colspan="6" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>

          </div>

          <div id="contacts-view" style="display:none;">
            <div class="muted">Контакти, привʼязані до поточного проєкту користувача.</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Імʼя</th>
                    <th>Email</th>
                    <th>Телефон</th>
                    <th>Створено</th>
                  </tr>
                </thead>
                <tbody id="contacts-tbody">
                  <tr><td colspan="4" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>

          </div>

          <div id="transactions-view" style="display:none; padding:16px 0; min-height:260px; background:#f9fafb;">
            <h2 id="transactions-main-title" style="margin:0 0 8px 0;font-size:18px;">Фінанси по проєкту</h2>
            <div class="muted">Фінансові операції по поточному проєкту користувача.</div>

            <div id="transactions-debug" class="muted" style="margin-top:4px; color:#b91c1c; font-weight:600;"></div>

            <div class="filters-row" style="margin-top: 8px;">
              <div id="transactions-count" class="muted" style="margin-top:4px;"></div>
              <div class="filter-group">
                <label for="tx-type-filter" class="muted">Тип</label>
                <select id="tx-type-filter" class="form-control" style="min-width: 140px;">
                  <option value="">Усі</option>
                  <option value="income">Доходи</option>
                  <option value="expense">Витрати</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="tx-category-filter" class="muted">Категорія</label>
                <select id="tx-category-filter" class="form-control" style="min-width: 160px;">
                  <option value="">Усі</option>
                </select>
              </div>
            </div>

            <div class="filters-row">
              <div class="filter-group">
                <label for="tx-date-from" class="muted">Від дати</label>
                <input id="tx-date-from" class="form-control" type="date" />
              </div>
              <div class="filter-group">
                <label for="tx-date-to" class="muted">До дати</label>
                <input id="tx-date-to" class="form-control" type="date" />
              </div>
              <div class="filter-group">
                <label for="tx-min-amount" class="muted">Сума від</label>
                <input id="tx-min-amount" class="form-control" type="number" step="0.01" />
              </div>
              <div class="filter-group">
                <label for="tx-max-amount" class="muted">Сума до</label>
                <input id="tx-max-amount" class="form-control" type="number" step="0.01" />
              </div>
              <div class="filter-group" style="align-self:flex-end;">
                <button id="tx-apply-filters" class="btn btn-secondary">Застосувати</button>
              </div>
            </div>

            <div class="filters-row" style="margin-top: 8px;">
              <button type="button" id="open-transaction-categories-config">
                Налаштування категорій
              </button>
            </div>

            <div class="summary-row">
              <div class="summary-card income">
                <span class="summary-card-label">Разом доходи</span>
                <span class="summary-card-value" id="summary-income">—</span>
              </div>
              <div class="summary-card expense">
                <span class="summary-card-label">Разом витрати</span>
                <span class="summary-card-value" id="summary-expense">—</span>
              </div>
              <div class="summary-card net">
                <span class="summary-card-label">Баланс</span>
                <span class="summary-card-value" id="summary-net">—</span>
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Дата</th>
                    <th>Тип</th>
                    <th>Сума</th>
                    <th>Категорія</th>
                    <th>Опис</th>
                    <th>Контакт</th>
                    <th>Кейс</th>
                  </tr>
                </thead>
                <tbody id="transactions-tbody">
                  <tr><td colspan="7" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>

            <div id="transactions-category-summary" style="margin-top:16px;"></div>
          </div>

          <div id="integration-view" style="display:none; padding:16px 0; min-height:260px; background:#f9fafb;">
            <h2 style="margin:0 0 8px 0;font-size:18px;">Integration</h2>
            <div class="muted">Поточний проєкт: <strong id="integration-project-label">—</strong>. Нижче — ключі, приклади вставки та allowlist доменів.</div>

            <div style="margin-top:12px; display:flex; gap:12px; flex-wrap:wrap;">
              <div class="card" style="flex:1 1 320px; padding:12px;">
                <div class="muted" style="margin-bottom:6px;">Project slug</div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="integration-project-slug" class="form-control" type="text" readonly />
                  <button type="button" class="btn btn-secondary" id="copy-project-slug">Copy</button>
                </div>
                <div class="muted" style="margin-top:10px; margin-bottom:6px;">Public key (X-Project-Key)</div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <input id="integration-project-key" class="form-control" type="password" readonly />
                  <button type="button" class="btn btn-secondary" id="toggle-project-key">Show</button>
                  <button type="button" class="btn btn-secondary" id="copy-project-key">Copy</button>
                </div>
                <div class="muted" style="margin-top:8px;">Порада: ключ не зберігайте у фронтенді, якщо не потрібно. Для віджетів — потрібен.</div>
              </div>

              <div class="card" style="flex:1 1 520px; padding:12px;">
                <div class="muted" style="margin-bottom:8px;">Вставка віджетів (готові <code>&lt;script&gt;</code>)</div>
                <div class="muted" style="margin-bottom:6px;">Lead / Donation / Booking / Feedback</div>
                <textarea id="integration-snippets" class="form-control" style="width:100%; min-height:180px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></textarea>
                <div style="margin-top:8px; display:flex; gap:8px;">
                  <button type="button" class="btn btn-secondary" id="copy-snippets">Copy all</button>
                  <button type="button" class="btn btn-secondary" id="refresh-integration">Refresh</button>
                </div>
                <div class="muted" style="margin-top:8px;">За потреби додайте <code>data-api-base</code>, якщо CRM хоститься на іншому домені.</div>
              </div>
            </div>

            
            <div class="card" style="margin-top:12px; padding:12px;">
              <div class="muted" style="margin-bottom:8px;">CLI / cURL приклади (швидка перевірка без UI)</div>
              <div class="muted" style="margin-bottom:6px;">Підставте <code>ORIGIN</code> домен вашого сайту (і додайте його в allowlist вище). Далі виконайте команди у терміналі.</div>
              <textarea id="integration-curl" class="form-control" style="width:100%; min-height:220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:12px;"></textarea>
              <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                <button type="button" class="btn btn-secondary" id="copy-curl">Copy cURL</button>
                <button type="button" class="btn btn-secondary" id="download-test-html">Download test-widget.html</button>
              </div>
              <div class="muted" style="margin-top:8px;">Файл <code>test-widget.html</code> — локальна сторінка, яка підключає всі 4 віджети з поточними <code>slug</code> та <code>publicKey</code>. Відкрийте її в браузері та перевірте сабміти.</div>
            </div>

<div class="card" style="margin-top:12px; padding:12px;">
              <div class="muted" style="margin-bottom:8px;">Allowlist доменів (CORS + Origin/Referer validation для public endpoints)</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <input id="origin-input" class="form-control" type="text" placeholder="https://example.com" style="min-width:280px;" />
                <button type="button" class="btn btn-secondary" id="origin-add">Add</button>
                <div class="muted" id="origin-status" style="margin-left:4px;"></div>
              </div>
              <div class="table-wrap" style="margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>Origin</th>
                      <th>Created</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="origins-tbody">
                    <tr><td colspan="3" class="muted">Немає даних</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:8px;">Якщо список порожній — CORS для public endpointів бере legacy CORS_ORIGINS (або дозволяє все в dev). Як тільки додасте хоча б 1 домен — CRM перейде у “strict mode” для цього проєкту.</div>
            </div>

            <div class="card" style="margin-top:12px; padding:12px;">
              <div class="muted" style="margin-bottom:8px;">Учасники проєкту (Membership)</div>
              <div class="muted" style="margin-bottom:8px;">Owner може змінювати ролі та видаляти учасників. Viewer/Admin можуть лише переглядати.</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button type="button" class="btn btn-secondary" id="integration-refresh-members">Refresh members</button>
                <div class="muted" id="integration-members-status" style="margin-left:4px;"></div>
              </div>
              <div class="table-wrap" style="margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>Email</th>
                      <th>Role</th>
                      <th>Added</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="integration-members-tbody">
                    <tr><td colspan="4" class="muted">Немає даних</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="card" style="margin-top:12px; padding:12px;">
              <div class="muted" style="margin-bottom:8px;">Public forms (widgets) — керування активністю</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button type="button" class="btn btn-secondary" id="integration-seed-public-forms">Seed default forms</button>
                <button type="button" class="btn btn-secondary" id="integration-refresh-public-forms">Refresh forms</button>
                <div class="muted" id="integration-public-forms-status" style="margin-left:4px;"></div>
              </div>
              <div class="table-wrap" style="margin-top:10px;">
                <table>
                  <thead>
                    <tr>
                      <th>Key</th>
                      <th>Type</th>
                      <th>Title</th>
                      <th>Status</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="integration-public-forms-tbody">
                    <tr><td colspan="5" class="muted">Немає даних</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="muted" style="margin-top:8px;">Порада: якщо форма вимкнена — public submit поверне <code>410 Form is disabled</code>. Це нормально.</div>
            </div>
          </div>

          </div>
        </div>

        <div class="modal-backdrop" id="case-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2 id="case-modal-title">Кейс</h2>
              <button type="button" class="btn-secondary" id="case-modal-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div class="field">
                <label>Статус</label>
                <span class="pill" id="case-modal-status"></span>
              </div>
              <div class="field">
                <label>Заголовок</label>
                <div id="case-modal-main-title"></div>
              </div>
              <div class="field">
                <label>Опис (з форми)</label>
                <div class="muted" id="case-modal-description"></div>
              </div>
              <div class="field">
                <label>Контакт</label>
                <div id="case-modal-contact"></div>
              </div>
              <div class="field">
                <label>Джерело</label>
                <div id="case-modal-source"></div>
              </div>

              <div class="field">
                <label>Фінанси (транзакції по кейсу)</label>
                <div class="muted" id="case-modal-transactions-summary">—</div>
                <div style="margin-top:8px;">
                  <button type="button" class="btn-secondary" id="case-modal-add-transaction">Додати транзакцію</button>
                </div>
                <div class="table-wrap" style="margin-top:8px;">
                  <table>
                    <thead>
                      <tr>
                        <th>Дата</th>
                        <th>Тип</th>
                        <th>Сума</th>
                        <th>Категорія</th>
                        <th>Опис</th>
                      </tr>
                    </thead>
                    <tbody id="case-modal-transactions-tbody">
                      <tr><td colspan="5" class="muted">Немає транзакцій по цьому кейсу</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="muted" style="margin-top:6px;">Порада: клік по рядку відкриває редагування транзакції (категорія/опис).</div>
              </div>
              <div class="field">
                <label>Внутрішні нотатки</label>
                <textarea id="case-modal-internal-note" rows="4" placeholder="Нотатки менеджера по цьому зверненню"></textarea>
              </div>
              <div class="field">
                <label>Tasks</label>
                <form id="case-tasks-form" class="case-tasks-form">
                  <input
                    id="case-task-input"
                    type="text"
                    placeholder="Нова задача…"
                    autocomplete="off"
                  />
                  <button type="submit">Додати</button>
                </form>
                <ul id="case-tasks-list" class="case-tasks-list"></ul>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="case-modal-save">Зберегти</button>
              <button type="button" class="btn-secondary" id="case-modal-cancel">Скасувати</button>
            </div>
          </div>
        </div>

      
        
        <div class="modal-backdrop" id="transaction-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2 id="transaction-modal-title">Транзакція</h2>
              <button type="button" class="btn-secondary" id="transaction-modal-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div class="field">
                <label>Дата</label>
                <div id="transaction-modal-date"></div>
                <input id="transaction-modal-date-input" class="form-control" type="datetime-local" style="display:none;" />
              </div>
              <div class="field">
                <label>Тип</label>
                <div id="transaction-modal-type"></div>
                <select id="transaction-modal-type-select" class="form-control" style="display:none;">
                  <option value="income">Доходи</option>
                  <option value="expense">Витрати</option>
                </select>
              </div>
              <div class="field">
                <label>Сума</label>
                <div id="transaction-modal-amount"></div>
                <input id="transaction-modal-amount-input" class="form-control" type="number" step="0.01" min="0" style="display:none;" />
              </div>
              <div class="field">
                <label>Категорія</label>
                <select id="transaction-modal-category" class="form-control"></select>
              </div>
              <div class="field">
                <label>Опис</label>
                <textarea
                  id="transaction-modal-description"
                  class="form-control"
                  rows="3"
                  placeholder="Опис транзакції (необов'язково)"
                ></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="transaction-modal-save">Зберегти</button>
              <button type="button" class="btn-secondary" id="transaction-modal-cancel">Скасувати</button>
            </div>
          </div>
        </div>


<div class="modal-backdrop" id="case-status-config-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2>Налаштування статусів звернень</h2>
              <button type="button" class="btn-secondary" id="case-status-config-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div id="case-status-config-editor"></div>
            </div>
          </div>
        
                </div>

        
        <div class="modal-backdrop" id="transaction-categories-config-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2>Налаштування категорій транзакцій</h2>
              <button type="button" class="btn-secondary" id="transaction-categories-config-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div id="transaction-categories-config-editor"></div>
            </div>
          </div>
        </div>

<div class="modal-backdrop" id="notifications-config-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2>Налаштування сповіщень</h2>
              <button type="button" class="btn-secondary" id="notifications-config-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div class="config-panel">
                <label>
                  Email-адреси для сповіщень
                  <span class="muted">(через кому)</span>
                  <input type="text" id="notifications-emails-input" placeholder="you@example.com, other@example.com" />
                </label>
                <div class="config-grid">
                  <label class="badge">
                    <input type="checkbox" id="notify-on-lead" />
                    <span>Надсилати сповіщення про ліди</span>
                  </label>
                  <label class="badge">
                    <input type="checkbox" id="notify-on-donation" />
                    <span>Надсилати сповіщення про пожертвування</span>
                  </label>
                  <label class="badge">
                    <input type="checkbox" id="notify-on-booking" />
                    <span>Надсилати сповіщення про бронювання</span>
                  </label>
                  <label class="badge">
                    <input type="checkbox" id="notify-on-feedback" />
                    <span>Надсилати сповіщення про відгуки</span>
                  </label>
                </div>
                <div class="config-actions">
                  <button type="button" id="notifications-config-save">Зберегти сповіщення</button>
                                    <span id="notifications-config-status" class="status"></span>
        </div>
      </div>
    </div>
  </div>
	</div>

  <div class="modal-backdrop" id="public-forms-config-modal-backdrop" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <h2>Налаштування форм</h2>
        <button type="button" class="btn-secondary" id="public-forms-config-close">Закрити</button>
      </div>
      <div class="modal-body">
        <div class="config-panel">
          <div class="config-panel-title">Публічні форми</div>
          <div class="config-panel-subtitle">
            Керуйте назвами та активністю форм для віджетів (лід, пожертвування, бронювання, відгук).
          </div>
          <table class="config-table">
            <thead>
              <tr>
                <th>Ключ форми</th>
                <th>Заголовок</th>
                <th>Активна</th>
              </tr>
            </thead>
            <tbody id="public-forms-tbody">
              <tr>
                <td colspan="3" class="muted">Завантаження...</td>
              </tr>
            </tbody>
          </table>
          <div id="public-forms-config-status" class="status" style="margin-top: 8px;"></div>
          <div class="config-actions" style="margin-top: 12px;">
            <button type="button" class="btn-secondary" id="public-forms-config-seed" style="display:none;">Створити типові форми</button>
            <button type="button" id="public-forms-config-save">Зберегти форми</button>
          </div>
        </div>
      </div>
    </div>
  </div>

      
      <div class="modal-backdrop" id="project-access-modal-backdrop" style="display:none;">
        <div class="modal">
          <div class="modal-header">
            <h2>Доступ до проєкту та інвайти</h2>
            <button class="modal-close" id="project-access-close">&times;</button>
          </div>
          <div class="modal-body">
            <div id="project-access-project-info" class="muted" style="margin-bottom:10px;"></div>

            <div class="card" style="box-shadow:none; border:1px solid #e5e7eb; padding:12px; margin-bottom:12px;">
              <div style="font-weight:600; margin-bottom:6px;">Створити інвайт</div>
              <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap;">
                <div class="field" style="margin:0; min-width:140px;">
                  <label for="invite-role">Роль</label>
                  <select id="invite-role">
                    <option value="admin" selected>admin</option>
                    <option value="viewer">viewer</option>
                  </select>
                </div>
                <div class="field" style="margin:0; min-width:160px;">
                  <label for="invite-expires-days">Днів до завершення</label>
                  <input id="invite-expires-days" type="number" min="1" max="365" value="7"/>
                </div>
                <button type="button" class="btn" id="invite-create-btn" style="height:40px;">Створити</button>
                <div id="invites-status" class="status" style="margin:0;"></div>
              </div>
              <div id="invite-create-out" class="muted" style="margin-top:8px;"></div>
            </div>

            <div class="card" style="box-shadow:none; border:1px solid #e5e7eb; padding:12px; margin-bottom:12px;">
              <div style="font-weight:600; margin-bottom:6px;">Активні інвайти</div>
              <table class="table" style="margin-top:0;">
                <thead>
                  <tr>
                    <th>Token</th>
                    <th>Role</th>
                    <th>Expires</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody id="invites-tbody">
                  <tr><td colspan="4" class="muted">Завантаження...</td></tr>
                </tbody>
              </table>
            </div>

            <div class="card" style="box-shadow:none; border:1px solid #e5e7eb; padding:12px;">
              <div style="font-weight:600; margin-bottom:6px;">Прийняти інвайт (для іншого користувача)</div>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input id="invite-accept-token" class="mono" type="text" placeholder="встав token інвайта" style="min-width:260px; flex:1;"/>
                <button type="button" class="btn-secondary" id="invite-accept-btn">Прийняти</button>
                <div id="invite-accept-status" class="status" style="margin:0;"></div>
              </div>
              <div class="muted" style="margin-top:6px;">Після прийняття інвайта ви зможете перемкнутися на проєкт у верхньому селекторі.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn-secondary" id="project-access-cancel">Закрити</button>
          </div>
        </div>
      </div>
<script>
      (function () {
        var apiBase = window.location.origin;
        var tokenKey = 'mini-crm-admin-token';

        var DEFAULT_CASE_STATUS_CONFIG = [
          { code: 'new', label: 'New', rowBg: '#fef2f2' },
          { code: 'in_progress', label: 'In progress', rowBg: '#fffbeb' },
          { code: 'done', label: 'Done', rowBg: '#ecfdf3' },
        ];
        var DEFAULT_TRANSACTION_CATEGORY_CONFIG = [
          { code: 'donation', label: 'Пожертвування', color: '#3b82f6', type: 'income', order: 1 },
          { code: 'service', label: 'Послуга', color: '#22c55e', type: 'income', order: 2 },
          { code: 'refund', label: 'Повернення', color: '#ef4444', type: 'expense', order: 3 },
        ];

        var transactionCategories = DEFAULT_TRANSACTION_CATEGORY_CONFIG.slice();
        var transactionCategoryConfigMap = {};
        transactionCategories.forEach(function (c) {
          transactionCategoryConfigMap[c.code] = c;
        });



        var CASE_STATUSES = DEFAULT_CASE_STATUS_CONFIG.map(function (s) { return s.code; });
        var caseStatusConfigMap = {};
        DEFAULT_CASE_STATUS_CONFIG.forEach(function (s) {
          caseStatusConfigMap[s.code] = s;
        });

        var currentProjectConfig = null;

        function getCaseStatusMeta(code) {
          return caseStatusConfigMap[code] || null;
        }

        
        function applyProjectConfigFromServer(config) {
          try {
            if (!config || typeof config !== 'object') {
              return;
            }
            currentProjectConfig = config;

            // Статуси кейсів
            if (Array.isArray(config.caseStatuses) && config.caseStatuses.length) {
              var map = {};
              var codes = [];
              config.caseStatuses.forEach(function (item) {
                if (!item || !item.code) return;
                var code = String(item.code);
                var base = caseStatusConfigMap[code] || { code: code };
                map[code] = {
                  code: code,
                  label: item.label || base.label || code,
                  rowBg: item.rowBg || base.rowBg || '',
                };
                codes.push(code);
              });
              if (codes.length) {
                CASE_STATUSES = codes;
                caseStatusConfigMap = map;
                updateCaseStatusCssFromConfig();
                if (typeof updateCaseFiltersLabels === 'function') {
                  updateCaseFiltersLabels();
                }
                if (typeof renderCases === 'function') {
                  renderCases(lastCases);
                }
                if (typeof renderCaseStatusConfigEditor === 'function') {
                  renderCaseStatusConfigEditor();
                }
              }
            }

            // Категорії транзакцій
            if (Array.isArray(config.transactionCategories) && config.transactionCategories.length) {
              var txItems = config.transactionCategories.slice();
              var txMap = {};
              txItems.forEach(function (cat, index) {
                if (!cat || !cat.code) return;
                var code = String(cat.code);
                var label = cat.label || code;
                var color = cat.color || '#6b7280';
                var type = cat.type === 'expense' ? 'expense' : 'income';
                var order =
                  typeof cat.order === 'number' && !Number.isNaN(cat.order)
                    ? cat.order
                    : index + 1;
                var normalized = { code: code, label: label, color: color, type: type, order: order };
                txMap[code] = normalized;
              });

              var txArray = Object.keys(txMap)
                .map(function (code) { return txMap[code]; })
                .sort(function (a, b) {
                  return (a.order || 0) - (b.order || 0);
                });

              if (txArray.length) {
                transactionCategories = txArray;
                transactionCategoryConfigMap = {};
                txArray.forEach(function (cat) {
                  transactionCategoryConfigMap[cat.code] = cat;
                });
                if (typeof renderTransactionCategoriesConfigEditor === 'function') {
                  renderTransactionCategoriesConfigEditor();
                }
                if (typeof updateTransactionCategoryFilterOptions === 'function') {
                  updateTransactionCategoryFilterOptions();
                }
              }
            }
          } catch (e) {
            console.error('Failed to apply project config', e);
          }
        }

function updateCaseStatusCssFromConfig() {
          try {
            var root = document.documentElement;
            if (!root || !caseStatusConfigMap) return;
            Object.keys(caseStatusConfigMap).forEach(function (code) {
              var meta = caseStatusConfigMap[code];
              if (!meta || !meta.rowBg) return;
              var varName = '--case-row-bg-' + code;
              root.style.setProperty(varName, meta.rowBg);
            });
          } catch (e) {
            console.error('Failed to update case status CSS vars', e);
          }
        }


        function escapeHtml(str) {
          if (str === null || str === undefined) return '';
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        function normalizeColor(value) {
          if (!value) return '#ffffff';
          var v = String(value).trim();
          if (/^#[0-9a-fA-F]{3}$/.test(v) || /^#[0-9a-fA-F]{6}$/.test(v)) {
            return v;
          }
          return '#ffffff';
        }

        function renderCaseStatusConfigEditor() {
          var container = document.getElementById('case-status-config-editor');
          if (!container) return;

          var codes = (CASE_STATUSES || []).slice();
          if (!codes.length) {
            container.innerHTML = '<div class="config-panel"><div class="config-panel-title">Налаштування статусів</div><div class="config-panel-subtitle">Статуси ще не завантажені.</div></div>';
            return;
          }

          var html = '';
          html += '<div class="config-panel">';
          html += '<div class="config-panel-title">Налаштування статусів звернень</div>';
          html += '<div class="config-panel-subtitle">Тут можна змінити назви та кольори статусів. Коди статусів фіксовані.</div>';
          html += '<table class="config-table"><thead><tr><th>Код</th><th>Назва (label)</th><th>Колір рядка</th></tr></thead><tbody>';

          codes.forEach(function (code) {
            var meta = getCaseStatusMeta(code) || { code: code };
            var label = meta.label || code;
            var rowBg = normalizeColor(meta.rowBg || '#ffffff');
            html += '<tr data-status-code="' + code + '">';
            html += '<td>' + escapeHtml(code) + '</td>';
            html += '<td><input type="text" class="status-label-input" value="' + escapeHtml(label) + '"/></td>';
            html += '<td><input type="color" class="status-color-input" value="' + rowBg + '"/></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          html += '<div class="config-actions">';
          html += '<button type="button" class="btn btn-primary" id="save-case-status-config-btn">Зберегти статуси</button>';
          html += '<div id="case-status-config-status" class="status" style="margin-left:4px;"></div>';
          html += '</div>';
          html += '</div>';

          container.innerHTML = html;

          var saveBtn = document.getElementById('save-case-status-config-btn');
          if (saveBtn) {
            saveBtn.addEventListener('click', function () {
              saveCaseStatusConfig();
            });
          }
        }

        function saveCaseStatusConfig() {
          var container = document.getElementById('case-status-config-editor');
          if (!container) return;

          var statusEl = document.getElementById('case-status-config-status');
          function setStatus(msg, isError) {
            if (!statusEl) return;
            statusEl.textContent = msg || '';
            statusEl.style.color = isError ? '#b91c1c' : '#15803d';
          }

          var rows = container.querySelectorAll('tbody tr[data-status-code]');
          if (!rows || !rows.length) {
            setStatus('Немає рядків для збереження', true);
            return;
          }

          var items = [];
          rows.forEach(function (row) {
            var code = row.getAttribute('data-status-code');
            if (!code) return;
            var labelInput = row.querySelector('.status-label-input');
            var colorInput = row.querySelector('.status-color-input');
            var label = labelInput && labelInput.value ? labelInput.value.trim() : code;
            var color = colorInput && colorInput.value ? normalizeColor(colorInput.value) : '#ffffff';
            items.push({
              code: code,
              label: label || code,
              rowBg: color,
            });
          });

          if (!items.length) {
            setStatus('Немає валідних статусів для збереження', true);
            return;
          }

          // Локально оновлюємо конфіг перед запитом, щоб рядки одразу змінювали колір
          try {
            var map = {};
            var codes = [];
            items.forEach(function (item) {
              var base = caseStatusConfigMap[item.code] || { code: item.code };
              map[item.code] = {
                code: item.code,
                label: item.label || base.label || item.code,
                rowBg: item.rowBg || base.rowBg || '',
              };
              codes.push(item.code);
            });
            if (codes.length) {
              CASE_STATUSES = codes;
              caseStatusConfigMap = map;
              updateCaseStatusCssFromConfig();
              if (typeof updateCaseFiltersLabels === 'function') {
                updateCaseFiltersLabels();
              }
              if (typeof renderCases === 'function') {
                renderCases(lastCases);
              }
            }
          } catch (e) {
            console.error('Failed to apply local case status config', e);
          }

          setStatus('Збереження...', false);

          authedFetch('/projects/current/config', {
            method: 'PATCH',
            body: JSON.stringify({ caseStatuses: items }),
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to save config');
              }
              return res.json();
            })
            .then(function (data) {
              if (data && data.config) {
                applyProjectConfigFromServer(data.config);
              }
              setStatus('Збережено', false);
            })
            .catch(function (err) {
              console.error('Failed to save case status config', err);
              setStatus('Помилка збереження', true);
            });
        }

function updateCaseFiltersLabels() {
          var buttons = document.querySelectorAll('.case-filter-btn');
          if (!buttons || !buttons.length) return;
          buttons.forEach(function (btn) {
            var filter = btn.getAttribute('data-filter');
            if (!filter || filter === 'all') return;
            var meta = getCaseStatusMeta(filter);
            if (!meta || !meta.label) return;
            // ожидаем структуру: "Label <span class='filter-counter'>N</span>"
            var firstNode = btn.firstChild;
            if (firstNode && firstNode.nodeType === Node.TEXT_NODE) {
              firstNode.nodeValue = meta.label + ' ';
            }
          });
        }

var currentCaseFilter = 'all';
        var caseFilterButtons = Array.prototype.slice.call(document.querySelectorAll('.case-filter-btn'));
        console.log('mini-crm admin: filters found', caseFilterButtons.length);

        if (caseFilterButtons && caseFilterButtons.length) {
          caseFilterButtons.forEach(function (btn) {
            btn.addEventListener('click', function () {
              var value = btn.getAttribute('data-filter') || 'all';
              caseFilterButtons.forEach(function (b) {
                b.classList.toggle('active', b === btn);
              });
              applyCaseFilter(value);
            });
          });
        }

        function applyCaseFilter(filter) {
          if (typeof filter === 'string') {
            currentCaseFilter = filter;
          }
          renderCases(lastCases);
        }


        var loginForm = document.getElementById('login-form');
        var loginBtn = document.getElementById('login-btn');
        var logoutBtn = document.getElementById('logout-btn');
	        var loginEmailInput = document.getElementById('email');
	        var loginPasswordInput = document.getElementById('password');
        var loginStatus = document.getElementById('login-status');
        var inviteCard = document.getElementById('invite-card');
        var inviteCardSubtitle = document.getElementById('invite-card-subtitle');
        var inviteCardForm = document.getElementById('invite-card-form');
        var inviteCardTokenInput = document.getElementById('invite-card-token');
        var inviteCardEmailInput = document.getElementById('invite-card-email');
        var inviteCardPasswordInput = document.getElementById('invite-card-password');
        var inviteCardStatus = document.getElementById('invite-card-status');
        var inviteCardAcceptAuthedBtn = document.getElementById('invite-card-accept-authed-btn');
        var inviteCardBackBtn = document.getElementById('invite-card-back-btn');

        var userInfoEl = document.getElementById('user-info');
                var projectSwitcherEl = document.getElementById('project-switcher');
        var projectSelectEl = document.getElementById('project-select');
        var projectSwitchApplyBtn = document.getElementById('project-switch-apply');
        var openProjectAccessBtn = document.getElementById('open-project-access');

        var projectAccessModalBackdrop = document.getElementById('project-access-modal-backdrop');
        var projectAccessClose = document.getElementById('project-access-close');
        var projectAccessCancel = document.getElementById('project-access-cancel');
        var projectAccessProjectInfo = document.getElementById('project-access-project-info');

        var inviteRoleSelect = document.getElementById('invite-role');
        var inviteExpiresInput = document.getElementById('invite-expires-days');
        var inviteCreateBtn = document.getElementById('invite-create-btn');
        var inviteCreateOut = document.getElementById('invite-create-out');
        var invitesTbody = document.getElementById('invites-tbody');
        var invitesStatus = document.getElementById('invites-status');
        var inviteAcceptTokenInput = document.getElementById('invite-accept-token');
        var inviteAcceptBtn = document.getElementById('invite-accept-btn');
        var inviteCardStatus = document.getElementById('invite-card-status');

        var projectsList = [];
        var currentProject = null;

	        // Autofill guard: many browsers/password-managers ignore autocomplete="off" and may prefill
	        // the login form even on a fresh page load (especially in production). For a CRM admin panel,
	        // it's safer to start with empty fields when the user is not authenticated.
	        (function setupLoginAutofillGuard() {
	          if (!loginForm || !loginEmailInput || !loginPasswordInput) return;
	
	          // If user starts typing, never clear.
	          var touched = false;
	          function markTouched() { touched = true; }
	          ['input', 'change', 'keydown', 'paste'].forEach(function (evt) {
	            loginEmailInput.addEventListener(evt, markTouched);
	            loginPasswordInput.addEventListener(evt, markTouched);
	          });

	          function clearIfGuest() {
	            try {
	              if (touched) return;
	              var t = localStorage.getItem('token');
	              if (t) return;
	              loginEmailInput.value = '';
	              loginPasswordInput.value = '';
	            } catch (e) {
	              // ignore
	            }
	          }

	          // Clear immediately, and again after autofill has had a chance to run.
	          clearIfGuest();
	          setTimeout(clearIfGuest, 50);
	          setTimeout(clearIfGuest, 250);
	          setTimeout(clearIfGuest, 800);
	        })();
        
        function getTransactionCategoryMeta(code) {
          return transactionCategoryConfigMap[code] || null;
        }

        function renderTransactionCategoriesConfigEditor() {
          var container = document.getElementById('transaction-categories-config-editor');
          if (!container) return;

          var items = Array.isArray(transactionCategories)
            ? transactionCategories.slice()
            : [];

          if (!items.length) {
            container.innerHTML =
              '<div class="config-panel">' +
              '<div class="config-panel-title">Налаштування категорій транзакцій</div>' +
              '<div class="config-panel-subtitle">Категорії ще не завантажені. Спробуйте перезавантажити сторінку або зберегти нові категорії.</div>' +
              '</div>';
            return;
          }

          var html = '';
          html += '<div class="config-panel">';
          html += '<div class="config-panel-title">Налаштування категорій транзакцій</div>';
          html += '<div class="config-panel-subtitle">Тут можна змінити назви, кольори, тип та порядок відображення категорій транзакцій.</div>';
          html += '<table class="config-table"><thead><tr>';
          html += '<th>Код (code)</th>';
          html += '<th>Назва (label)</th>';
          html += '<th>Колір</th>';
          html += '<th>Тип</th>';
          html += '<th>Порядок</th>';
          html += '<th></th>';
          html += '</tr></thead><tbody>';

          items.forEach(function (cat) {
            var code = cat.code || '';
            var label = cat.label || code;
            var color = normalizeColor(cat.color || '#6b7280');
            var type = cat.type === 'expense' ? 'expense' : 'income';
            var order = typeof cat.order === 'number' ? cat.order : '';

            html += '<tr data-tx-cat-code="' + escapeHtml(code) + '">';
            html += '<td><input type="text" class="tx-cat-code-input" value="' + escapeHtml(code) + '"' + (code ? ' disabled' : '') + '/></td>';
            html += '<td><input type="text" class="tx-cat-label-input" value="' + escapeHtml(label) + '"/></td>';
            html += '<td><input type="color" class="tx-cat-color-input" value="' + color + '"/></td>';
            html += '<td>';
            html += '<select class="tx-cat-type-select">';
            html += '<option value="income"' + (type === 'income' ? ' selected' : '') + '>Доходи</option>';
            html += '<option value="expense"' + (type === 'expense' ? ' selected' : '') + '>Витрати</option>';
            html += '</select>';
            html += '</td>';
            html += '<td><input type="number" class="tx-cat-order-input" value="' + escapeHtml(String(order)) + '" /></td>';
            html += '<td><button type="button" class="btn-secondary tx-cat-delete-btn">Видалити</button></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          html += '<div class="config-actions">';
          html += '<button type="button" class="btn btn-secondary" id="add-transaction-category-btn">Додати категорію</button>';
          html += '<button type="button" class="btn btn-primary" id="save-transaction-categories-config-btn" style="margin-left:4px;">Зберегти категорії</button>';
          html += '<div id="transaction-categories-config-status" class="status" style="margin-left:4px;"></div>';
          html += '</div>';
          html += '</div>';

          container.innerHTML = html;

          var addBtn = document.getElementById('add-transaction-category-btn');
          if (addBtn) {
            addBtn.addEventListener('click', function () {
              // Додаємо новий порожній запис і перерендерюємо
              var nextIndex = Array.isArray(transactionCategories) ? transactionCategories.length + 1 : 1;
              var newCode = 'category_' + nextIndex;
              var next = Array.isArray(transactionCategories) ? transactionCategories.slice() : [];
              next.push({
                code: newCode,
                label: newCode,
                color: '#6b7280',
                type: 'income',
                order: nextIndex,
              });
              transactionCategories = next;
              renderTransactionCategoriesConfigEditor();
            });
          }

          var saveBtn = document.getElementById('save-transaction-categories-config-btn');
          if (saveBtn) {
            saveBtn.addEventListener('click', function () {
              saveTransactionCategoriesConfig();
            });
          }

          var deleteButtons = container.querySelectorAll('.tx-cat-delete-btn');
          if (deleteButtons && deleteButtons.length) {
            Array.prototype.forEach.call(deleteButtons, function (btn) {
              btn.addEventListener('click', function () {
                var row = btn.closest('tr');
                if (!row) return;
                var code = row.getAttribute('data-tx-cat-code');
                if (!code) return;
                var next = (transactionCategories || []).filter(function (cat) {
                  return cat.code !== code;
                });
                transactionCategories = next;
                renderTransactionCategoriesConfigEditor();
              });
            });
          }
        }

        function saveTransactionCategoriesConfig() {
          var container = document.getElementById('transaction-categories-config-editor');
          if (!container) return;

          var statusEl = document.getElementById('transaction-categories-config-status');
          function setStatus(msg, isError) {
            if (!statusEl) return;
            statusEl.textContent = msg || '';
            statusEl.style.color = isError ? '#b91c1c' : '#15803d';
          }

          var rows = container.querySelectorAll('tbody tr[data-tx-cat-code]');
          if (!rows || !rows.length) {
            setStatus('Додайте хоча б одну категорію', true);
            return;
          }

          var items = [];
          Array.prototype.forEach.call(rows, function (row, index) {
            var codeInput = row.querySelector('.tx-cat-code-input');
            var labelInput = row.querySelector('.tx-cat-label-input');
            var colorInput = row.querySelector('.tx-cat-color-input');
            var typeSelect = row.querySelector('.tx-cat-type-select');
            var orderInput = row.querySelector('.tx-cat-order-input');

            if (!codeInput) return;
            var code = (codeInput.value || '').trim();
            if (!code) return;

            var label = (labelInput && labelInput.value ? labelInput.value : '').trim() || code;
            var color = (colorInput && colorInput.value ? colorInput.value : '').trim() || '#6b7280';
            var type = typeSelect && typeSelect.value === 'expense' ? 'expense' : 'income';
            var orderRaw = orderInput && orderInput.value ? Number(orderInput.value) : NaN;
            var order = !Number.isNaN(orderRaw) ? orderRaw : index + 1;

            items.push({
              code: code,
              label: label,
              color: color,
              type: type,
              order: order,
            });
          });

          if (!items.length) {
            setStatus('Додайте хоча б одну категорію', true);
            return;
          }

          // Локально оновлюємо конфіг
          var map = {};
          items.forEach(function (item) {
            map[item.code] = item;
          });
          var sorted = items.slice().sort(function (a, b) {
            return (a.order || 0) - (b.order || 0);
          });
          transactionCategories = sorted;
          transactionCategoryConfigMap = {};
          sorted.forEach(function (cat) {
            transactionCategoryConfigMap[cat.code] = cat;
          });

          setStatus('Збереження...', false);

          authedFetch('/projects/current/config', {
            method: 'PATCH',
            body: JSON.stringify({ transactionCategories: sorted }),
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to save transaction categories config');
              }
              return res.json();
            })
            .then(function (data) {
              if (data && data.config) {
                applyProjectConfigFromServer(data.config);
              }
              // Обновляем фильтр и таблицу транзакций сразу после сохранения
              if (typeof updateTransactionCategoryFilterOptions === 'function') {
                updateTransactionCategoryFilterOptions();
              }
              if (Array.isArray(lastTransactions)) {
                renderTransactions(lastTransactions);
              }
              setStatus('Збережено', false);
            })
            .catch(function (err) {
              console.error('Failed to save transaction categories config', err);
              setStatus('Помилка збереження', true);
            });
        }

var dataCard = document.getElementById('data-card');
        var casesTbody = document.getElementById('cases-tbody');
        var contactsTbody = document.getElementById('contacts-tbody');
        var loginCard = document.getElementById('login-card');
        var tabs = document.querySelectorAll('.tab-btn');
        var casesView = document.getElementById('cases-view');
        var contactsView = document.getElementById('contacts-view');
        var transactionsView = document.getElementById('transactions-view');
        var integrationView = document.getElementById('integration-view');
        var transactionsTbody = document.getElementById('transactions-tbody');
        var transactionsCountEl = document.getElementById('transactions-count');
        var transactionsDebugEl = document.getElementById('transactions-debug');

        var transactionModalBackdrop = document.getElementById('transaction-modal-backdrop');
        var transactionModalTitle = document.getElementById('transaction-modal-title');
        var transactionModalDate = document.getElementById('transaction-modal-date');
        var transactionModalType = document.getElementById('transaction-modal-type');
        var transactionModalAmount = document.getElementById('transaction-modal-amount');
        var transactionModalDateInput = document.getElementById('transaction-modal-date-input');
        var transactionModalTypeSelect = document.getElementById('transaction-modal-type-select');
        var transactionModalAmountInput = document.getElementById('transaction-modal-amount-input');
        var transactionModalCategorySelect = document.getElementById('transaction-modal-category');
        var transactionModalDescription = document.getElementById('transaction-modal-description');
        var transactionModalSaveBtn = document.getElementById('transaction-modal-save');
        var transactionModalCancelBtn = document.getElementById('transaction-modal-cancel');
        var transactionModalCloseBtn = document.getElementById('transaction-modal-close');

        var txTypeFilter = document.getElementById('tx-type-filter');
        var txCategoryFilter = document.getElementById('tx-category-filter');
        var txDateFromFilter = document.getElementById('tx-date-from');
        var txDateToFilter = document.getElementById('tx-date-to');
        var txMinAmountFilter = document.getElementById('tx-min-amount');
        var txMaxAmountFilter = document.getElementById('tx-max-amount');
        var txApplyFiltersBtn = document.getElementById('tx-apply-filters');

        var summaryIncomeEl = document.getElementById('summary-income');
        var summaryExpenseEl = document.getElementById('summary-expense');
        var summaryNetEl = document.getElementById('summary-net');
        var transactionsCategorySummaryEl = document.getElementById('transactions-category-summary');

        // Integration (P2-min)
        var integrationProjectLabel = document.getElementById('integration-project-label');
        var integrationProjectSlugInput = document.getElementById('integration-project-slug');
        var integrationProjectKeyInput = document.getElementById('integration-project-key');
        var copyProjectSlugBtn = document.getElementById('copy-project-slug');
        var toggleProjectKeyBtn = document.getElementById('toggle-project-key');
        var copyProjectKeyBtn = document.getElementById('copy-project-key');
        var integrationSnippetsTextarea = document.getElementById('integration-snippets');
        var copySnippetsBtn = document.getElementById('copy-snippets');
        var refreshIntegrationBtn = document.getElementById('refresh-integration');
        var originInput = document.getElementById('origin-input');
        var originAddBtn = document.getElementById('origin-add');
        var originStatusEl = document.getElementById('origin-status');
        var originsTbody = document.getElementById('origins-tbody');

        var integrationCurlTextarea = document.getElementById('integration-curl');
        var copyCurlBtn = document.getElementById('copy-curl');
        var downloadTestHtmlBtn = document.getElementById('download-test-html');
        var integrationPreviewBtn = document.getElementById('integration-preview-btn');


        
        // Integration: public forms quick controls
        var integrationSeedPublicFormsBtn = document.getElementById('integration-seed-public-forms');
        var integrationRefreshPublicFormsBtn = document.getElementById('integration-refresh-public-forms');
        var integrationPublicFormsStatusEl = document.getElementById('integration-public-forms-status');
        var integrationPublicFormsTbody = document.getElementById('integration-public-forms-tbody');

        // Integration: members (P1.1)
        var integrationRefreshMembersBtn = document.getElementById('integration-refresh-members');
        var integrationMembersStatusEl = document.getElementById('integration-members-status');
        var integrationMembersTbody = document.getElementById('integration-members-tbody');

        var caseModalBackdrop = document.getElementById('case-modal-backdrop');
        var caseModalClose = document.getElementById('case-modal-close');
        var caseModalCancel = document.getElementById('case-modal-cancel');
        var caseModalSave = document.getElementById('case-modal-save');
        var caseModalTitle = document.getElementById('case-modal-title');
        var caseModalMainTitle = document.getElementById('case-modal-main-title');
        var caseModalStatusEl = document.getElementById('case-modal-status');
        var caseModalDescription = document.getElementById('case-modal-description');
        var caseModalContact = document.getElementById('case-modal-contact');
        var caseModalSource = document.getElementById('case-modal-source');
        var caseModalTransactionsTbody = document.getElementById('case-modal-transactions-tbody');
        var caseModalTransactionsSummary = document.getElementById('case-modal-transactions-summary');
        var caseModalAddTransactionBtn = document.getElementById('case-modal-add-transaction');
        var caseModalInternalNote = document.getElementById('case-modal-internal-note');
        var caseStatusConfigModalBackdrop = document.getElementById('case-status-config-modal-backdrop');
        var caseStatusConfigClose = document.getElementById('case-status-config-close');
        var openCaseStatusConfigBtn = document.getElementById('open-case-status-config');

        var transactionCategoriesConfigModalBackdrop = document.getElementById('transaction-categories-config-modal-backdrop');
        var transactionCategoriesConfigClose = document.getElementById('transaction-categories-config-close');
        var openTransactionCategoriesConfigBtn = document.getElementById('open-transaction-categories-config');


        var notificationsConfigModalBackdrop = document.getElementById('notifications-config-modal-backdrop');
        var notificationsConfigClose = document.getElementById('notifications-config-close');
        var notificationsConfigSave = document.getElementById('notifications-config-save');
        var notificationsEmailsInput = document.getElementById('notifications-emails-input');
        var publicFormsConfigModalBackdrop = document.getElementById('public-forms-config-modal-backdrop');
        var publicFormsConfigClose = document.getElementById('public-forms-config-close');
        var publicFormsConfigSave = document.getElementById('public-forms-config-save');
        var publicFormsConfigSeed = document.getElementById('public-forms-config-seed');
        var openPublicFormsConfigBtn = document.getElementById('open-public-forms-config');
        var publicFormsTbody = document.getElementById('public-forms-tbody');
        var publicFormsConfigStatus = document.getElementById('public-forms-config-status');
        var notifyOnLeadCheckbox = document.getElementById('notify-on-lead');
        var notifyOnDonationCheckbox = document.getElementById('notify-on-donation');
        var notifyOnBookingCheckbox = document.getElementById('notify-on-booking');
        var notifyOnFeedbackCheckbox = document.getElementById('notify-on-feedback');
        var openNotificationsConfigBtn = document.getElementById('open-notifications-config');
        var notificationsConfigStatus = document.getElementById('notifications-config-status');

        var currentCaseId = null;
        var currentCaseContactId = null;
        var currentCaseType = null;
        var currentCaseInitialInternalNote = '';
        var lastCases = [];
        var lastTransactions = [];
        var currentTransactionForModal = null;
        var currentTransactionModalMode = 'edit'; // 'edit' | 'create'
        var currentTransactionCreateContext = { caseId: null, contactId: null };
        var caseTasksForm = document.getElementById('case-tasks-form');
        var caseTaskInput = document.getElementById('case-task-input');
        var caseTasksList = document.getElementById('case-tasks-list');
        var currentCaseTasks = [];
        var currentCaseTransactions = [];

        // Current authenticated user (from /auth/me). Used by Integration helpers.
        // Mirrors backend AuthUser shape.
        var currentUser = null;



        function setStatus(message, isError) {
          loginStatus.textContent = message || '';
          loginStatus.className = 'status' + (isError ? ' error' : message ? ' ok' : '');
        }

        
        function setUserInfo(user) {
          if (!user) {
            currentUser = null;
            userInfoEl.textContent = 'Не авторизовано';
            if (projectSwitcherEl) projectSwitcherEl.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'none';
            currentProject = null;
            return;
          }

          // keep global reference for other UI sections (e.g., Membership management)
          currentUser = user;
          var projectLabel = currentProject && (currentProject.name || currentProject.slug)
            ? (currentProject.name || currentProject.slug)
            : ('#' + user.projectId);

          userInfoEl.textContent =
            user.email + ' · роль: ' + user.role + ' · проєкт: ' + projectLabel;

          if (projectSwitcherEl) {
            projectSwitcherEl.style.display = '';
          }
          if (logoutBtn) logoutBtn.style.display = '';
        }


        function getToken() {
          return window.localStorage.getItem(tokenKey);
        }

        function setToken(token) {
          if (token) {
            window.localStorage.setItem(tokenKey, token);
          } else {
            window.localStorage.removeItem(tokenKey);
          }
        }


function normalizeInviteToken(raw) {
  if (!raw) return '';
  // token can be URL-encoded and sometimes wrapped in angle brackets
  // (e.g. "<83c...>") — strip those to avoid "Invite not found".
  return String(raw)
    .trim()
    .replace(/^[<\s]+/, '')
    .replace(/[>\s]+$/, '');
}

function getInviteTokenFromUrl() {
  try {
    var sp = new URLSearchParams(window.location.search || '');
    var t = sp.get('invite') || sp.get('token') || '';
    if (t) return normalizeInviteToken(t);

    // allow hash like #invite=TOKEN or #/accept?invite=TOKEN
    var h = window.location.hash || '';
    if (!h) return '';
    var qIndex = h.indexOf('?');
    if (qIndex >= 0) {
      var qs = h.slice(qIndex + 1);
      var sp2 = new URLSearchParams(qs);
      var t2 = sp2.get('invite') || sp2.get('token') || '';
      if (t2) return normalizeInviteToken(t2);
    }
    var m = h.match(/invite=([a-zA-Z0-9]+)/);
    if (m && m[1]) return normalizeInviteToken(m[1]);
  } catch (e) {}
  return '';
}

function clearInviteFromUrl() {
  try {
    var url = new URL(window.location.href);
    url.searchParams.delete('invite');
    url.searchParams.delete('token');
    // keep hash as-is
    window.history.replaceState({}, document.title, url.toString());
  } catch (e) {}
}

function showInviteCard(token) {
  if (!inviteCard) return;
  if (loginCard) loginCard.style.display = 'none';
  if (dataCard) dataCard.style.display = 'none';
  inviteCard.style.display = '';
  var nt = normalizeInviteToken(token || '');
  if (inviteCardTokenInput) inviteCardTokenInput.value = nt || '';
  // Hide token field when token is provided via URL (primary UX path)
  try {
    var tokenField = inviteCardTokenInput && inviteCardTokenInput.parentElement;
    if (tokenField) tokenField.style.display = nt ? 'none' : '';
  } catch (e) {}

  var authed = !!getToken();
  if (inviteCardAcceptAuthedBtn) {
    inviteCardAcceptAuthedBtn.style.display = authed ? '' : 'none';
  }
  if (inviteCardSubtitle) {
    inviteCardSubtitle.textContent = authed
      ? 'Ви вже увійшли. Можна прийняти інвайт одним кліком, або ввести email+пароль і прийняти як інший користувач.'
      : 'Введіть email та пароль. Якщо користувач існує — буде виконаний вхід, якщо ні — буде створений обліковий запис.';
  }

  if (inviteCardStatus) {
    inviteCardStatus.textContent = '';
    inviteCardStatus.className = 'status';
  }

  // Focus the most relevant control
  setTimeout(function () {
    try {
      if (authed) {
        if (inviteCardAcceptAuthedBtn) inviteCardAcceptAuthedBtn.focus();
      } else {
        if (inviteCardEmailInput) inviteCardEmailInput.focus();
      }
    } catch (e) {}
  }, 0);
}

function hideInviteCard() {
  if (!inviteCard) return;
  inviteCard.style.display = 'none';
  if (loginCard) loginCard.style.display = '';
}

function setInviteStatus(message, isError) {
  if (!inviteCardStatus) return;
  inviteCardStatus.textContent = message || '';
  inviteCardStatus.className = 'status' + (isError ? ' error' : message ? ' ok' : '');
}

function acceptInvitePublic(token) {
  token = normalizeInviteToken(token);
  var email = (inviteCardEmailInput && inviteCardEmailInput.value ? inviteCardEmailInput.value : '').trim();
  var password = inviteCardPasswordInput && inviteCardPasswordInput.value ? inviteCardPasswordInput.value : '';
  if (!email || !password) {
    setInviteStatus('Вкажіть email та пароль', true);
    return Promise.resolve();
  }

  setInviteStatus('Приймаємо інвайт...', false);

  return fetch(apiBase + '/invites/accept-public', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token: token, email: email, password: password }),
  })
    .then(function (res) {
      if (!res.ok) {
        return safeJson(res).then(function (data) {
          var msg = (data && data.error) || 'Не вдалося прийняти інвайт';
          var err = new Error(msg);
          err.status = res.status;
          throw err;
        });
      }
      return res.json();
    })
    .then(function (data) {
      if (!data || !data.token || !data.user) throw new Error('Invalid server response');
      setToken(data.token);
      clearInviteFromUrl();
      // after accepting — user role + projectId in token already
      return refreshProjectHeader(data.user).then(function () {
        if (logoutBtn) logoutBtn.style.display = '';
        if (inviteCard) inviteCard.style.display = 'none';
        if (dataCard) dataCard.style.display = '';
        setStatus('Успішно. Ви увійшли.', false);
        loadProjectConfig().finally(function () {
          if (typeof updateTransactionCategoryFilterOptions === 'function') {
            updateTransactionCategoryFilterOptions();
          }
          loadData();
        });
      });
    })
    .catch(function (err) {
      console.error('Invite accept-public error', err);
      var st = err && err.status;
      if (st === 409) {
        setInviteStatus('Посилання вже використано. Увійдіть, щоб продовжити.', true);
        try {
          var le = document.getElementById('email');
          if (le && inviteCardEmailInput && inviteCardEmailInput.value) {
            le.value = (inviteCardEmailInput.value || '').trim();
          }
        } catch (e) {}
        hideInviteCard();
        setStatus('Посилання запрошення вже використано. Будь ласка, увійдіть.', true);
        return;
      }
      var msg = err && err.message ? err.message : 'Помилка прийняття інвайта';
      if (st === 401) msg = 'Невірний email або пароль';
      if (st === 404) msg = 'Посилання недійсне або не знайдено';
      if (st === 410) msg = 'Термін дії запрошення минув';
      setInviteStatus(msg, true);
    });
}

function checkInviteStatus(token) {
  token = normalizeInviteToken(token);
  if (!token) return Promise.resolve(null);
  return fetch(apiBase + '/invites/public/' + encodeURIComponent(token) + '/status', {
    method: 'GET',
    headers: { 'Accept': 'application/json' },
  })
    .then(function (res) {
      if (!res.ok) {
        var err = new Error('Invite status check failed');
        err.status = res.status;
        throw err;
      }
      return res.json();
    })
    .catch(function (err) {
      console.warn('Invite status check error', err);
      return { status: 'unknown', _errorStatus: err && err.status };
    });
}

function acceptInviteAuthed(token) {
  token = normalizeInviteToken(token);
  setInviteStatus('Приймаємо інвайт...', false);
  return authedFetch('/invites/accept', {
    method: 'POST',
    body: JSON.stringify({ token: token }),
  })
    .then(function (res) {
      if (!res.ok) {
        return safeJson(res).then(function (data) {
          var msg = (data && data.error) || 'Не вдалося прийняти інвайт';
          var err = new Error(msg);
          err.status = res.status;
          throw err;
        });
      }
      return res.json();
    })
    .then(function (data) {
      clearInviteFromUrl();
      setInviteStatus('Готово. Проєкт додано.', false);
      if (inviteCard) inviteCard.style.display = 'none';
      if (dataCard) dataCard.style.display = '';
      return loadProjectsList().then(function () {
        if (data && data.projectId) {
          return selectProject(data.projectId);
        }
      });
    })
    .catch(function (err) {
      console.error('Invite accept (authed) error', err);
      var st = err && err.status;
      var msg = err && err.message ? err.message : 'Помилка прийняття інвайта';
      if (st === 409) msg = 'Посилання вже використано або недоступне для цього користувача';
      if (st === 404) msg = 'Посилання недійсне або не знайдено';
      if (st === 410) msg = 'Термін дії запрошення минув';
      if (st === 401) msg = 'Сесія прострочена. Увійдіть знову';
      setInviteStatus(msg, true);
    });
}

        function authedFetch(path, options) {
          var token = getToken();
          if (!token) {
            return Promise.reject(new Error('No token'));
          }
          var headers = Object.assign(
            { 'Content-Type': 'application/json' },
            (options && options.headers) || {}
          );
          headers['Authorization'] = 'Bearer ' + token;
          return fetch(apiBase + path, Object.assign({}, options, { headers: headers }));
        }


        function safeJson(res) {
          return res.json().catch(function () { return null; });
        }

        function loadProjectsList() {
          return authedFetch('/projects')
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to list projects');
              return res.json();
            })
            .then(function (data) {
              projectsList = Array.isArray(data) ? data : [];
              return projectsList;
            });
        }

        function loadCurrentProject() {
          return authedFetch('/projects/current')
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to load current project');
              return res.json();
            })
            .then(function (data) {
              currentProject = data || null;
              // Preview button: enable as soon as we know the current project
              if (integrationPreviewBtn) {
                var ok = !!(currentProject && currentProject.slug && currentProject.publicKey);
                integrationPreviewBtn.disabled = !ok;
              }
              return currentProject;
            });
        }

        function renderProjectSelect(activeProjectId) {
          if (!projectSelectEl) return;
          projectSelectEl.innerHTML = '';
          if (!projectsList || !projectsList.length) {
            var opt = document.createElement('option');
            opt.value = '';
            opt.textContent = 'Немає проєктів';
            projectSelectEl.appendChild(opt);
            projectSelectEl.disabled = true;
            if (projectSwitchApplyBtn) projectSwitchApplyBtn.disabled = true;
            return;
          }

          projectSelectEl.disabled = false;
          if (projectSwitchApplyBtn) projectSwitchApplyBtn.disabled = false;

          projectsList.forEach(function (m) {
            var p = m.project || {};
            var opt = document.createElement('option');
            opt.value = String(p.id);
            var label = (p.name || p.slug || ('#' + p.id)) + ' (' + (m.role || 'member') + ')';
            opt.textContent = label;
            if (activeProjectId && Number(p.id) === Number(activeProjectId)) {
              opt.selected = true;
            }
            projectSelectEl.appendChild(opt);
          });
        }

        function refreshProjectHeader(user) {
          if (!user) return Promise.resolve();
          return Promise.all([loadCurrentProject(), loadProjectsList()])
            .then(function () {
              renderProjectSelect(user.projectId);
              setUserInfo(user);
            })
            .catch(function (err) {
              console.warn('Failed to refresh project header', err);
              renderProjectSelect(user.projectId);
              setUserInfo(user);
            });
        }

        function selectProject(projectId) {
          return authedFetch('/projects/select', {
            method: 'POST',
            body: JSON.stringify({ projectId: Number(projectId) }),
          })
            .then(function (res) {
              if (!res.ok) {
                return safeJson(res).then(function (data) {
                  throw new Error((data && data.error) || 'Не вдалося перемкнути проєкт');
                });
              }
              return res.json();
            })
            .then(function (data) {
              if (data && data.token) setToken(data.token);
              if (data && data.user) {
                // token already contains role + projectId
                return refreshProjectHeader(data.user).then(function () {
                  loadProjectConfig().finally(function () {
                    if (typeof updateTransactionCategoryFilterOptions === 'function') {
                      updateTransactionCategoryFilterOptions();
                    }
                    loadData();
                  });
                });
              }
            });
        }

        function openProjectAccessModal(user) {
          if (!projectAccessModalBackdrop) return;
          if (projectAccessModalBackdrop.style.display !== 'none') return;

          projectAccessModalBackdrop.style.display = 'flex';
          inviteCreateOut.textContent = '';
          if (invitesStatus) {
            invitesStatus.textContent = '';
            invitesStatus.className = 'status';
          }
          if (inviteCardStatus) {
            inviteCardStatus.textContent = '';
            inviteCardStatus.className = 'status';
          }

          Promise.all([loadCurrentProject(), loadInvitesList()])
            .then(function () {
              renderProjectAccessInfo(user);
            })
            .catch(function (err) {
              console.error('Failed to open project access modal', err);
              renderProjectAccessInfo(user);
            });
        }

        function closeProjectAccessModal() {
          if (!projectAccessModalBackdrop) return;
          projectAccessModalBackdrop.style.display = 'none';
        }

        function renderProjectAccessInfo(user) {
          if (!projectAccessProjectInfo) return;
          var p = currentProject || {};
          var lines = [];
          if (p.name || p.slug) lines.push('<div><b>Проєкт:</b> ' + escapeHtml(p.name || '') + ' <span class="muted">(' + escapeHtml(p.slug || '') + ')</span></div>');
          lines.push('<div><b>projectId:</b> <span class="mono">' + escapeHtml(String(p.id || (user ? user.projectId : ''))) + '</span></div>');
          if (p.publicKey) lines.push('<div><b>publicKey:</b> <span class="mono">' + escapeHtml(String(p.publicKey)) + '</span></div>');
          lines.push('<div class="muted" style="margin-top:6px;">Інвайти працюють тільки для вашого поточного проєкту. Ролі: owner/admin можуть створювати інвайти; viewer — лише приймати.</div>');
          projectAccessProjectInfo.innerHTML = lines.join('');
        }

        function setInvitesStatus(message, isError) {
          if (!invitesStatus) return;
          invitesStatus.textContent = message || '';
          invitesStatus.className = 'status' + (isError ? ' error' : message ? ' ok' : '');
        }

        function loadInvitesList() {
          if (!invitesTbody) return Promise.resolve([]);
          invitesTbody.innerHTML = '<tr><td colspan="4" class="muted">Завантаження...</td></tr>';
          return authedFetch('/invites')
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to list invites');
              return res.json();
            })
            .then(function (data) {
              var invites = Array.isArray(data) ? data : [];
              renderInvites(invites);
              return invites;
            })
            .catch(function (err) {
              console.error('Failed to load invites', err);
              invitesTbody.innerHTML = '<tr><td colspan="4" class="muted">Не вдалося завантажити</td></tr>';
              return [];
            });
        }

        function renderInvites(invites) {
          if (!invitesTbody) return;
          if (!invites || !invites.length) {
            invitesTbody.innerHTML = '<tr><td colspan="4" class="muted">Немає активних інвайтів</td></tr>';
            return;
          }
          invitesTbody.innerHTML = invites.map(function (i) {
            var token = i.token || '';
            return (
              '<tr>' +
              '<td class="mono" style="max-width:260px; overflow:hidden; text-overflow:ellipsis;">' + escapeHtml(token) + '</td>' +
              '<td>' + escapeHtml(i.role || '') + '</td>' +
              '<td>' + escapeHtml(i.expiresAt ? formatDate(i.expiresAt) : '—') + '</td>' +
              '<td>' + escapeHtml(i.createdAt ? formatDate(i.createdAt) : '—') + '</td>' +
              '</tr>'
            );
          }).join('');
        }

        function createInvite() {
          var role = inviteRoleSelect ? inviteRoleSelect.value : 'admin';
          var days = inviteExpiresInput ? Number(inviteExpiresInput.value || 7) : 7;
          if (!days || Number.isNaN(days) || days < 1) days = 7;

          setInvitesStatus('Створення інвайта...', false);

          return authedFetch('/invites', {
            method: 'POST',
            body: JSON.stringify({ role: role, expiresInDays: days }),
          })
            .then(function (res) {
              if (!res.ok) {
                return safeJson(res).then(function (data) {
                  throw new Error((data && data.error) || 'Не вдалося створити інвайт');
                });
              }
              return res.json();
            })
            .then(function (data) {
              setInvitesStatus('Інвайт створено', false);
              var token = data && data.token ? data.token : '';
              if (inviteCreateOut) {
  var path = window.location.pathname || '/admin/';
  // ensure we build URL like https://host/admin/?invite=TOKEN
  if (path.indexOf('/admin') === -1) {
    path = '/admin/';
  } else {
    path = path.replace(/index\.html$/i, '');
  }
  if (path[path.length - 1] !== '/') path += '/';
  var inviteUrl = window.location.origin + path + '?invite=' + encodeURIComponent(token);

  inviteCreateOut.innerHTML =
    '<div>Token: <span class="mono">' + escapeHtml(token) + '</span></div>' +
    '<div style="margin-top:6px;">Посилання для запрошення: <a href="' + escapeHtml(inviteUrl) + '" target="_blank" rel="noopener">' +
      escapeHtml(inviteUrl) + '</a></div>' +
    '<div style="margin-top:6px;"><button type="button" class="btn-secondary" id="copy-invite-link-btn">Скопіювати посилання</button></div>' +
    '<div class="muted" style="margin-top:6px;">Користувач відкриває посилання, вводить email+пароль, і система автоматично приймає інвайт.</div>';

  var copyBtn = document.getElementById('copy-invite-link-btn');
  if (copyBtn) {
    copyBtn.onclick = function () {
      safeCopy(inviteUrl);
      setInvitesStatus('Посилання скопійовано', false);
    };
  }
}
              return loadInvitesList();
            })
            .catch(function (err) {
              console.error('Invite create error', err);
              setInvitesStatus(err.message || 'Помилка створення інвайта', true);
            });
        }

        function acceptInvite() {
          var token = (inviteAcceptTokenInput && inviteAcceptTokenInput.value ? inviteAcceptTokenInput.value : '').trim();
          if (!token) {
            if (inviteCardStatus) {
              inviteCardStatus.textContent = 'Вкажіть token';
              inviteCardStatus.className = 'status error';
            }
            return Promise.resolve();
          }
          if (inviteCardStatus) {
            inviteCardStatus.textContent = 'Приймаємо...';
            inviteCardStatus.className = 'status';
          }

          return authedFetch('/invites/accept', {
            method: 'POST',
            body: JSON.stringify({ token: token }),
          })
            .then(function (res) {
              if (!res.ok) {
        return safeJson(res).then(function (data) {
          var msg = (data && data.error) || 'Не вдалося прийняти інвайт';
          var err = new Error(msg);
          err.status = res.status;
          throw err;
        });
      }
              return res.json();
            })
            .then(function (data) {
              if (inviteCardStatus) {
                inviteCardStatus.textContent = 'Готово. Проєкт додано.';
                inviteCardStatus.className = 'status ok';
              }
              if (inviteAcceptTokenInput) inviteAcceptTokenInput.value = '';
              return loadProjectsList().then(function () {
                // optional: auto-switch to invited project
                if (data && data.projectId) {
                  return selectProject(data.projectId);
                }
                return Promise.resolve();
              });
            })
            .catch(function (err) {
              console.error('Invite accept error', err);
              if (inviteCardStatus) {
                inviteCardStatus.textContent = err.message || 'Помилка прийняття інвайта';
                inviteCardStatus.className = 'status error';
              }
            });
        }

        function formatDate(iso) {
          if (!iso) return '';
          try {
            var d = new Date(iso);
            if (Number.isNaN(d.getTime())) return iso;
            return d.toLocaleString();
          } catch (e) {
            return iso;
          }
        }


        
        function formatCurrency(amount, currency) {
          if (amount == null || Number.isNaN(Number(amount))) return '';
          var value = Number(amount);
          var cur = currency || '';
          var formatted = value.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
          return cur ? (formatted + ' ' + cur) : formatted;
        }

function formatContactForModal(contact) {
          if (!contact) return '<span class="muted">нема даних</span>';
          var parts = [];
          if (contact.name) parts.push(contact.name);
          if (contact.email) parts.push(contact.email);
          if (contact.phone) parts.push(contact.phone);
          if (parts.length === 0) return '<span class="muted">нема даних</span>';
          return parts.join(' · ');
        }

        function renderCases(cases) {
          lastCases = Array.isArray(cases) ? cases : [];
          var list = lastCases;

          // лічильники по статусам
          var counts = { all: lastCases.length };
          CASE_STATUSES.forEach(function (code) {
            counts[code] = 0;
          });
          lastCases.forEach(function (c) {
            var st = c.status || 'new';
            if (typeof counts[st] === 'undefined') {
              counts[st] = 0;
            }
            counts[st]++;
          });

          if (caseFilterButtons && caseFilterButtons.length) {
            caseFilterButtons.forEach(function (btn) {
              var f = btn.getAttribute('data-filter') || 'all';
              var span = btn.querySelector('.filter-counter[data-counter-for="' + f + '"]');
              if (span) {
                var value = f === 'all' ? counts.all : (counts[f] || 0);
                span.textContent = value;
              }
            });
          }

          if (currentCaseFilter && currentCaseFilter !== 'all') {
            list = list.filter(function (c) {
              var status = c.status || 'new';
              return status === currentCaseFilter;
            });
          }

          if (!Array.isArray(list) || list.length === 0) {
            casesTbody.innerHTML = '<tr><td colspan="6" class="muted">Немає даних</td></tr>';
            return;
          }

          var rows = list
            .map(function (c) {
              var contact = c.contact || {};
              var contactStr =
                [contact.name, contact.email, contact.phone].filter(Boolean).join(' · ') ||
                '<span class="muted">нема даних</span>';
              var status = c.status || 'new';
              var source = c.source || '–';

              var statuses = CASE_STATUSES.slice();
              if (status && statuses.indexOf(status) === -1) {
                statuses.push(status);
              }

              var selectHtml =
                '<select class="status-select" data-case-id="' +
                c.id +
                '">' +
                statuses
                  .map(function (s) {
                    var selected = s === status ? ' selected' : '';
                    var metaForOption = getCaseStatusMeta(s);
                    var label = metaForOption && metaForOption.label ? metaForOption.label : s;
                    return '<option value="' + s + '"' + selected + '>' + label + '</option>';
                  })
                  .join('') +
                '</select>';

              var notePreview = c.internalNote ? 'є' : '—';
              var rowClass = 'status-row-' + status;
              var meta = getCaseStatusMeta(status);
              var rowStyle = meta && meta.rowBg ? ' style="background:' + meta.rowBg + ';"' : '';

              return (
                '<tr class="case-row ' +
                rowClass +
                '" data-case-id="' +
                c.id +
                '"' +
                rowStyle +
                '>' +
                '<td>' + selectHtml + '</td>' +
                '<td>' +
                (c.title || '') +
                (c.description ? '<div class="muted">' + c.description + '</div>' : '') +
                '</td>' +
                '<td>' + contactStr + '</td>' +
                '<td><span class="pill">' + source + '</span></td>' +
                '<td>' + formatDate(c.createdAt) + '</td>' +
                '<td>' + notePreview + '</td>' +
                '</tr>'
              );
            })
            .join('');

          casesTbody.innerHTML = rows;

          var selects = casesTbody.querySelectorAll('.status-select');
          var rowsEls = casesTbody.querySelectorAll('tr.case-row');
          rowsEls.forEach(function (row) {
            row.addEventListener('click', function (e) {
              if (e.target && e.target.closest && e.target.closest('.status-select')) {
                return;
              }
              var idAttr = row.getAttribute('data-case-id');
              if (!idAttr) return;
              var id = Number(idAttr);
              if (!Number.isFinite(id)) return;
              openCaseModal(id);
            });
          });

          selects.forEach(function (select) {
            select.addEventListener('change', function () {
              var idAttr = select.getAttribute('data-case-id');
              if (!idAttr) return;
              var id = Number(idAttr);
              var newStatus = select.value;
              if (!Number.isFinite(id) || !newStatus) return;

              setStatus('Оновлення статусу кейсу...', false);
              authedFetch('/cases/' + id, {
                method: 'PATCH',
                body: JSON.stringify({ status: newStatus }),
              })
                .then(function (res) {
                  if (!res.ok) {
                    return res
                      .json()
                      .catch(function () { return { error: 'Failed to update case' }; })
                      .then(function (data) {
                        throw new Error(data.error || 'Failed to update case');
                      });
                  }
                  return res.json();
                })
                .then(function (updated) {
                  if (!Array.isArray(lastCases)) return;
                  lastCases = lastCases.map(function (c) {
                    return c.id === updated.id ? updated : c;
                  });
                  renderCases(lastCases);
                  setStatus('Статус кейсу оновлено', false);
                })
                .catch(function (err) {
                  console.error('Failed to update case', err);
                  setStatus(err.message || 'Не вдалося оновити кейс', true);
                });
            });
          });
        }

function renderContacts(contacts) {
          if (!Array.isArray(contacts) || contacts.length === 0) {
            contactsTbody.innerHTML = '<tr><td colspan="4" class="muted">Немає даних</td></tr>';
            return;
          }
          var rows = contacts
            .map(function (c) {
              return (
                '<tr>' +
                '<td>' + (c.name || '<span class="muted">Без імені</span>') + '</td>' +
                '<td>' + (c.email || '<span class="muted">–</span>') + '</td>' +
                '<td>' + (c.phone || '<span class="muted">–</span>') + '</td>' +
                '<td>' + formatDate(c.createdAt) + '</td>' +
                '</tr>'
              );
            })
            .join('');
          contactsTbody.innerHTML = rows;
        }

        
        
        function renderTransactionCategoryBadge(code) {
          if (!code) return '';
          var meta = getTransactionCategoryMeta(code) || null;
          var label = (meta && meta.label) || code;
          var color = (meta && meta.color) || '#6b7280';
          var textColor = '#ffffff';

          return (
            '<span class="tx-category-badge tx-category-badge-' + escapeHtml(code) + '" ' +
            'style="display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:12px;' +
            'background-color:' + color + ';color:' + textColor + ';white-space:nowrap;">' +
            '<span class="tx-category-dot" style="width:6px;height:6px;border-radius:999px;background-color:rgba(255,255,255,0.8);margin-right:6px;"></span>' +
            escapeHtml(label) +
            '</span>'
          );
        }

        function buildTransactionsCategorySummary(transactions) {
          var summary = {
            byCategory: {},
            totals: {
              income: 0,
              expense: 0,
            },
          };
          if (!Array.isArray(transactions) || !transactions.length) {
            return summary;
          }

          transactions.forEach(function (t) {
            if (!t) return;
            var code = t.category || 'uncategorized';
            var meta = getTransactionCategoryMeta(t.category);
            var label = (meta && meta.label) || code;
            var color = (meta && meta.color) || '#6b7280';
            var typeFromCategory = meta && meta.type === 'expense'
              ? 'expense'
              : meta && meta.type === 'income'
              ? 'income'
              : null;
            var type = (t.type === 'income' || t.type === 'expense') ? t.type : (typeFromCategory || 'income');
            var amount = Number(t.amount || 0);
            if (!summary.byCategory[code]) {
              summary.byCategory[code] = {
                code: code,
                label: label,
                color: color,
                income: 0,
                expense: 0,
              };
            }
            if (type === 'income') {
              summary.byCategory[code].income += amount;
              summary.totals.income += amount;
            } else {
              summary.byCategory[code].expense += amount;
              summary.totals.expense += amount;
            }
          });

          return summary;
        }


        
        function updateTransactionCategoryFilterOptions() {
          if (!txCategoryFilter || !txCategoryFilter.tagName) return;
          var select = txCategoryFilter;
          if (String(select.tagName).toLowerCase() !== 'select') return;

          var currentValue = select.value || '';

          while (select.firstChild) {
            select.removeChild(select.firstChild);
          }

          var optAll = document.createElement('option');
          optAll.value = '';
          optAll.textContent = 'Усі';
          select.appendChild(optAll);

          if (Array.isArray(transactionCategories) && transactionCategories.length) {
            transactionCategories.forEach(function (cat) {
              if (!cat || !cat.code) return;
              var opt = document.createElement('option');
              opt.value = cat.code;
              opt.textContent = cat.label || cat.code;
              if (cat.code === currentValue) {
                opt.selected = true;
              }
              select.appendChild(opt);
            });
          }
        }

function renderTransactions(transactions) {
          console.log('renderTransactions called, items:', Array.isArray(transactions) ? transactions.length : 'not array');
          lastTransactions = Array.isArray(transactions) ? transactions : [];
          var categorySummary = buildTransactionsCategorySummary(lastTransactions);
          if (typeof renderTransactionsCategorySummary === 'function') {
            renderTransactionsCategorySummary(categorySummary);
          }
          if (typeof renderTransactionsSummary === 'function') {
            try {
              var totals = categorySummary && categorySummary.totals ? categorySummary.totals : { income: 0, expense: 0 };
              renderTransactionsSummary({
                totalIncome: Number(totals.income || 0),
                totalExpense: Number(totals.expense || 0),
                net: Number(totals.income || 0) - Number(totals.expense || 0),
              });
            } catch (e) {
              console.error('Failed to render overall transactions summary from categories', e);
            }
          }
          if (transactionsDebugEl) {
            try {
              var cats = Object.keys(categorySummary.byCategory || {});
              if (!cats.length) {
                transactionsDebugEl.textContent = 'DEBUG: ' + lastTransactions.length + ' транзакцій, категорії не задані';
              } else {
                var parts = cats.map(function (code) {
                  var c = categorySummary.byCategory[code];
                  return c.label + ': +' + c.income.toFixed(2) + ' / -' + c.expense.toFixed(2);
                });
                transactionsDebugEl.textContent =
                  'DEBUG: ' + lastTransactions.length + ' транзакцій; категорії → ' + parts.join(' | ');
              }
            } catch (e) {
              console.error('Failed to render transactions category debug', e);
              transactionsDebugEl.textContent = 'DEBUG: ' + lastTransactions.length + ' транзакцій';
            }
          }

          if (!transactionsTbody) return;

                    if (transactionsCountEl) { transactionsCountEl.textContent = 'Всього ' + lastTransactions.length + ' транзакцій'; }

          if (!Array.isArray(lastTransactions) || lastTransactions.length === 0) {
            if (transactionsCountEl) { transactionsCountEl.textContent = 'Немає транзакцій'; }
            transactionsTbody.innerHTML = '<tr><td colspan="7" class="muted">Немає даних</td></tr>';
            return;
          }

          var rows = lastTransactions
            .map(function (t) {
              var meta = getTransactionCategoryMeta(t.category);
              var typeFromCategory = meta && meta.type === 'expense'
                ? 'expense'
                : meta && meta.type === 'income'
                ? 'income'
                : null;
              var type = (t.type === 'income' || t.type === 'expense') ? t.type : (typeFromCategory || '');
              var rowClass = '';
              if (type === 'income') rowClass = 'transaction-row-income';
              else if (type === 'expense') rowClass = 'transaction-row-expense';

              var amountStr = formatCurrency(t.amount, t.currency);
              var typeLabel = type === 'income' ? 'Доходи' : (type === 'expense' ? 'Витрати' : type || '—');
              var category = t.category || '';
              var categoryBadgeHtml = category ? renderTransactionCategoryBadge(category) : '<span class="muted">—</span>';
              var description = t.description || '';
              var dateValue = t.happenedAt || t.createdAt;

              var contactStr = '<span class="muted">—</span>';
              if (t.contact) {
                var parts = [];
                if (t.contact.name) parts.push(t.contact.name);
                if (t.contact.email) parts.push('(' + t.contact.email + ')');
                contactStr = parts.join(' ') || '<span class="muted">—</span>';
              }

              var caseStr = '<span class="muted">—</span>';
              if (t.case) {
                var base = '#' + t.case.id;
                if (t.case.title) base += ': ' + t.case.title;
                caseStr = base;
              }

              return (
                '<tr class="transaction-row ' + rowClass + '" data-transaction-id="' + (t.id != null ? t.id : '') + '">' +
                '<td>' + formatDate(dateValue) + '</td>' +
                '<td>' + typeLabel + '</td>' +
                '<td>' + amountStr + '</td>' +
                '<td>' + categoryBadgeHtml + '</td>' +
                '<td>' + (description || '<span class="muted">—</span>') + '</td>' +
                '<td>' + contactStr + '</td>' +
                '<td>' + caseStr + '</td>' +
                '</tr>'
              );
            })
            .join('');

          transactionsTbody.innerHTML = rows;
        }

        
        function renderTransactionsCategorySummary(categorySummary) {
          if (!transactionsCategorySummaryEl) return;

          try {
            var container = transactionsCategorySummaryEl;
            var summary = categorySummary || { byCategory: {}, totals: { income: 0, expense: 0 } };
            var byCategory = summary.byCategory || {};
            var keys = Object.keys(byCategory);

            if (!keys.length) {
              container.innerHTML =
                '<div class="config-panel">' +
                '<div class="config-panel-title">Суми по категоріях за період</div>' +
                '<div class="config-panel-subtitle">Немає даних для обраного періоду.</div>' +
                '</div>';
              return;
            }

            var totalIncome = Number(summary.totals && summary.totals.income || 0);
            var totalExpense = Number(summary.totals && summary.totals.expense || 0);
            var net = totalIncome - totalExpense;

            var rowsHtml = keys
              .map(function (code) {
                var c = byCategory[code];
                var incomeStr = formatCurrency(c.income, 'UAH');
                var expenseStr = formatCurrency(c.expense, 'UAH');
                var netVal = (Number(c.income || 0) - Number(c.expense || 0));
                var netStr = formatCurrency(netVal, 'UAH');
                var badgeHtml = renderTransactionCategoryBadge(code);

                return (
                  '<tr>' +
                  '<td>' + badgeHtml + '</td>' +
                  '<td style="text-align:right;">' + incomeStr + '</td>' +
                  '<td style="text-align:right;">' + expenseStr + '</td>' +
                  '<td style="text-align:right;">' + netStr + '</td>' +
                  '</tr>'
                );
              })
              .join('');

            var totalIncomeStr = formatCurrency(totalIncome, 'UAH');
            var totalExpenseStr = formatCurrency(totalExpense, 'UAH');
            var netStrTotal = formatCurrency(net, 'UAH');

            var html = '';
            html += '<div class="config-panel">';
            html += '<div class="config-panel-title">Суми по категоріях за період</div>';
            html += '<div class="config-panel-subtitle">Враховуються всі транзакції, що відповідають поточним фільтрам.</div>';
            html += '<table class="config-table"><thead><tr>';
            html += '<th>Категорія</th>';
            html += '<th style="text-align:right;">Доходи</th>';
            html += '<th style="text-align:right;">Витрати</th>';
            html += '<th style="text-align:right;">Нетто</th>';
            html += '</tr></thead><tbody>';
            html += rowsHtml;
            html += '</tbody></table>';
            html += '<div class="config-panel-footer" style="margin-top:8px;">';
            html += '<div>Всього доходів: <strong>' + totalIncomeStr + '</strong></div>';
            html += '<div>Всього витрат: <strong>' + totalExpenseStr + '</strong></div>';
            html += '<div>Баланс: <strong>' + netStrTotal + '</strong></div>';
            html += '</div>';
            html += '</div>';

            container.innerHTML = html;
          } catch (e) {
            console.error('Failed to render transactions category summary', e);
          }
        }


        function setTransactionModalMode(mode) {
          currentTransactionModalMode = mode === 'create' ? 'create' : 'edit';

          var isCreate = currentTransactionModalMode === 'create';

          // toggle readonly display blocks vs inputs
          if (transactionModalDate) transactionModalDate.style.display = isCreate ? 'none' : '';
          if (transactionModalType) transactionModalType.style.display = isCreate ? 'none' : '';
          if (transactionModalAmount) transactionModalAmount.style.display = isCreate ? 'none' : '';

          if (transactionModalDateInput) transactionModalDateInput.style.display = isCreate ? '' : 'none';
          if (transactionModalTypeSelect) transactionModalTypeSelect.style.display = isCreate ? '' : 'none';
          if (transactionModalAmountInput) transactionModalAmountInput.style.display = isCreate ? '' : 'none';

          if (transactionModalSaveBtn) {
            transactionModalSaveBtn.textContent = isCreate ? 'Створити' : 'Зберегти';
          }
        }

        function openCreateTransactionModal(ctx) {
          if (!transactionModalBackdrop) return;

          currentTransactionForModal = null;
          currentTransactionCreateContext = {
            caseId: (ctx && ctx.caseId != null) ? Number(ctx.caseId) : null,
            contactId: (ctx && ctx.contactId != null) ? Number(ctx.contactId) : null,
          };

          setTransactionModalMode('create');

          try {
            if (transactionModalTitle) {
              transactionModalTitle.textContent = 'Нова транзакція';
            }

            // Defaults
            var now = new Date();
            if (transactionModalDateInput) {
              // datetime-local expects "YYYY-MM-DDTHH:mm"
              var pad = function (n) { return String(n).padStart(2, '0'); };
              var localStr =
                now.getFullYear() + '-' +
                pad(now.getMonth() + 1) + '-' +
                pad(now.getDate()) + 'T' +
                pad(now.getHours()) + ':' +
                pad(now.getMinutes());
              transactionModalDateInput.value = localStr;
            }

            if (transactionModalTypeSelect) {
              var suggested = (ctx && ctx.suggestedType) ? String(ctx.suggestedType) : 'income';
              transactionModalTypeSelect.value = (suggested === 'expense') ? 'expense' : 'income';
            }

            if (transactionModalAmountInput) {
              transactionModalAmountInput.value = '';
              transactionModalAmountInput.focus();
            }

            if (transactionModalDescription) {
              transactionModalDescription.value = '';
            }

            // Populate categories
            if (transactionModalCategorySelect) {
              while (transactionModalCategorySelect.firstChild) {
                transactionModalCategorySelect.removeChild(transactionModalCategorySelect.firstChild);
              }

              var categories = Array.isArray(transactionCategories) ? transactionCategories.slice() : [];
              if (categories.length) {
                categories.sort(function (a, b) {
                  var ao = (typeof a.order === 'number') ? a.order : 0;
                  var bo = (typeof b.order === 'number') ? b.order : 0;
                  return ao - bo;
                });
              }

              var placeholderOption = document.createElement('option');
              placeholderOption.value = '';
              placeholderOption.textContent = 'Оберіть категорію';
              transactionModalCategorySelect.appendChild(placeholderOption);

              if (categories.length) {
                categories.forEach(function (cat) {
                  if (!cat || !cat.code) return;
                  var opt = document.createElement('option');
                  opt.value = cat.code;
                  opt.textContent = cat.label || cat.code;
                  transactionModalCategorySelect.appendChild(opt);
                });
              }
              transactionModalCategorySelect.value = '';
            }
          } catch (e) {
            console.error('Failed to open create transaction modal', e);
          }

          transactionModalBackdrop.style.display = 'flex';
        }

        function openTransactionModal(tx) {
          if (!transactionModalBackdrop) return;
          currentTransactionForModal = tx;
          currentTransactionCreateContext = { caseId: null, contactId: null };
          setTransactionModalMode('edit');

          try {
            if (transactionModalTitle) {
              transactionModalTitle.textContent = 'Транзакція #' + (tx.id != null ? tx.id : '');
            }
            if (transactionModalDate) {
              var dateValue = tx.happenedAt || tx.createdAt;
              transactionModalDate.textContent = dateValue ? formatDate(dateValue) : '';
            }
            if (transactionModalType) {
              var type = tx.type || '';
              var typeLabel = type === 'income' ? 'Доходи' : (type === 'expense' ? 'Витрати' : type || '—');
              transactionModalType.textContent = typeLabel;
            }
            if (transactionModalAmount) {
              transactionModalAmount.textContent = formatCurrency(tx.amount, tx.currency);
            }
            if (transactionModalDescription) {
              transactionModalDescription.value = tx.description || '';
            }

            if (transactionModalCategorySelect) {
              while (transactionModalCategorySelect.firstChild) {
                transactionModalCategorySelect.removeChild(transactionModalCategorySelect.firstChild);
              }

              var currentCode = tx.category || '';
              var categories = Array.isArray(transactionCategories) ? transactionCategories.slice() : [];
              if (categories.length) {
                categories.sort(function (a, b) {
                  var ao = (typeof a.order === 'number') ? a.order : 0;
                  var bo = (typeof b.order === 'number') ? b.order : 0;
                  return ao - bo;
                });
              }

              var placeholderOption = document.createElement('option');
              placeholderOption.value = '';
              placeholderOption.textContent = 'Оберіть категорію';
              transactionModalCategorySelect.appendChild(placeholderOption);

              if (categories.length) {
                categories.forEach(function (cat) {
                  if (!cat || !cat.code) return;
                  var opt = document.createElement('option');
                  opt.value = cat.code;
                  opt.textContent = cat.label || cat.code;
                  if (cat.code === currentCode) {
                    opt.selected = true;
                  }
                  transactionModalCategorySelect.appendChild(opt);
                });
              }

              if (!currentCode && categories.length) {
                transactionModalCategorySelect.value = '';
              }
            }
          } catch (e) {
            console.error('Failed to open transaction modal', e);
          }

          transactionModalBackdrop.style.display = 'flex';
        }

        function closeTransactionModal() {
          if (transactionModalBackdrop) {
            transactionModalBackdrop.style.display = 'none';
          }
          currentTransactionForModal = null;
          currentTransactionCreateContext = { caseId: null, contactId: null };
          setTransactionModalMode('edit');
        }

        function createTransactionFromModal() {
          try {
            var type = transactionModalTypeSelect ? transactionModalTypeSelect.value : 'income';
            if (type !== 'income' && type !== 'expense') type = 'income';

            var amountStr = transactionModalAmountInput ? String(transactionModalAmountInput.value || '').trim() : '';
            var amount = Number(amountStr);
            if (!amountStr || Number.isNaN(amount) || amount <= 0) {
              alert('Вкажіть коректну суму (> 0).');
              return;
            }

            var happenedAtIso = undefined;
            if (transactionModalDateInput && transactionModalDateInput.value) {
              var d = new Date(transactionModalDateInput.value);
              if (!Number.isNaN(d.getTime())) {
                happenedAtIso = d.toISOString();
              }
            }

            var payload = {
              type: type,
              amount: amount,
              currency: 'UAH',
            };

            if (transactionModalCategorySelect && transactionModalCategorySelect.value) {
              payload.category = transactionModalCategorySelect.value;
            }
            if (transactionModalDescription && transactionModalDescription.value) {
              var desc = String(transactionModalDescription.value || '').trim();
              if (desc) payload.description = desc;
            }
            if (currentTransactionCreateContext && currentTransactionCreateContext.contactId != null) {
              payload.contactId = currentTransactionCreateContext.contactId;
            }
            if (currentTransactionCreateContext && currentTransactionCreateContext.caseId != null) {
              payload.caseId = currentTransactionCreateContext.caseId;
            }
            if (happenedAtIso) {
              payload.happenedAt = happenedAtIso;
            }

            authedFetch('/transactions', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            })
              .then(function (res) {
                if (!res.ok) {
                  return res.json().catch(function () { return { error: 'Failed to create transaction' }; })
                    .then(function (data) { throw new Error(data.error || 'Failed to create transaction'); });
                }
                return res.json();
              })
              .then(function (created) {
                // Refresh project transactions view (with current filters) and case transactions
                if (typeof reloadTransactionsWithFilters === 'function') {
                  reloadTransactionsWithFilters();
                }
                if (currentCaseId && currentTransactionCreateContext && Number(currentTransactionCreateContext.caseId) === Number(currentCaseId)) {
                  loadCaseTransactions(currentCaseId);
                }
                closeTransactionModal();
              })
              .catch(function (err) {
                console.error('Failed to create transaction', err);
                alert('Не вдалося створити транзакцію: ' + (err && err.message ? err.message : String(err)));
              });
          } catch (e) {
            console.error('createTransactionFromModal failed', e);
            alert('Не вдалося створити транзакцію.');
          }
        }

        function saveCurrentTransactionChanges() {
          if (!currentTransactionForModal) return;

          var payload = {};
          var tx = currentTransactionForModal;

          if (transactionModalCategorySelect && transactionModalCategorySelect.value) {
            if (tx.category !== transactionModalCategorySelect.value) {
              payload.category = transactionModalCategorySelect.value;
            }
          }

          if (transactionModalDescription) {
            var newDesc = transactionModalDescription.value || '';
            if ((tx.description || '') !== newDesc) {
              payload.description = newDesc;
            }
          }

          var hasAny =
            payload.category !== undefined ||
            payload.description !== undefined;

          if (!hasAny) {
            closeTransactionModal();
            return;
          }

          authedFetch('/transactions/' + tx.id, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          })
            .then(function (res) {
              if (!res.ok) {
                return res.json().catch(function () { return { error: 'Failed to update transaction' }; })
                  .then(function (data) { throw new Error(data.error || 'Failed to update transaction'); });
              }
              return res.json();
            })
            .then(function (updated) {
              if (Array.isArray(lastTransactions)) {
                for (var i = 0; i < lastTransactions.length; i++) {
                  if (Number(lastTransactions[i].id) === Number(updated.id)) {
                    lastTransactions[i] = updated;
                    break;
                  }
                }
              }
              renderTransactions(lastTransactions);
              if (currentCaseId && updated && updated.caseId != null && Number(updated.caseId) === Number(currentCaseId)) {
                loadCaseTransactions(currentCaseId);
              }
              closeTransactionModal();
            })
            .catch(function (err) {
              console.error('Failed to save transaction changes', err);
              alert('Не вдалося зберегти зміни транзакції: ' + (err && err.message ? err.message : String(err)));
            });
        }

function renderTransactionsSummary(summary) {
          if (!summary) {
            if (summaryIncomeEl) summaryIncomeEl.textContent = '—';
            if (summaryExpenseEl) summaryExpenseEl.textContent = '—';
            if (summaryNetEl) summaryNetEl.textContent = '—';
            return;
          }

          var totalIncome = Number(summary.totalIncome || 0);
          var totalExpense = Number(summary.totalExpense || 0);
          var net = Number(summary.net || 0);

          if (summaryIncomeEl) summaryIncomeEl.textContent = formatCurrency(totalIncome);
          if (summaryExpenseEl) summaryExpenseEl.textContent = formatCurrency(totalExpense);
          if (summaryNetEl) summaryNetEl.textContent = formatCurrency(net);
        }

        function loadProjectConfig() {
          return authedFetch('/projects/current')
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to load project');
              }
              return res.json();
            })
            .then(function (data) {
              if (data && data.config) {
                applyProjectConfigFromServer(data.config);
              }
            })
            .catch(function (err) {
              console.error('Failed to load project config', err);
            });
        }

function loadData() {
          Promise.all([
            authedFetch('/cases').then(function (res) {
              if (!res.ok) throw new Error('Failed to load cases');
              return res.json();
            }),
            authedFetch('/contacts').then(function (res) {
              if (!res.ok) throw new Error('Failed to load contacts');
              return res.json();
            }),
            authedFetch('/transactions').then(function (res) {
              if (!res.ok) throw new Error('Failed to load transactions');
              return res.json();
            }),
            authedFetch('/transactions/summary').then(function (res) {
              if (!res.ok) throw new Error('Failed to load transaction summary');
              return res.json();
            }),
          ])
            .then(function (results) {
              renderCases(results[0]);
              renderContacts(results[1]);
              renderTransactions(results[2]);
            })
            .catch(function (err) {
              console.error('Failed to load data', err);
              setStatus('Не вдалося завантажити дані. Перевірте токен / права доступу.', true);
            });
        }

        
        function buildTransactionsQueryFromFilters() {
          var params = [];

          if (txTypeFilter && txTypeFilter.value) {
            params.push('type=' + encodeURIComponent(txTypeFilter.value));
          }
          if (txCategoryFilter && txCategoryFilter.value) {
            params.push('category=' + encodeURIComponent(txCategoryFilter.value.trim()));
          }
          if (txDateFromFilter && txDateFromFilter.value) {
            params.push('dateFrom=' + encodeURIComponent(txDateFromFilter.value));
          }
          if (txDateToFilter && txDateToFilter.value) {
            params.push('dateTo=' + encodeURIComponent(txDateToFilter.value));
          }
          if (txMinAmountFilter && txMinAmountFilter.value) {
            params.push('minAmount=' + encodeURIComponent(txMinAmountFilter.value));
          }
          if (txMaxAmountFilter && txMaxAmountFilter.value) {
            params.push('maxAmount=' + encodeURIComponent(txMaxAmountFilter.value));
          }

          if (!params.length) return '';
          return '?' + params.join('&');
        }

        function reloadTransactionsWithFilters() {
          var query = buildTransactionsQueryFromFilters();
          setStatus('Завантаження транзакцій...', false);

          Promise.all([
            authedFetch('/transactions' + query).then(function (res) {
              if (!res.ok) throw new Error('Failed to load transactions');
              return res.json();
            }),
            authedFetch('/transactions/summary' + query).then(function (res) {
              if (!res.ok) throw new Error('Failed to load transaction summary');
              return res.json();
            }),
          ])
            .then(function (results) {
              renderTransactions(results[0]);
              setStatus('Дані оновлено', false);
            })
            .catch(function (err) {
              console.error('Failed to load filtered transactions', err);
              setStatus('Не вдалося завантажити транзакції', true);
            });
        }

        // ------------------------------
        // Integration (P2-min)
        // ------------------------------

        function safeCopy(text) {
          if (!text) return;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(function () {});
            return;
          }
          try {
            var ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          } catch (e) {}
        }

        function setOriginStatus(text, isError) {
          if (!originStatusEl) return;
          originStatusEl.textContent = text || '';
          originStatusEl.style.color = isError ? '#b91c1c' : '#065f46';
        }

        function setIntegrationPublicFormsStatus(text, isError) {
          if (!integrationPublicFormsStatusEl) return;
          integrationPublicFormsStatusEl.textContent = text || '';
          integrationPublicFormsStatusEl.style.color = isError ? '#b91c1c' : '#065f46';
        }

        function renderIntegrationPublicFormsTable(forms) {
          if (!integrationPublicFormsTbody) return;
          if (!Array.isArray(forms) || forms.length === 0) {
            integrationPublicFormsTbody.innerHTML = '<tr><td colspan="5" class="muted">Порожньо</td></tr>';
            return;
          }

          integrationPublicFormsTbody.innerHTML = forms
            .map(function (f) {
              var status = f.isActive ? '<span class="badge" style="background:#ecfdf3;color:#15803d;">Active</span>' : '<span class="badge" style="background:#fef2f2;color:#b91c1c;">Disabled</span>';
              var btnLabel = f.isActive ? 'Disable' : 'Enable';
              return (
                '<tr data-form-id="' + f.id + '" data-form-active="' + (f.isActive ? '1' : '0') + '">' +
                  '<td><code>' + escapeHtml(String(f.formKey || '')) + '</code></td>' +
                  '<td class="muted">' + escapeHtml(String(f.type || '')) + '</td>' +
                  '<td>' + escapeHtml(String(f.title || '')) + '</td>' +
                  '<td>' + status + '</td>' +
                  '<td style="text-align:right;">' +
                    '<button type="button" class="btn btn-secondary btn-ghost integration-form-toggle" data-id="' + f.id + '">' + btnLabel + '</button>' +
                  '</td>' +
                '</tr>'
              );
            })
            .join('');
        }

        function loadIntegrationPublicForms() {
          setIntegrationPublicFormsStatus('', false);
          return authedFetch('/public-forms')
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to load public forms');
              return res.json();
            })
            .then(function (data) {
              renderIntegrationPublicFormsTable(data);
            })
            .catch(function (err) {
              console.error('Public forms load failed', err);
              setIntegrationPublicFormsStatus('Failed to load forms', true);
            });
        }

        function buildWidgetSnippets(projectSlug, projectKey) {
          var base = apiBase;
          var lines = [];
          lines.push('<!-- Lead form -->');
          lines.push(
            '<script src="' + base + '/widget/lead-form.js" data-project-slug="' + projectSlug + '" data-project-key="' + projectKey + '"><\/script>'
          );
          lines.push('');
          lines.push('<!-- Donation form -->');
          lines.push(
            '<script src="' + base + '/widget/donation-form.js" data-project-slug="' + projectSlug + '" data-project-key="' + projectKey + '"><\/script>'
          );
          lines.push('');
          lines.push('<!-- Booking form -->');
          lines.push(
            '<script src="' + base + '/widget/booking-form.js" data-project-slug="' + projectSlug + '" data-project-key="' + projectKey + '"><\/script>'
          );
          lines.push('');
          lines.push('<!-- Feedback form -->');
          lines.push(
            '<script src="' + base + '/widget/feedback-form.js" data-project-slug="' + projectSlug + '" data-project-key="' + projectKey + '"><\/script>'
          );
          lines.push('');
          lines.push('<!-- Optional: custom API base (if widgets are embedded on a different domain) -->');
          lines.push('<!-- <script src="' + base + '/widget/lead-form.js" data-api-base="https://YOUR-CRM-HOST" data-project-slug="' + projectSlug + '" data-project-key="' + projectKey + '"><\/script> -->');
          return lines.join('\n');
        }


        function buildCurlExamples(projectSlug, projectKey) {
          var base = apiBase;
          var lines = [];
          lines.push('# ---- Mini CRM Widgets: public smoke via cURL ----');
          lines.push('# 1) Set variables');
          lines.push('BASE="' + base + '"');
          lines.push('SLUG="' + projectSlug + '"');
          lines.push('PUBLIC_KEY="' + projectKey + '"');
          lines.push('ORIGIN="https://your-site.com"   # must be in allowlist');
          lines.push('');
          lines.push('# 2) Read widget config (checks allowlist + form enabled)');
          lines.push('curl -i "$BASE/public/forms/$SLUG/lead/config" \\');
          lines.push('  -H "X-Project-Key: $PUBLIC_KEY" \\');
          lines.push('  -H "Origin: $ORIGIN"');
          lines.push('');
          lines.push('# 3) Submit Lead');
          lines.push('REQ_ID="lead-$(date +%s)"');
          lines.push('curl -i -X POST "$BASE/public/forms/$SLUG/lead" \\');
          lines.push('  -H "Content-Type: application/json" \\');
          lines.push('  -H "X-Project-Key: $PUBLIC_KEY" \\');
          lines.push('  -H "Origin: $ORIGIN" \\');
          lines.push('  -H "X-Request-Id: $REQ_ID" \\');
          lines.push('  -d \'{"name":"CLI Lead","phone":"+380501112233","message":"hello from curl"}\'');
          lines.push('');
          lines.push('# 4) Idempotency check (should return same caseId)');
          lines.push('curl -i -X POST "$BASE/public/forms/$SLUG/lead" \\');
          lines.push('  -H "Content-Type: application/json" \\');
          lines.push('  -H "X-Project-Key: $PUBLIC_KEY" \\');
          lines.push('  -H "Origin: $ORIGIN" \\');
          lines.push('  -H "X-Request-Id: $REQ_ID" \\');
          lines.push('  -d \'{"name":"CLI Lead","phone":"+380501112233","message":"hello from curl (repeat)"}\'');
          lines.push('');
          lines.push('# 5) Negative test: bad origin should be 403 (when allowlist is non-empty)');
          lines.push('curl -i "$BASE/public/forms/$SLUG/lead/config" \\');
          lines.push('  -H "X-Project-Key: $PUBLIC_KEY" \\');
          lines.push('  -H "Origin: https://evil.local"');
          lines.push('');
          lines.push('# 6) Feedback example');
          lines.push('curl -i -X POST "$BASE/public/forms/$SLUG/feedback" \\');
          lines.push('  -H "Content-Type: application/json" \\');
          lines.push('  -H "X-Project-Key: $PUBLIC_KEY" \\');
          lines.push('  -H "Origin: $ORIGIN" \\');
          lines.push('  -H "X-Request-Id: feedback-$(date +%s)" \\');
          lines.push('  -d \'{"name":"CLI Test","message":"feedback via curl","rating":5}\'');
          lines.push('');
          lines.push('# Tip: if you see 410 Form is disabled -> enable it in Admin -> Integration -> Public forms.');
          return lines.join('\n');
        }

        function buildTestWidgetHtml(projectSlug, projectKey) {
          var base = apiBase;
          var esc = function (s) { return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); };
          return (
            '<!doctype html>\n' +
            '<html lang="en">\n' +
            '<head>\n' +
            '  <meta charset="utf-8"/>\n' +
            '  <meta name="viewport" content="width=device-width,initial-scale=1"/>\n' +
            '  <title>Mini CRM Widget Test</title>\n' +
            '  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:24px;background:#f6f7fb;}h1{margin:0 0 12px 0;font-size:20px;}p{margin:0 0 18px 0;color:#555;}section{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:16px;}code{background:#f3f4f6;padding:2px 6px;border-radius:6px;}</style>\n' +
            '</head>\n' +
            '<body>\n' +
            '  <h1>Mini CRM widgets test page</h1>\n' +
            '  <p>CRM base: <code>' + esc(base) + '</code> · projectSlug: <code>' + esc(projectSlug) + '</code></p>\n' +
            '  <section><h3 style="margin:0 0 10px 0;">Lead</h3>\n' +
            '    <script src="' + esc(base) + '/widget/lead-form.js" data-project-slug="' + esc(projectSlug) + '" data-project-key="' + esc(projectKey) + '"><\/script>\n' +
            '  </section>\n' +
            '  <section><h3 style="margin:0 0 10px 0;">Donation</h3>\n' +
            '    <script src="' + esc(base) + '/widget/donation-form.js" data-project-slug="' + esc(projectSlug) + '" data-project-key="' + esc(projectKey) + '"><\/script>\n' +
            '  </section>\n' +
            '  <section><h3 style="margin:0 0 10px 0;">Booking</h3>\n' +
            '    <script src="' + esc(base) + '/widget/booking-form.js" data-project-slug="' + esc(projectSlug) + '" data-project-key="' + esc(projectKey) + '"><\/script>\n' +
            '  </section>\n' +
            '  <section><h3 style="margin:0 0 10px 0;">Feedback</h3>\n' +
            '    <script src="' + esc(base) + '/widget/feedback-form.js" data-project-slug="' + esc(projectSlug) + '" data-project-key="' + esc(projectKey) + '"><\/script>\n' +
            '  </section>\n' +
            '  <p style="color:#666;font-size:13px;">Note: if a form is disabled, it will return 410 on submit. Enable it in Admin → Integration → Public forms.</p>\n' +
            '</body>\n' +
            '</html>\n'
          );
        }

        function renderOriginsTable(origins) {
          if (!originsTbody) return;
          if (!Array.isArray(origins) || origins.length === 0) {
            originsTbody.innerHTML = '<tr><td colspan="3" class="muted">Порожньо</td></tr>';
            return;
          }
          originsTbody.innerHTML = origins
            .map(function (row) {
              var created = row.createdAt ? new Date(row.createdAt).toLocaleString() : '';
              return (
                '<tr data-origin-id="' + row.id + '">' +
                  '<td><code>' + escapeHtml(row.origin) + '</code></td>' +
                  '<td class="muted">' + escapeHtml(created) + '</td>' +
                  '<td style="text-align:right;"><button type="button" class="btn btn-secondary btn-ghost origin-del" data-id="' + row.id + '">Delete</button></td>' +
                '</tr>'
              );
            })
            .join('');
        }

        function setMembersStatus(msg, isError) {
          if (!integrationMembersStatusEl) return;
          integrationMembersStatusEl.textContent = msg || '';
          integrationMembersStatusEl.style.color = isError ? '#b91c1c' : '#6b7280';
        }

        function renderMembersTable(members) {
          if (!integrationMembersTbody) return;
          if (!Array.isArray(members) || members.length === 0) {
            integrationMembersTbody.innerHTML = '<tr><td colspan="4" class="muted">Порожньо</td></tr>';
            return;
          }

          var isOwner = !!(currentUser && currentUser.role === 'owner');
          var isAdmin = !!(currentUser && currentUser.role === 'admin');

          integrationMembersTbody.innerHTML = members
            .map(function (m) {
              var created = m.createdAt ? new Date(m.createdAt).toLocaleString() : '';

              var roleCell;
              if (isOwner) {
                roleCell = (
                  '<select class="form-control member-role" data-id="' + m.id + '" style="max-width:160px;">' +
                    ['owner','admin','viewer'].map(function (r) {
                      var sel = m.role === r ? ' selected' : '';
                      return '<option value="' + r + '"' + sel + '>' + r + '</option>';
                    }).join('') +
                  '</select>'
                );
              } else {
                roleCell = '<span class="pill" style="background:#f3f4f6; color:#374151;">' + escapeHtml(m.role) + '</span>';
              }

              var actions = '';
              // Owner can remove anyone; Admin can remove only viewers.
              if (isOwner || (isAdmin && m.role === 'viewer')) {
                actions = '<button type="button" class="btn btn-sm btn-primary btn-ghost member-del" data-id="' + m.id + '">Remove</button>';
              }

return (
                '<tr data-member-id="' + m.id + '" data-member-role="' + escapeHtml(m.role) + '">' +
                  '<td><code>' + escapeHtml(m.email || '') + '</code></td>' +
                  '<td>' + roleCell + '</td>' +
                  '<td class="muted">' + escapeHtml(created) + '</td>' +
                  '<td style="text-align:right;">' + actions + '</td>' +
                '</tr>'
              );
            })
            .join('');
        }

        function loadMembers() {
          setMembersStatus('Loading...', false);
          return authedFetch('/projects/current/members')
            .then(function (res) {
              if (!res.ok) {
                return safeJson(res).then(function (d) {
                  var msg = (d && d.error) ? d.error : 'Failed to load members';
                  var err = new Error(msg);
                  err.status = res.status;
                  throw err;
                });
              }
              return res.json();
            })
            .then(function (data) {
              renderMembersTable(data);
              // Make permissions visible: users often don't notice role differences
              // unless controls disappear. Keep a subtle read-only hint for non-owners.
              if (currentUser && currentUser.role && currentUser.role !== 'owner') {
                setMembersStatus('Read-only: only the Owner can change roles or remove members (your role: ' + currentUser.role + ')', false);
              } else {
                setMembersStatus('', false);
              }
              return data;
            })
            .catch(function (err) {
              console.error('Members load failed', err);
              setMembersStatus('Failed to load members', true);
            });
        }

        function updateMemberRole(memberId, role) {
          setMembersStatus('Saving...', false);
          return authedFetch('/projects/current/members/' + encodeURIComponent(memberId), {
            method: 'PATCH',
            body: JSON.stringify({ role: role }),
          })
            .then(function (res) {
              return safeJson(res).then(function (d) {
                if (!res.ok) {
                  var msg = (d && d.error) ? d.error : 'Failed to update role';
                  var err = new Error(msg);
                  err.status = res.status;
                  throw err;
                }
                return d;
              });
            })
            .then(function (data) {
              if (data && data.token) {
                try { localStorage.setItem('token', data.token); } catch (e) {}
                // Update cached user role so UI reflects permissions.
                if (currentUser) currentUser.role = role;
              }
              setMembersStatus('Saved', false);
              setTimeout(function () { setMembersStatus('', false); }, 900);
              return loadMembers();
            })
            .catch(function (err) {
              console.error('Member role update failed', err);
              var msg = err && err.message ? err.message : 'Failed to update role';
              setMembersStatus(msg, true);
              return loadMembers();
            });
        }

        function removeMember(memberId) {
          if (!confirm('Remove this member from the project?')) return Promise.resolve();
          setMembersStatus('Removing...', false);
          return authedFetch('/projects/current/members/' + encodeURIComponent(memberId), {
            method: 'DELETE',
          })
            .then(function (res) {
              return safeJson(res).then(function (d) {
                if (!res.ok) {
                  var msg = (d && d.error) ? d.error : 'Failed to remove member';
                  var err = new Error(msg);
                  err.status = res.status;
                  throw err;
                }
                return d;
              });
            })
            .then(function () {
              setMembersStatus('Removed', false);
              setTimeout(function () { setMembersStatus('', false); }, 900);
              return loadMembers();
            })
            .catch(function (err) {
              console.error('Member remove failed', err);
              var msg = err && err.message ? err.message : 'Failed to remove member';
              setMembersStatus(msg, true);
              return loadMembers();
            });
        }

        function loadIntegration() {
          return authedFetch('/projects/current/integration')
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to load integration');
              return res.json();
            })
            .then(function (data) {
              var p = data && data.project ? data.project : null;
              if (!p) throw new Error('No project');

              if (integrationProjectLabel) integrationProjectLabel.textContent = p.name + ' (' + p.slug + ')';
              if (integrationProjectSlugInput) integrationProjectSlugInput.value = p.slug;
              if (integrationProjectKeyInput) integrationProjectKeyInput.value = p.publicKey;
              if (integrationSnippetsTextarea) integrationSnippetsTextarea.value = buildWidgetSnippets(p.slug, p.publicKey);
              if (integrationCurlTextarea) integrationCurlTextarea.value = buildCurlExamples(p.slug, p.publicKey);
              if (integrationPreviewBtn) integrationPreviewBtn.disabled = false;

              renderOriginsTable(data.allowedOrigins || []);
              setOriginStatus('', false);

              // Also load forms list for quick enable/disable testing
              loadIntegrationPublicForms();
              loadMembers();
            })
            .catch(function (err) {
              console.error('Integration load failed', err);
              setOriginStatus('Failed to load integration data', true);
            });
        }

        if (copyProjectSlugBtn) {
          copyProjectSlugBtn.addEventListener('click', function () {
            safeCopy(integrationProjectSlugInput ? integrationProjectSlugInput.value : '');
          });
        }

        if (toggleProjectKeyBtn) {
          toggleProjectKeyBtn.addEventListener('click', function () {
            if (!integrationProjectKeyInput) return;
            var isHidden = integrationProjectKeyInput.type === 'password';
            integrationProjectKeyInput.type = isHidden ? 'text' : 'password';
            toggleProjectKeyBtn.textContent = isHidden ? 'Hide' : 'Show';
          });
        }

        if (copyProjectKeyBtn) {
          copyProjectKeyBtn.addEventListener('click', function () {
            safeCopy(integrationProjectKeyInput ? integrationProjectKeyInput.value : '');
          });
        }

        if (copySnippetsBtn) {
          copySnippetsBtn.addEventListener('click', function () {
            safeCopy(integrationSnippetsTextarea ? integrationSnippetsTextarea.value : '');
          });
        }

if (copyCurlBtn) {
          copyCurlBtn.addEventListener('click', function () {
            safeCopy(integrationCurlTextarea ? integrationCurlTextarea.value : '');
          });
        }

        if (downloadTestHtmlBtn) {
          downloadTestHtmlBtn.addEventListener('click', function () {
            var slug = integrationProjectSlugInput ? integrationProjectSlugInput.value : '';
            var key = integrationProjectKeyInput ? integrationProjectKeyInput.value : '';
            var htmlText = buildTestWidgetHtml(slug, key);

            try {
              var blob = new Blob([htmlText], { type: 'text/html;charset=utf-8' });
              var url = URL.createObjectURL(blob);
              var a = document.createElement('a');
              a.href = url;
              a.download = 'test-widget.html';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              setTimeout(function () { try { URL.revokeObjectURL(url); } catch (e) {} }, 1000);
            } catch (e) {
              // Fallback: copy to clipboard
              safeCopy(htmlText);
              alert('Cannot download file in this browser. HTML was copied to clipboard instead.');
            }
          });
        }

        if (integrationPreviewBtn) {
          integrationPreviewBtn.addEventListener('click', function () {
            // Use already-known currentProject (available on the main screen)
            // so user can open Preview without visiting Integration tab.
            var p = currentProject || {};
            var slug = (p && p.slug) ? String(p.slug) : (integrationProjectSlugInput ? integrationProjectSlugInput.value : '');
            var key = (p && p.publicKey) ? String(p.publicKey) : (integrationProjectKeyInput ? integrationProjectKeyInput.value : '');

            function openPreview() {
              if (!slug || !key) {
                alert('Project data is not loaded yet.');
                return;
              }
              var url = apiBase + '/admin/preview.html?projectSlug=' + encodeURIComponent(slug) + '&projectKey=' + encodeURIComponent(key) + '&apiBase=' + encodeURIComponent(apiBase);
              try {
                window.open(url, '_blank', 'noopener,noreferrer');
              } catch (e) {
                window.location.href = url;
              }
            }

            // If project isn't ready — try to load it once, then open.
            if (!slug || !key) {
              return loadCurrentProject().then(function () {
                var pp = currentProject || {};
                slug = (pp && pp.slug) ? String(pp.slug) : slug;
                key = (pp && pp.publicKey) ? String(pp.publicKey) : key;
                openPreview();
              }).catch(function () {
                openPreview();
              });
            }

            openPreview();
          });
        }

                if (refreshIntegrationBtn) {
          refreshIntegrationBtn.addEventListener('click', function () {
            loadIntegration();
          });
        }

        if (integrationRefreshMembersBtn) {
          integrationRefreshMembersBtn.addEventListener('click', function () {
            loadMembers();
          });
        }

        if (integrationMembersTbody) {
          integrationMembersTbody.addEventListener('change', function (e) {
            var t = e && e.target;
            if (!t || !t.classList || !t.classList.contains('member-role')) return;

            // UI guard (backend enforces too): only Owner can change roles.
            if (!currentUser || currentUser.role !== 'owner') {
              setMembersStatus('Forbidden: only the Owner can change roles', true);
              // Re-sync UI state from server.
              loadMembers();
              return;
            }

            var id = t.getAttribute('data-id');
            var role = t.value;
            if (!id) return;
            updateMemberRole(id, role);
          });

          integrationMembersTbody.addEventListener('click', function (e) {
            var t = e && e.target;
            if (!t || !t.classList || !t.classList.contains('member-del')) return;

            // UI guard (backend enforces too): Owner can remove anyone; Admin can remove only viewers.
            if (!currentUser) {
              setMembersStatus('Forbidden: unauthorized', true);
              loadMembers();
              return;
            }
            if (currentUser.role !== 'owner') {
              // Admin is allowed to remove only viewers.
              var tr = t.closest ? t.closest('tr') : null;
              var targetRole = tr ? tr.getAttribute('data-member-role') : null;
              if (!(currentUser.role === 'admin' && targetRole === 'viewer')) {
                setMembersStatus('Forbidden: you can remove only viewers', true);
                loadMembers();
                return;
              }
            }
var id = t.getAttribute('data-id');
            if (!id) return;
            removeMember(id);
          });
        }

        if (originAddBtn) {
          originAddBtn.addEventListener('click', function () {
            if (!originInput) return;
            var value = String(originInput.value || '').trim();
            if (!value) {
              setOriginStatus('Origin is empty', true);
              return;
            }
            setOriginStatus('Adding...', false);
            authedFetch('/projects/current/allowed-origins', {
              method: 'POST',
              body: JSON.stringify({ origin: value }),
            })
              .then(function (res) {
                if (!res.ok) {
                  return res.json().then(function (b) {
                    throw new Error((b && b.error) || 'Failed');
                  });
                }
                return res.json();
              })
              .then(function () {
                originInput.value = '';
                setOriginStatus('Added', false);
                return loadIntegration();
              })
              .catch(function (err) {
                setOriginStatus(String(err.message || err || 'Failed'), true);
              });
          });
        }

        if (originsTbody) {
          originsTbody.addEventListener('click', function (event) {
            var target = event.target;
            if (!target) return;
            if (!target.classList.contains('origin-del')) return;
            var id = target.getAttribute('data-id');
            if (!id) return;
            setOriginStatus('Deleting...', false);
            authedFetch('/projects/current/allowed-origins/' + encodeURIComponent(id), {
              method: 'DELETE',
            })
              .then(function (res) {
                if (!res.ok) {
                  return res.json().then(function (b) {
                    throw new Error((b && b.error) || 'Failed');
                  });
                }
                return res.json();
              })
              .then(function () {
                setOriginStatus('Deleted', false);
                return loadIntegration();
              })
              .catch(function (err) {
                setOriginStatus(String(err.message || err || 'Failed'), true);
              });
          });
        }

        if (integrationRefreshPublicFormsBtn) {
          integrationRefreshPublicFormsBtn.addEventListener('click', function () {
            loadIntegrationPublicForms();
          });
        }

        if (integrationSeedPublicFormsBtn) {
          integrationSeedPublicFormsBtn.addEventListener('click', function () {
            setIntegrationPublicFormsStatus('Seeding...', false);
            authedFetch('/public-forms/seed', {
              method: 'POST',
              body: JSON.stringify({}),
            })
              .then(function (res) {
                if (!res.ok) {
                  return res.json().then(function (b) {
                    throw new Error((b && b.error) || 'Failed');
                  });
                }
                return res.json();
              })
              .then(function (data) {
                setIntegrationPublicFormsStatus('Seeded', false);
                renderIntegrationPublicFormsTable(data);
              })
              .catch(function (err) {
                setIntegrationPublicFormsStatus(String(err.message || err || 'Failed'), true);
              });
          });
        }

        if (integrationPublicFormsTbody) {
          integrationPublicFormsTbody.addEventListener('click', function (event) {
            var target = event.target;
            if (!target) return;
            if (!target.classList.contains('integration-form-toggle')) return;
            var id = target.getAttribute('data-id');
            if (!id) return;

            var row = target.closest('tr');
            if (!row) return;
            var active = row.getAttribute('data-form-active') === '1';
            var next = !active;

            setIntegrationPublicFormsStatus('Saving...', false);
            authedFetch('/public-forms/' + encodeURIComponent(id), {
              method: 'PATCH',
              body: JSON.stringify({ isActive: next }),
            })
              .then(function (res) {
                if (!res.ok) {
                  return res.json().then(function (b) {
                    throw new Error((b && b.error) || 'Failed');
                  });
                }
                return res.json();
              })
              .then(function () {
                setIntegrationPublicFormsStatus('Saved', false);
                return loadIntegrationPublicForms();
              })
              .catch(function (err) {
                setIntegrationPublicFormsStatus(String(err.message || err || 'Failed'), true);
              });
          });
        }

        if (txApplyFiltersBtn) {
          txApplyFiltersBtn.addEventListener('click', function () {
            reloadTransactionsWithFilters();
          });
        }

tabs.forEach(function (btn) {
          btn.addEventListener('click', function () {
            tabs.forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');

            var tab = btn.getAttribute('data-tab');
            // Hide all views
            if (casesView) casesView.style.display = 'none';
            if (contactsView) contactsView.style.display = 'none';
            if (transactionsView) transactionsView.style.display = 'none';
            if (integrationView) integrationView.style.display = 'none';

            // Preview button is global (always visible) — no per-tab toggling.

            if (tab === 'cases') {
              if (casesView) casesView.style.display = '';
            } else if (tab === 'contacts') {
              if (contactsView) contactsView.style.display = '';
            } else if (tab === 'transactions') {
              if (transactionsView) {
                transactionsView.style.display = '';
                try {
                  transactionsView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (e) {}
              }
              // При переключенні на вкладку "Фінанси" завжди оновлюємо транзакції
              reloadTransactionsWithFilters();
            } else if (tab === 'integration') {
              if (integrationView) {
                integrationView.style.display = '';
                try {
                  integrationView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (e) {}
              }
              loadIntegration();
            }
          });
        });


        if (transactionsTbody) {
          transactionsTbody.addEventListener('click', function (event) {
            var target = event.target;
            if (!target) return;
            var row = target.closest('tr');
            if (!row) return;
            var idAttr = row.getAttribute('data-transaction-id');
            if (!idAttr) return;
            var idNum = Number(idAttr);
            if (!Array.isArray(lastTransactions)) return;
            var tx = lastTransactions.find(function (t) { return Number(t.id) === idNum; });
            if (!tx) return;
            openTransactionModal(tx);
          });

        if (caseModalTransactionsTbody) {
          caseModalTransactionsTbody.addEventListener('click', function (event) {
            var target = event.target;
            if (!target) return;
            var row = target.closest('tr');
            if (!row) return;
            var idAttr = row.getAttribute('data-transaction-id');
            if (!idAttr) return;
            var idNum = Number(idAttr);
            if (!Array.isArray(currentCaseTransactions)) return;
            var tx = currentCaseTransactions.find(function (t) { return Number(t.id) === idNum; });
            if (!tx) return;
            openTransactionModal(tx);
          });
        }

        }

        if (caseModalAddTransactionBtn) {
          caseModalAddTransactionBtn.addEventListener('click', function () {
            if (!currentCaseId) return;
            openCreateTransactionModal({
              caseId: currentCaseId,
              contactId: currentCaseContactId,
              suggestedType: (currentCaseType === 'donation' ? 'income' : 'expense'),
            });
          });
        }


        if (transactionModalSaveBtn) {
          transactionModalSaveBtn.addEventListener('click', function () {
            if (currentTransactionModalMode === 'create') {
              createTransactionFromModal();
              return;
            }
            if (!currentTransactionForModal) {
              closeTransactionModal();
              return;
            }
            saveCurrentTransactionChanges();
          });
        }

        if (transactionModalCancelBtn) {
          transactionModalCancelBtn.addEventListener('click', function () {
            closeTransactionModal();
          });
        }

        if (transactionModalCloseBtn) {
          transactionModalCloseBtn.addEventListener('click', function () {
            closeTransactionModal();
          });
        }

        loginForm.addEventListener('submit', function (e) {
          e.preventDefault();
          setStatus('', false);
          loginBtn.disabled = true;
          var email = (document.getElementById('email')).value;
          var password = (document.getElementById('password')).value;

          fetch(apiBase + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, password: password }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res.json().catch(function () {
                  return { error: 'Login failed' };
                }).then(function (data) {
                  throw new Error(data.error || 'Login failed');
                });
              }
              return res.json();
            })
            .then(function (data) {
              setToken(data.token);
              currentProject = null;
              setStatus('Успішний вхід', false);
              dataCard.style.display = '';
              logoutBtn.style.display = 'inline-flex';
              refreshProjectHeader(data.user).finally(function () {
                loadProjectConfig().finally(function () {
                if (typeof updateTransactionCategoryFilterOptions === 'function') {
                  updateTransactionCategoryFilterOptions();
                }
                loadData();
              });
              });
            })
            .catch(function (err) {
              console.error('Login error', err);
              setToken(null);
              setUserInfo(null);
              dataCard.style.display = 'none';
              logoutBtn.style.display = 'none';
              setStatus(err.message || 'Помилка входу', true);
            })
            .finally(function () {
              loginBtn.disabled = false;
            });
        });

        logoutBtn.addEventListener('click', function () {
          setToken(null);
          setUserInfo(null);

          // Security: clear any credentials left in forms. Browsers may keep autofill in-session;
          // we explicitly reset and wipe values on logout.
          try {
            if (loginForm && typeof loginForm.reset === 'function') loginForm.reset();
            if (inviteCardForm && typeof inviteCardForm.reset === 'function') inviteCardForm.reset();

            var emailInput = document.getElementById('email');
            var passwordInput = document.getElementById('password');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';

            if (inviteCardEmailInput) inviteCardEmailInput.value = '';
            if (inviteCardPasswordInput) inviteCardPasswordInput.value = '';
          } catch (e) {}

          // hide app content
          if (dataCard) dataCard.style.display = 'none';
          if (inviteCard) inviteCard.style.display = 'none';

          // show login
          if (loginCard) loginCard.style.display = '';

          // hide logout button itself
          if (logoutBtn) logoutBtn.style.display = 'none';

          // drop invite param from URL to avoid confusing state after logout
          try {
            var url = new URL(window.location.href);
            url.searchParams.delete('invite');
            window.history.replaceState({}, document.title, url.toString());
          } catch (e) {}

          setStatus('Вийшли з системи', false);
        });


        if (projectSwitchApplyBtn) {
          projectSwitchApplyBtn.addEventListener('click', function () {
            if (!projectSelectEl) return;
            var pid = projectSelectEl.value;
            if (!pid) return;
            selectProject(pid).catch(function (err) {
              console.error('Project select failed', err);
              setStatus(err.message || 'Не вдалося перемкнути проєкт', true);
            });
          });
        }

        if (openProjectAccessBtn) {
          openProjectAccessBtn.addEventListener('click', function () {
            var token = getToken();
            if (!token) return;
            authedFetch('/auth/me')
              .then(function (res) { if (!res.ok) throw new Error('Not authenticated'); return res.json(); })
              .then(function (data) {
                openProjectAccessModal(data.user);
              })
              .catch(function (err) {
                console.error('Failed to open project access', err);
              });
          });
        }

        if (projectAccessClose) {
          projectAccessClose.addEventListener('click', function () { closeProjectAccessModal(); });
        }
        if (projectAccessCancel) {
          projectAccessCancel.addEventListener('click', function () { closeProjectAccessModal(); });
        }
        if (projectAccessModalBackdrop) {
          projectAccessModalBackdrop.addEventListener('click', function (e) {
            if (e && e.target === projectAccessModalBackdrop) closeProjectAccessModal();
          });
        }

        if (inviteCreateBtn) {
          inviteCreateBtn.addEventListener('click', function () {
            createInvite();
          });
        }

        if (inviteAcceptBtn) {
          inviteAcceptBtn.addEventListener('click', function () {
            acceptInvite();
          });
        }


        // Try to restore existing token

        function openCaseModal(id) {
          if (!lastCases || !Array.isArray(lastCases)) return;
          var c = lastCases.find(function (item) { return item.id === id; });
          if (!c) return;
          currentCaseId = id;
          currentCaseContactId = (c.contact && c.contact.id != null) ? c.contact.id : (c.contactId != null ? c.contactId : null);
          currentCaseType = c.type || null;
          caseModalTitle.textContent = 'Кейс #' + id;
          caseModalMainTitle.textContent = c.title || '';
          var modalStatus = c.status || 'new';
          var modalStatusMeta = getCaseStatusMeta(modalStatus);
          caseModalStatusEl.textContent = (modalStatusMeta && modalStatusMeta.label) || modalStatus;
          caseModalDescription.textContent = c.description || '';
          caseModalContact.innerHTML = formatContactForModal(c.contact || null);
          caseModalSource.textContent = c.source || '–';
          currentCaseInitialInternalNote = c.internalNote || '';
          caseModalInternalNote.value = currentCaseInitialInternalNote;
          caseModalBackdrop.style.display = 'flex';

          currentCaseTasks = [];
          renderCaseTasks();
          loadCaseTasks(id);
          loadCaseTransactions(id);
        }


        function loadCaseTasks(caseId) {
          if (!caseTasksList) return;
          authedFetch('/cases/' + caseId + '/tasks')
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to load tasks');
              }
              return res.json();
            })
            .then(function (data) {
              if (!Array.isArray(data)) {
                currentCaseTasks = [];
              } else {
                currentCaseTasks = data;
              }
              renderCaseTasks();
            })
            .catch(function (err) {
              console.error('Failed to load tasks', err);
              currentCaseTasks = [];
              renderCaseTasks();
            });
        }


        function loadCaseTransactions(caseId) {
          if (!caseModalTransactionsTbody) return;
          // reset UI
          caseModalTransactionsTbody.innerHTML = '<tr><td colspan="5" class="muted">Завантаження...</td></tr>';
          if (caseModalTransactionsSummary) caseModalTransactionsSummary.textContent = 'Завантаження...';

          authedFetch('/transactions?caseId=' + encodeURIComponent(String(caseId)))
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to load case transactions');
              return res.json();
            })
            .then(function (data) {
              currentCaseTransactions = Array.isArray(data) ? data : [];
              renderCaseTransactions();
            })
            .catch(function (err) {
              console.error('Failed to load case transactions', err);
              currentCaseTransactions = [];
              if (caseModalTransactionsTbody) {
                caseModalTransactionsTbody.innerHTML =
                  '<tr><td colspan="5" class="muted">Не вдалося завантажити транзакції</td></tr>';
              }
              if (caseModalTransactionsSummary) {
                caseModalTransactionsSummary.textContent = 'Помилка завантаження';
              }
            });
        }

        function renderCaseTransactions() {
          if (!caseModalTransactionsTbody) return;

          var list = Array.isArray(currentCaseTransactions) ? currentCaseTransactions : [];
          if (!list.length) {
            caseModalTransactionsTbody.innerHTML =
              '<tr><td colspan="5" class="muted">Немає транзакцій по цьому кейсу</td></tr>';
            if (caseModalTransactionsSummary) caseModalTransactionsSummary.textContent = '0 транзакцій';
            return;
          }

          // Case-level finance summary (context, not a duplicate of the global Finance table)
          // We treat tx.type as the source of truth; category meta is only a fallback elsewhere.
          var incomeTotal = 0;
          var expenseTotal = 0;
          var unknownTotal = 0;
          var currency = 'UAH';
          list.forEach(function (tx) {
            var amt = Number(tx.amount || 0);
            if (tx.currency) currency = tx.currency;
            if (tx.type === 'expense') {
              expenseTotal += amt;
            } else if (tx.type === 'income') {
              incomeTotal += amt;
            } else {
              unknownTotal += amt;
            }
          });
          var balance = incomeTotal - expenseTotal;
          if (caseModalTransactionsSummary) {
            var text =
              list.length + ' транзакцій · Доходи: ' +
              formatCurrency(incomeTotal, currency) +
              ' · Витрати: ' + formatCurrency(expenseTotal, currency) +
              ' · Баланс: ' + formatCurrency(balance, currency);
            if (unknownTotal) {
              text += ' · Невідомо: ' + formatCurrency(unknownTotal, currency);
            }
            caseModalTransactionsSummary.textContent = text;
          }

          var rows = list
            .map(function (tx) {
              var dateValue = tx.happenedAt || tx.createdAt;
              var type = tx.type || '';
              var typeLabel = type === 'income' ? 'Доходи' : (type === 'expense' ? 'Витрати' : (type || '—'));
              var categoryHtml = tx.category ? renderTransactionCategoryBadge(tx.category) : '<span class="muted">—</span>';
              var desc = (tx.description || '').trim();

              return (
                '<tr class="case-tx-row" data-transaction-id="' + tx.id + '">' +
                '<td>' + (dateValue ? formatDate(dateValue) : '') + '</td>' +
                '<td>' + typeLabel + '</td>' +
                '<td>' + formatCurrency(tx.amount, tx.currency) + '</td>' +
                '<td>' + categoryHtml + '</td>' +
                '<td>' + (desc ? escapeHtml(desc) : '<span class="muted">—</span>') + '</td>' +
                '</tr>'
              );
            })
            .join('');

          caseModalTransactionsTbody.innerHTML = rows;
        }


        function renderCaseTasks() {
          if (!caseTasksList) return;
          caseTasksList.innerHTML = '';

          if (!currentCaseTasks || currentCaseTasks.length === 0) {
            var emptyLi = document.createElement('li');
            emptyLi.textContent = 'Поки що немає задач.';
            emptyLi.className = 'case-tasks-empty';
            caseTasksList.appendChild(emptyLi);
            return;
          }

          currentCaseTasks.forEach(function (task) {
            var li = document.createElement('li');
            li.className = 'case-task-item';

            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!task.done;
            checkbox.addEventListener('change', function () {
              updateTaskDone(task.id, checkbox.checked);
            });

            var span = document.createElement('span');
            span.textContent = task.title || '';
            if (task.done) {
              span.classList.add('case-task-done');
            }

            var delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.textContent = '✕';
            delBtn.className = 'case-task-delete-btn';
            delBtn.addEventListener('click', function () {
              deleteTask(task.id);
            });

            li.appendChild(checkbox);
            li.appendChild(span);
            li.appendChild(delBtn);

            caseTasksList.appendChild(li);
          });
        }

        function addCaseTask(title) {
          if (!currentCaseId) return;
          setStatus('Створення задачі...', false);
          authedFetch('/cases/' + currentCaseId + '/tasks', {
            method: 'POST',
            body: JSON.stringify({ title: title }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to create task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to create task');
                  });
              }
              return res.json();
            })
            .then(function (task) {
              caseTaskInput.value = '';
              currentCaseTasks.push(task);
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу створено', false);
            })
            .catch(function (err) {
              console.error('Failed to create task', err);
              setStatus(err.message || 'Не вдалося створити задачу', true);
            });
        }

        function updateTaskDone(taskId, done) {
          setStatus('Оновлення задачі...', false);
          authedFetch('/tasks/' + taskId, {
            method: 'PATCH',
            body: JSON.stringify({ done: !!done }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update task');
                  });
              }
              return res.json();
            })
            .then(function (updated) {
              currentCaseTasks = currentCaseTasks.map(function (t) {
                return t.id === updated.id ? updated : t;
              });
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу оновлено', false);
            })
            .catch(function (err) {
              console.error('Failed to update task', err);
              setStatus(err.message || 'Не вдалося оновити задачу', true);
            });
        }

        function deleteTask(taskId) {
          setStatus('Видалення задачі...', false);
          authedFetch('/tasks/' + taskId, {
            method: 'DELETE',
          })
            .then(function (res) {
              if (!res.ok && res.status !== 204) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to delete task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to delete task');
                  });
              }
            })
            .then(function () {
              currentCaseTasks = currentCaseTasks.filter(function (t) {
                return t.id !== taskId;
              });
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу видалено', false);
            })
            .catch(function (err) {
              console.error('Failed to delete task', err);
              setStatus(err.message || 'Не вдалося видалити задачу', true);
            });
        }

        function syncCaseStatusWithTasks() {
          if (!currentCaseId || !Array.isArray(currentCaseTasks)) {
            return;
          }

          var nextStatus;
          if (currentCaseTasks.length === 0) {
            // Якщо задач немає — кейс повертається в стан "new"
            nextStatus = 'new';
          } else {
            var anyOpen = currentCaseTasks.some(function (t) { return !t.done; });
            nextStatus = anyOpen ? 'in_progress' : 'done';
          }

          var c = lastCases.find(function (item) { return item.id === currentCaseId; });
          if (!c || c.status === nextStatus) {
            return;
          }

          setStatus('Оновлення статусу кейсу за задачами...', false);
          authedFetch('/cases/' + currentCaseId, {
            method: 'PATCH',
            body: JSON.stringify({ status: nextStatus }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update case status' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update case status');
                  });
              }
              return res.json();
            })
            .then(function () {
              c.status = nextStatus;
              var metaAfterTasks = getCaseStatusMeta(nextStatus);
              caseModalStatusEl.textContent = (metaAfterTasks && metaAfterTasks.label) || nextStatus;
              loadData();
              setStatus('Статус кейсу оновлено за задачами', false);
            })
            .catch(function (err) {
              console.error('Failed to auto-update case status', err);
              setStatus(err.message || 'Не вдалося оновити статус кейсу', true);
            });
        }

        function closeCaseModal() {
          currentCaseId = null;
          caseModalBackdrop.style.display = 'none';
        }
        function openCaseStatusConfigModal() {
          if (caseStatusConfigModalBackdrop) {
            caseStatusConfigModalBackdrop.style.display = 'flex';
          }
          if (typeof renderCaseStatusConfigEditor === 'function') {
            renderCaseStatusConfigEditor();
          }
        }

        function closeCaseStatusConfigModal() {
          if (caseStatusConfigModalBackdrop) {
            caseStatusConfigModalBackdrop.style.display = 'none';
          }
        }

        if (openCaseStatusConfigBtn) {
          openCaseStatusConfigBtn.addEventListener('click', function () {
            openCaseStatusConfigModal();
          });
        }
        if (caseStatusConfigClose) {
          caseStatusConfigClose.addEventListener('click', function () {
            closeCaseStatusConfigModal();
          });
        }



        function openTransactionCategoriesConfigModal() {
          if (transactionCategoriesConfigModalBackdrop) {
            transactionCategoriesConfigModalBackdrop.style.display = 'flex';
          }
          if (typeof renderTransactionCategoriesConfigEditor === 'function') {
            renderTransactionCategoriesConfigEditor();
          }
        }

        function closeTransactionCategoriesConfigModal() {
          if (transactionCategoriesConfigModalBackdrop) {
            transactionCategoriesConfigModalBackdrop.style.display = 'none';
          }
        }

        if (openTransactionCategoriesConfigBtn) {
          openTransactionCategoriesConfigBtn.addEventListener('click', function () {
            openTransactionCategoriesConfigModal();
          });
        }
        if (transactionCategoriesConfigClose) {
          transactionCategoriesConfigClose.addEventListener('click', function () {
            closeTransactionCategoriesConfigModal();
          });
        }


        function openPublicFormsConfigModal() {
          if (!publicFormsConfigModalBackdrop) return;
          if (notificationsConfigModalBackdrop) {
            notificationsConfigModalBackdrop.style.display = 'none';
          }
          console.log('[mini-crm] openPublicFormsConfigModal');
          publicFormsConfigModalBackdrop.style.display = 'flex';
          loadPublicFormsConfig();
        }

        function closePublicFormsConfigModal() {
          if (!publicFormsConfigModalBackdrop) return;
          publicFormsConfigModalBackdrop.style.display = 'none';
        }
        window.closePublicFormsConfigModal = closePublicFormsConfigModal;
        window.openPublicFormsConfigModal = openPublicFormsConfigModal;

        var publicFormsConfigHandlerAttached = false;
        function attachPublicFormsConfigHandler() {
          if (publicFormsConfigHandlerAttached) return;
          if (!openPublicFormsConfigBtn) return;
          openPublicFormsConfigBtn.addEventListener('click', function (event) {
            if (event && typeof event.preventDefault === 'function') {
              event.preventDefault();
            }
            if (event && typeof event.stopPropagation === 'function') {
              event.stopPropagation();
            }
            try {
              openPublicFormsConfigModal();
            } catch (err) {
              console.error('Failed to open public forms config modal', err);
            }
          });
          publicFormsConfigHandlerAttached = true;
        }

        attachPublicFormsConfigHandler();

        function setPublicFormsConfigStatus(message, isError) {
          if (!publicFormsConfigStatus) return;
          publicFormsConfigStatus.textContent = message || '';
          publicFormsConfigStatus.style.color = isError ? '#b91c1c' : '#64748b';
        }

        function renderPublicFormsRows(forms) {
          if (!publicFormsTbody) return;
          publicFormsTbody.innerHTML = '';
          if (!forms || !forms.length) {
            var tr = document.createElement('tr');
            var td = document.createElement('td');
            td.colSpan = 3;
            td.className = 'muted';
            td.textContent = 'Немає форм для цього проєкту';
            tr.appendChild(td);
            publicFormsTbody.appendChild(tr);
            if (publicFormsConfigSeed) publicFormsConfigSeed.style.display = 'inline-flex';
            if (publicFormsConfigSave) publicFormsConfigSave.disabled = true;
            return;
          }
          if (publicFormsConfigSeed) publicFormsConfigSeed.style.display = 'none';
          if (publicFormsConfigSave) publicFormsConfigSave.disabled = false;
          forms.forEach(function (form) {
            var tr = document.createElement('tr');

            var keyTd = document.createElement('td');
            keyTd.textContent = form.formKey || '';
            tr.appendChild(keyTd);

            var titleTd = document.createElement('td');
            var input = document.createElement('input');
            input.type = 'text';
            input.value = form.title || '';
            input.setAttribute('data-form-id', String(form.id));
            input.setAttribute('data-field', 'title');
            titleTd.appendChild(input);
            tr.appendChild(titleTd);

            var activeTd = document.createElement('td');
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!form.isActive;
            checkbox.setAttribute('data-form-id', String(form.id));
            checkbox.setAttribute('data-field', 'isActive');
            activeTd.appendChild(checkbox);
            tr.appendChild(activeTd);

            publicFormsTbody.appendChild(tr);
          });
        }

        function loadPublicFormsConfig() {
          if (!publicFormsTbody) return;
          publicFormsTbody.innerHTML =
            '<tr><td colspan="3" class="muted">Завантаження...</td></tr>';
          setPublicFormsConfigStatus('Завантаження...', false);
          if (publicFormsConfigSeed) publicFormsConfigSeed.style.display = 'none';
          if (publicFormsConfigSave) publicFormsConfigSave.disabled = true;
          authedFetch('/public-forms')
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to load public forms');
              return res.json();
            })
            .then(function (data) {
              var forms = Array.isArray(data) ? data : [];
              renderPublicFormsRows(forms);
              setPublicFormsConfigStatus('Дані завантажено', false);
            })
            .catch(function (err) {
              console.error('Failed to load public forms', err);
              setPublicFormsConfigStatus('Не вдалося завантажити форми', true);
            });
        }

        function seedPublicFormsConfig() {
          setPublicFormsConfigStatus('Створення типових форм...', false);
          if (publicFormsConfigSeed) publicFormsConfigSeed.disabled = true;
          authedFetch('/public-forms/seed', { method: 'POST' })
            .then(function (res) {
              if (!res.ok) throw new Error('Failed to seed public forms');
              return res.json();
            })
            .then(function (data) {
              var forms = Array.isArray(data) ? data : [];
              renderPublicFormsRows(forms);
              setPublicFormsConfigStatus('Типові форми створено', false);
            })
            .catch(function (err) {
              console.error('Failed to seed public forms', err);
              setPublicFormsConfigStatus('Не вдалося створити типові форми', true);
            })
            .finally(function () {
              if (publicFormsConfigSeed) publicFormsConfigSeed.disabled = false;
            });
        }


        function collectPublicFormsChanges() {
          if (!publicFormsTbody) return [];
          var inputs = publicFormsTbody.querySelectorAll('input[data-form-id]');
          var byId = {};
          inputs.forEach(function (el) {
            var id = el.getAttribute('data-form-id');
            if (!id) return;
            if (!byId[id]) byId[id] = { id: Number(id) };
            var field = el.getAttribute('data-field');
            if (field === 'title') {
              byId[id].title = el.value != null ? String(el.value) : '';
            } else if (field === 'isActive') {
              byId[id].isActive = el.checked;
            }
          });
          return Object.keys(byId).map(function (key) {
            return byId[key];
          });
        }

        function savePublicFormsConfig() {
          var changes = collectPublicFormsChanges();
          if (!changes.length) {
            setPublicFormsConfigStatus('Немає змін для збереження', false);
            return;
          }
          setPublicFormsConfigStatus('Збереження...', false);
          Promise.all(
            changes.map(function (payload) {
              return authedFetch('/public-forms/' + payload.id, {
                method: 'PATCH',
                body: JSON.stringify({
                  title: payload.title,
                  isActive: payload.isActive,
                }),
              }).then(function (res) {
                if (!res.ok) {
                  return res
                    .json()
                    .catch(function () {
                      return { error: 'Failed to save form' };
                    })
                    .then(function (data) {
                      throw new Error(data.error || 'Failed to save form');
                    });
                }
                return res.json();
              });
            })
          )
            .then(function () {
              setPublicFormsConfigStatus('Зміни збережено', false);
              return loadPublicFormsConfig();
            })
            .catch(function (err) {
              console.error('Failed to save public forms', err);
              setPublicFormsConfigStatus('Не вдалося зберегти форми', true);
            });
        }

        function openNotificationsConfigModal() {
          if (!notificationsConfigModalBackdrop) return;
          if (publicFormsConfigModalBackdrop) {
            publicFormsConfigModalBackdrop.style.display = 'none';
          }
          console.log('[mini-crm] openNotificationsConfigModal');
          notificationsConfigModalBackdrop.style.display = 'flex';
          if (typeof renderNotificationsConfigEditor === 'function') {
            renderNotificationsConfigEditor();
          }
        }

        function closeNotificationsConfigModal() {
          if (!notificationsConfigModalBackdrop) return;
          notificationsConfigModalBackdrop.style.display = 'none';
        }
        window.openNotificationsConfigModal = openNotificationsConfigModal;
        window.closeNotificationsConfigModal = closeNotificationsConfigModal;

        function setNotificationsConfigStatus(message, isError) {
          if (!notificationsConfigStatus) return;
          notificationsConfigStatus.textContent = message || '';
          notificationsConfigStatus.style.color = isError ? '#b91c1c' : '#64748b';
        }

        function renderNotificationsConfigEditor() {
          if (!notificationsEmailsInput) return;
          var config = currentProjectConfig || {};
          var notifications = config.notifications || {};
          var emails = Array.isArray(notifications.emails) ? notifications.emails : [];
          if (!emails.length) {
            emails = ['pavlovsergii106@gmail.com'];
          }
          notificationsEmailsInput.value = emails.join(', ');

          var notifyOnLead =
            typeof notifications.notifyOnLead === 'boolean' ? notifications.notifyOnLead : true;
          var notifyOnDonation =
            typeof notifications.notifyOnDonation === 'boolean' ? notifications.notifyOnDonation : true;
          var notifyOnBooking =
            typeof notifications.notifyOnBooking === 'boolean' ? notifications.notifyOnBooking : true;
          var notifyOnFeedback =
            typeof notifications.notifyOnFeedback === 'boolean' ? notifications.notifyOnFeedback : true;

          if (notifyOnLeadCheckbox) notifyOnLeadCheckbox.checked = !!notifyOnLead;
          if (notifyOnDonationCheckbox) notifyOnDonationCheckbox.checked = !!notifyOnDonation;
          if (notifyOnBookingCheckbox) notifyOnBookingCheckbox.checked = !!notifyOnBooking;
          if (notifyOnFeedbackCheckbox) notifyOnFeedbackCheckbox.checked = !!notifyOnFeedback;

          setNotificationsConfigStatus('', false);
        }

        function parseEmails(raw) {
          if (!raw) return [];
          return raw
            .split(/[;,\s]+/)
            .map(function (s) { return s.trim(); })
            .filter(function (s) { return s.length > 0; });
        }

        async function saveNotificationsConfig() {
          if (!notificationsEmailsInput) return;
          setNotificationsConfigStatus('Збереження...', false);

          var emails = parseEmails(notificationsEmailsInput.value);
          var notifyOnLead = notifyOnLeadCheckbox ? !!notifyOnLeadCheckbox.checked : true;
          var notifyOnDonation = notifyOnDonationCheckbox ? !!notifyOnDonationCheckbox.checked : true;
          var notifyOnBooking = notifyOnBookingCheckbox ? !!notifyOnBookingCheckbox.checked : true;
          var notifyOnFeedback = notifyOnFeedbackCheckbox ? !!notifyOnFeedbackCheckbox.checked : true;

          var caseStatusesPayload = CASE_STATUSES.map(function (code) {
            var meta = caseStatusConfigMap[code] || { code: code, label: code };
            return {
              code: code,
              label: meta.label || code,
              rowBg: meta.rowBg || undefined,
            };
          });

          try {
            await authedFetch('/projects/current/config', {
              method: 'PATCH',
              body: JSON.stringify({
                caseStatuses: caseStatusesPayload,
                notifications: {
                  emails: emails,
                  notifyOnLead: notifyOnLead,
                  notifyOnDonation: notifyOnDonation,
                  notifyOnBooking: notifyOnBooking,
                  notifyOnFeedback: notifyOnFeedback,
                },
              }),
            });
            if (!currentProjectConfig) currentProjectConfig = {};
            currentProjectConfig.notifications = {
              emails: emails,
              notifyOnLead: notifyOnLead,
              notifyOnDonation: notifyOnDonation,
              notifyOnBooking: notifyOnBooking,
              notifyOnFeedback: notifyOnFeedback,
            };
            setNotificationsConfigStatus('Збережено', false);
          } catch (err) {
            console.error('Failed to save notifications config', err);
            setNotificationsConfigStatus('Помилка збереження', true);
          }
        }

        if (openNotificationsConfigBtn) {
          openNotificationsConfigBtn.addEventListener('click', function (event) {
            event.preventDefault();
            openNotificationsConfigModal();
          });
          window.openNotificationsConfigModal = openNotificationsConfigModal;
        }
        if (notificationsConfigClose) {
          notificationsConfigClose.addEventListener('click', function () {
            closeNotificationsConfigModal();
          });
        }
        if (notificationsConfigSave) {
          notificationsConfigSave.addEventListener('click', function () {
            saveNotificationsConfig();
          });
        }

        if (openPublicFormsConfigBtn) {
          attachPublicFormsConfigHandler();
        }
        if (publicFormsConfigClose) {
          publicFormsConfigClose.addEventListener('click', function () {
            closePublicFormsConfigModal();
          });
        }
        if (publicFormsConfigSave) {
          publicFormsConfigSave.addEventListener('click', function () {
            savePublicFormsConfig();
          });
        }
        if (publicFormsConfigSeed) {
          publicFormsConfigSeed.addEventListener('click', function () {
            seedPublicFormsConfig();
          });
        }


caseModalClose.addEventListener('click', function () {
                  closeCaseModal();
        });
        caseModalCancel.addEventListener('click', function () {
          if (!currentCaseId) {
            closeCaseModal();
            return;
          }
          // Відкатити внутрішні нотатки до початкового стану
          caseModalInternalNote.value = currentCaseInitialInternalNote || '';
          // Очистити поле введення нової задачі (якщо щось було набрано)
          if (typeof caseTaskInput !== 'undefined' && caseTaskInput) {
            caseTaskInput.value = '';
          }
          setStatus('Зміни скасовано', false);
        });

        // Закривати модальне вікно по Esc
        document.addEventListener('keydown', function (event) {
          if (event.key === 'Escape' || event.key === 'Esc') {
            if (caseModalBackdrop && caseModalBackdrop.style.display === 'flex') {
              closeCaseModal();
            }
          }
        });

// Клік поза модальним вікном більше не закриває його, щоб випадково не втрачати контекст
        caseModalSave.addEventListener('click', function () {
          if (!currentCaseId) return;
          var note = caseModalInternalNote.value || '';
          setStatus('Збереження нотаток кейсу...', false);
          authedFetch('/cases/' + currentCaseId, {
            method: 'PATCH',
            body: JSON.stringify({ internalNote: note }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update case' }; })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update case');
                  });
              }
              return res.json();
            })
            .then(function () {
              setStatus('Нотатки кейсу збережено', false);
              closeCaseModal();
              loadData();
            })
            .catch(function (err) {
              console.error('Failed to save case notes', err);
              setStatus(err.message || 'Не вдалося зберегти нотатки кейсу', true);
            });
        });

        if (caseTasksForm && caseTaskInput) {
          caseTasksForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!currentCaseId) return;
            var title = (caseTaskInput.value || '').trim();
            if (!title) return;
            addCaseTask(title);
          });
        }

// Invite accept flow: if URL contains ?invite=TOKEN then show accept screen
var inviteTokenFromUrl = getInviteTokenFromUrl();
if (inviteTokenFromUrl) {
  showInviteCard(inviteTokenFromUrl);

  // Pre-check invite status so that reopening an already used link immediately redirects to login.
  checkInviteStatus(inviteTokenFromUrl).then(function (st) {
    if (!st) return;
    if (st.status === 'used') {
      clearInviteFromUrl();
      var authed = !!getToken();
      if (!authed) {
        setInviteStatus('Посилання вже використано. Увійдіть, щоб продовжити.', true);
        hideInviteCard();
        setStatus('Посилання запрошення вже використано. Будь ласка, увійдіть.', true);
      } else {
        // If already logged in, do not force logout; just inform and continue.
        setInviteStatus('Посилання вже використано. Ви вже увійшли.', true);
        setStatus('Посилання запрошення вже використано. Ви вже увійшли.', true);
        setTimeout(function () {
          try { if (inviteCard) inviteCard.style.display = 'none'; } catch (e) {}
        }, 600);
      }
      return;
    }

    if (st.status === 'expired') {
      clearInviteFromUrl();
      setInviteStatus('Термін дії запрошення минув', true);
      hideInviteCard();
      setStatus('Термін дії запрошення минув. Увійдіть або попросіть нове запрошення.', true);
      return;
    }

    if (st.status === 'unknown' && st._errorStatus === 404) {
      clearInviteFromUrl();
      setInviteStatus('Посилання недійсне або не знайдено', true);
      hideInviteCard();
      setStatus('Посилання недійсне або не знайдено. Увійдіть або попросіть нове запрошення.', true);
      return;
    }
  });

  if (inviteCardForm) {
    inviteCardForm.addEventListener('submit', function (e) {
      e.preventDefault();
      acceptInvitePublic(inviteTokenFromUrl);
    });
  }

  if (inviteCardAcceptAuthedBtn) {
    inviteCardAcceptAuthedBtn.addEventListener('click', function () {
      acceptInviteAuthed(inviteTokenFromUrl);
    });
  }

  if (inviteCardBackBtn) {
    inviteCardBackBtn.addEventListener('click', function () {
      clearInviteFromUrl();
      hideInviteCard();
    });
  }
}

var existingToken = getToken();
        if (existingToken) {
          authedFetch('/auth/me')
            .then(function (res) {
              if (!res.ok) throw new Error('Not authenticated');
              return res.json();
            })
            .then(function (data) {
              refreshProjectHeader(data.user).finally(function () {
                dataCard.style.display = '';
                logoutBtn.style.display = 'inline-flex';
                setStatus('Сесія відновлена', false);
                loadProjectConfig().finally(function () {
                if (typeof updateTransactionCategoryFilterOptions === 'function') {
                  updateTransactionCategoryFilterOptions();
                }
                loadData();
              });
              });
            })
            .catch(function () {
              setToken(null);
              setUserInfo(null);
            });
        }
      })();
    
    
    </script>
  </body>
</html>
