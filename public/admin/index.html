<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <title>Mini CRM Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f1f5f9;
        color: #0f172a;
      }
      .app-shell {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      header {
        background: #0f172a;
        color: #e5e7eb;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      header h1 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
      }
      header .user-info {
        font-size: 13px;
        opacity: 0.9;
      }
      main {
        flex: 1;
        max-width: 1120px;
        margin: 16px auto 24px;
        padding: 0 12px;
        width: 100%;
      }
      .card {
        background: #ffffff;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        padding: 16px 18px;
      }
      .login-title {
        margin-top: 0;
        margin-bottom: 12px;
        font-size: 18px;
        font-weight: 600;
      }
      .field {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }
      label {
        font-size: 13px;
        color: #4b5563;
      }
      input {
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-size: 14px;
        font-family: inherit;
      }
      input:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }
      button {
        border-radius: 999px;
        border: none;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: #0ea5e9;
        color: white;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      button[disabled] {
        opacity: 0.6;
        cursor: default;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .login-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        margin-top: 4px;
      }
      .status {
        font-size: 13px;
        margin-top: 8px;
      }
      .status.error {
        color: #b91c1c;
      }
      .status.ok {
        color: #15803d;
      }
      .tabs {
        margin-top: 16px;
        margin-bottom: 8px;
        display: inline-flex;
        border-radius: 999px;
        background: #e5e7eb;
        padding: 2px;
      }
      .tab-btn {
        border-radius: 999px;
        border: none;
        padding: 6px 14px;
        font-size: 13px;
        cursor: pointer;
        background: transparent;
        color: #4b5563;
      }
      .tab-btn.active {
        background: #ffffff;
        color: #0f172a;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.18);
      }
      .table-wrap {
        margin-top: 12px;
        overflow-x: auto;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        font-size: 13px;
      }
      thead {
        background: #f8fafc;
      }
      th, td {
        padding: 8px 10px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: top;
      }
      th {
        font-weight: 600;
        color: #475569;
        white-space: nowrap;
      }
      tbody tr:hover {
        background: #f9fafb;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        background: #e0f2fe;
        color: #0369a1;
      }
      .status-select {
        border-radius: 999px;
        border: 1px solid #cbd5e1;
        padding: 2px 8px;
        font-size: 11px;
        background: #ffffff;
      }
      .muted {
        color: #9ca3af;
        font-size: 12px;
      }
      .pill {
        border-radius: 999px;
        padding: 2px 8px;
        background: #f3f4f6;
        font-size: 11px;
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.45);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 40;
      }
      .modal {
        background: #ffffff;
        border-radius: 12px;
        max-width: 640px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35);
      }
      .modal-header,
      .modal-footer {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .modal-footer {
        border-bottom: none;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 8px;
      }
      .modal-header h2 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
      }
      .modal-body {
        padding: 12px 16px;
        overflow-y: auto;
      }
      #case-modal-internal-note {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #cbd5e1;
        padding: 8px 10px;
        font-family: inherit;
        font-size: 14px;
        resize: vertical;
      }
      #case-modal-internal-note:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }
      tr.case-row {
        cursor: pointer;
      }
      tr.case-row:hover {
        background: #eef2ff;
      }

      @media (max-width: 640px) {
        header {
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
        }
        main {
          margin-top: 12px;
        }
      }
    
      .filters-row {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn-ghost {
        background: transparent;
        color: #0f172a;
        border: 1px solid #cbd5f5;
      }
      .btn-ghost.active {
        background: #1d4ed8;
        color: #ffffff;
        border-color: #1d4ed8;
      }

      .filters-row {
        margin: 12px 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .btn-ghost {
        background: transparent;
        color: #0f172a;
        border: 1px solid #cbd5f5;
      }
      .btn-ghost .filter-counter {
        margin-left: 4px;
        font-size: 12px;
        opacity: 0.8;
      }
      .btn-ghost.active {
        border-color: #1d4ed8;
      }
      .case-filter-btn[data-filter="all"].active {
        background: #e5e7eb;
        color: #111827;
      }
      .case-filter-btn[data-filter="new"].active {
        background: #fee2e2;
        color: #b91c1c;
      }
      .case-filter-btn[data-filter="in_progress"].active {
        background: #fef9c3;
        color: #92400e;
      }
      .case-filter-btn[data-filter="done"].active {
        background: #dcfce7;
        color: #166534;
      }
      .status-row-new td {
        background: var(--case-row-bg-new, #fef2f2);
      }
      .status-row-in_progress td {
        background: var(--case-row-bg-in_progress, #fffbeb);
      }
      .status-row-done td {
        background: var(--case-row-bg-done, #ecfdf3);
      }

      .summary-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 12px 0;
      }
      .summary-card {
        flex: 1 1 140px;
        padding: 8px 12px;
        border-radius: 12px;
        background: #f3f4f6;
        font-size: 13px;
      }
      .summary-card-label {
        display: block;
        font-size: 11px;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 2px;
      }
      .summary-card-value {
        font-weight: 600;
        font-size: 14px;
      }
      .summary-card.income {
        background: #ecfdf3;
      }
      .summary-card.expense {
        background: #fef2f2;
      }
      .summary-card.net {
        background: #eff6ff;
      }
      .transaction-row-income td {
        background: #f0fdf4;
      }
      .transaction-row-expense td {
        background: #fef2f2;
      }


      .case-tasks-form {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
      }

      .case-tasks-form input {
        flex: 1;
        border-radius: 6px;
        border: 1px solid #cbd5e1;
        padding: 6px 8px;
        font-family: inherit;
        font-size: 14px;
      }

      .case-tasks-form input:focus {
        outline: none;
        border-color: #0ea5e9;
        box-shadow: 0 0 0 1px rgba(14, 165, 233, 0.25);
      }

      .case-tasks-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .case-task-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .case-task-item input[type='checkbox'] {
        margin: 0;
      }

      .case-task-done {
        text-decoration: line-through;
        opacity: 0.6;
      }

      .case-task-delete-btn {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 14px;
        padding: 0 4px;
        color: #64748b;
      }

      .case-task-delete-btn:hover {
        color: #ef4444;
      }

      .case-tasks-empty {
        font-size: 13px;
        color: #94a3b8;
      }

      .config-panel {
        margin-top: 16px;
        padding: 12px;
        border-radius: 8px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
      }

      .config-panel-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #0f172a;
      }

      .config-panel-subtitle {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 8px;
      }

      .config-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 8px;
      }

      .config-table th,
      .config-table td {
        font-size: 13px;
        padding: 4px 6px;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
        vertical-align: middle;
      }

      .config-table input[type="text"] {
        width: 100%;
        padding: 4px 6px;
        font-size: 13px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }

      .config-table input[type="color"] {
        width: 48px;
        height: 24px;
        padding: 0;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: transparent;
      }

      .config-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
      }
</style>
  </head>
  <body>
    <div class="app-shell">
      <header>
        <h1>Mini CRM Admin</h1>
        <div class="user-info" id="user-info">Не авторизовано</div>
      </header>
      <main>
        <div class="card" id="login-card">
          <h2 class="login-title">Вхід до CRM</h2>
          <form id="login-form">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" autocomplete="username" required />
            </div>
            <div class="field">
              <label for="password">Пароль</label>
              <input id="password" name="password" type="password" autocomplete="current-password" required />
            </div>
            <div class="login-actions">
              <button type="submit" id="login-btn">Увійти</button>
              <button type="button" class="btn-secondary" id="logout-btn" style="display:none;">Вийти</button>
            </div>
            <div class="status" id="login-status"></div>
          </form>
        </div>

        <div class="card" id="data-card" style="margin-top: 16px; display:none;">
          <div class="tabs">
            <button class="tab-btn active" data-tab="cases">Звернення (Cases)</button>
            <button class="tab-btn" data-tab="contacts">Контакти (Contacts)</button>
            <button class="tab-btn" data-tab="transactions">Фінанси (Transactions)</button>
          </div>

          <div id="cases-view">
            <div class="muted">Показуються останні звернення по поточному проєкту користувача.</div>
            <div class="filters-row">
              <button class="btn btn-secondary btn-ghost case-filter-btn active" data-filter="all">
                Усі <span class="filter-counter" data-counter-for="all">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="new">
                New <span class="filter-counter" data-counter-for="new">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="in_progress">
                In progress <span class="filter-counter" data-counter-for="in_progress">0</span>
              </button>
              <button class="btn btn-secondary btn-ghost case-filter-btn" data-filter="done">
                Done <span class="filter-counter" data-counter-for="done">0</span>
              </button>
            </div>

            <div class="filters-row" style="margin-top: 8px;">
              <button type="button" id="open-case-status-config">
                Налаштування статусів звернень
              </button>
              <button type="button" id="open-notifications-config" style="margin-left: 8px;">
                Налаштування сповіщень
              </button>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Статус</th>
                    <th>Заголовок</th>
                    <th>Контакт</th>
                    <th>Джерело</th>
                    <th>Створено</th>
                    <th>Нотатки</th>
                  </tr>
                </thead>
                <tbody id="cases-tbody">
                  <tr><td colspan="6" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>

          </div>

          <div id="contacts-view" style="display:none;">
            <div class="muted">Контакти, привʼязані до поточного проєкту користувача.</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Імʼя</th>
                    <th>Email</th>
                    <th>Телефон</th>
                    <th>Створено</th>
                  </tr>
                </thead>
                <tbody id="contacts-tbody">
                  <tr><td colspan="4" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>

          </div>

          <div id="transactions-view" style="display:none; padding:16px 0; min-height:260px; background:#f9fafb;">
            <h2 id="transactions-main-title" style="margin:0 0 8px 0;font-size:18px;">Фінанси по проєкту</h2>
            <div class="muted">Фінансові операції по поточному проєкту користувача.</div>

            <div id="transactions-debug" class="muted" style="margin-top:4px; color:#b91c1c; font-weight:600;"></div>

            <div class="filters-row" style="margin-top: 8px;">
              <div id="transactions-count" class="muted" style="margin-top:4px;"></div>
              <div class="filter-group">
                <label for="tx-type-filter" class="muted">Тип</label>
                <select id="tx-type-filter" class="form-control" style="min-width: 140px;">
                  <option value="">Усі</option>
                  <option value="income">Доходи</option>
                  <option value="expense">Витрати</option>
                </select>
              </div>
              <div class="filter-group">
                <label for="tx-category-filter" class="muted">Категорія</label>
                <input id="tx-category-filter" class="form-control" type="text" placeholder="Напр. donation" />
              </div>
            </div>

            <div class="filters-row">
              <div class="filter-group">
                <label for="tx-date-from" class="muted">Від дати</label>
                <input id="tx-date-from" class="form-control" type="date" />
              </div>
              <div class="filter-group">
                <label for="tx-date-to" class="muted">До дати</label>
                <input id="tx-date-to" class="form-control" type="date" />
              </div>
              <div class="filter-group">
                <label for="tx-min-amount" class="muted">Сума від</label>
                <input id="tx-min-amount" class="form-control" type="number" step="0.01" />
              </div>
              <div class="filter-group">
                <label for="tx-max-amount" class="muted">Сума до</label>
                <input id="tx-max-amount" class="form-control" type="number" step="0.01" />
              </div>
              <div class="filter-group" style="align-self:flex-end;">
                <button id="tx-apply-filters" class="btn btn-secondary">Застосувати</button>
              </div>
            </div>

            <div class="summary-row">
              <div class="summary-card income">
                <span class="summary-card-label">Разом доходи</span>
                <span class="summary-card-value" id="summary-income">—</span>
              </div>
              <div class="summary-card expense">
                <span class="summary-card-label">Разом витрати</span>
                <span class="summary-card-value" id="summary-expense">—</span>
              </div>
              <div class="summary-card net">
                <span class="summary-card-label">Баланс</span>
                <span class="summary-card-value" id="summary-net">—</span>
              </div>
            </div>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Дата</th>
                    <th>Тип</th>
                    <th>Сума</th>
                    <th>Категорія</th>
                    <th>Опис</th>
                    <th>Контакт</th>
                    <th>Кейс</th>
                  </tr>
                </thead>
                <tbody id="transactions-tbody">
                  <tr><td colspan="7" class="muted">Немає даних</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          </div>
        </div>

        <div class="modal-backdrop" id="case-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2 id="case-modal-title">Кейс</h2>
              <button type="button" class="btn-secondary" id="case-modal-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div class="field">
                <label>Статус</label>
                <span class="pill" id="case-modal-status"></span>
              </div>
              <div class="field">
                <label>Заголовок</label>
                <div id="case-modal-main-title"></div>
              </div>
              <div class="field">
                <label>Опис (з форми)</label>
                <div class="muted" id="case-modal-description"></div>
              </div>
              <div class="field">
                <label>Контакт</label>
                <div id="case-modal-contact"></div>
              </div>
              <div class="field">
                <label>Джерело</label>
                <div id="case-modal-source"></div>
              </div>
              <div class="field">
                <label>Внутрішні нотатки</label>
                <textarea id="case-modal-internal-note" rows="4" placeholder="Нотатки менеджера по цьому зверненню"></textarea>
              </div>
              <div class="field">
                <label>Tasks</label>
                <form id="case-tasks-form" class="case-tasks-form">
                  <input
                    id="case-task-input"
                    type="text"
                    placeholder="Нова задача…"
                    autocomplete="off"
                  />
                  <button type="submit">Додати</button>
                </form>
                <ul id="case-tasks-list" class="case-tasks-list"></ul>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="case-modal-save">Зберегти</button>
              <button type="button" class="btn-secondary" id="case-modal-cancel">Скасувати</button>
            </div>
          </div>
        </div>

      
        <div class="modal-backdrop" id="case-status-config-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2>Налаштування статусів звернень</h2>
              <button type="button" class="btn-secondary" id="case-status-config-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div id="case-status-config-editor"></div>
            </div>
          </div>
        
                </div>

        <div class="modal-backdrop" id="notifications-config-modal-backdrop" style="display:none;">
          <div class="modal">
            <div class="modal-header">
              <h2>Налаштування сповіщень</h2>
              <button type="button" class="btn-secondary" id="notifications-config-close">Закрити</button>
            </div>
            <div class="modal-body">
              <div class="config-panel">
                <label>
                  Email-адреси для сповіщень
                  <span class="muted">(через кому)</span>
                  <input type="text" id="notifications-emails-input" placeholder="you@example.com, other@example.com" />
                </label>
                <div class="config-grid">
                  <label class="badge">
                    <input type="checkbox" id="notify-on-lead" />
                    <span>Надсилати сповіщення про ліди</span>
                  </label>
                  <label class="badge">
                    <input type="checkbox" id="notify-on-donation" />
                    <span>Надсилати сповіщення про пожертвування</span>
                  </label>
                  <label class="badge">
                    <input type="checkbox" id="notify-on-booking" />
                    <span>Надсилати сповіщення про бронювання</span>
                  </label>
                  <label class="badge">
                    <input type="checkbox" id="notify-on-feedback" />
                    <span>Надсилати сповіщення про відгуки</span>
                  </label>
                </div>
                <div class="config-actions">
                  <button type="button" id="notifications-config-save">Зберегти сповіщення</button>
                  <span id="notifications-config-status" class="muted"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
</div>

</main>
    </div>

    <script>
      (function () {
        var apiBase = window.location.origin;
        var tokenKey = 'mini-crm-admin-token';

        var DEFAULT_CASE_STATUS_CONFIG = [
          { code: 'new', label: 'New', rowBg: '#fef2f2' },
          { code: 'in_progress', label: 'In progress', rowBg: '#fffbeb' },
          { code: 'done', label: 'Done', rowBg: '#ecfdf3' },
        ];

        var CASE_STATUSES = DEFAULT_CASE_STATUS_CONFIG.map(function (s) { return s.code; });
        var caseStatusConfigMap = {};
        DEFAULT_CASE_STATUS_CONFIG.forEach(function (s) {
          caseStatusConfigMap[s.code] = s;
        });

        var currentProjectConfig = null;

        function getCaseStatusMeta(code) {
          return caseStatusConfigMap[code] || null;
        }

        function applyProjectConfigFromServer(config) {
          try {
            if (!config || !Array.isArray(config.caseStatuses) || !config.caseStatuses.length) {
              return;
            }
            currentProjectConfig = config;
            var map = {};
            var codes = [];
            config.caseStatuses.forEach(function (item) {
              if (!item || !item.code) return;
              var code = String(item.code);
              var base = caseStatusConfigMap[code] || { code: code };
              map[code] = {
                code: code,
                label: item.label || base.label || code,
                rowBg: item.rowBg || base.rowBg || '',
              };
              codes.push(code);
            });
            if (!codes.length) return;
            CASE_STATUSES = codes;
            caseStatusConfigMap = map;
            updateCaseStatusCssFromConfig();
            updateCaseFiltersLabels();
            // Перерендеримо кейси з оновленими статусами, якщо вони вже завантажені
            if (typeof renderCases === 'function') {
              renderCases(lastCases);
            }
            if (typeof renderCaseStatusConfigEditor === 'function') {
              renderCaseStatusConfigEditor();
            }
          } catch (e) {
            console.error('Failed to apply project config', e);
          }
        }

        function updateCaseStatusCssFromConfig() {
          try {
            var root = document.documentElement;
            if (!root || !caseStatusConfigMap) return;
            Object.keys(caseStatusConfigMap).forEach(function (code) {
              var meta = caseStatusConfigMap[code];
              if (!meta || !meta.rowBg) return;
              var varName = '--case-row-bg-' + code;
              root.style.setProperty(varName, meta.rowBg);
            });
          } catch (e) {
            console.error('Failed to update case status CSS vars', e);
          }
        }


        function escapeHtml(str) {
          if (str === null || str === undefined) return '';
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
        }

        function normalizeColor(value) {
          if (!value) return '#ffffff';
          var v = String(value).trim();
          if (/^#[0-9a-fA-F]{3}$/.test(v) || /^#[0-9a-fA-F]{6}$/.test(v)) {
            return v;
          }
          return '#ffffff';
        }

        function renderCaseStatusConfigEditor() {
          var container = document.getElementById('case-status-config-editor');
          if (!container) return;

          var codes = (CASE_STATUSES || []).slice();
          if (!codes.length) {
            container.innerHTML = '<div class="config-panel"><div class="config-panel-title">Налаштування статусів</div><div class="config-panel-subtitle">Статуси ще не завантажені.</div></div>';
            return;
          }

          var html = '';
          html += '<div class="config-panel">';
          html += '<div class="config-panel-title">Налаштування статусів звернень</div>';
          html += '<div class="config-panel-subtitle">Тут можна змінити назви та кольори статусів. Коди статусів фіксовані.</div>';
          html += '<table class="config-table"><thead><tr><th>Код</th><th>Назва (label)</th><th>Колір рядка</th></tr></thead><tbody>';

          codes.forEach(function (code) {
            var meta = getCaseStatusMeta(code) || { code: code };
            var label = meta.label || code;
            var rowBg = normalizeColor(meta.rowBg || '#ffffff');
            html += '<tr data-status-code="' + code + '">';
            html += '<td>' + escapeHtml(code) + '</td>';
            html += '<td><input type="text" class="status-label-input" value="' + escapeHtml(label) + '"/></td>';
            html += '<td><input type="color" class="status-color-input" value="' + rowBg + '"/></td>';
            html += '</tr>';
          });

          html += '</tbody></table>';
          html += '<div class="config-actions">';
          html += '<button type="button" class="btn btn-primary" id="save-case-status-config-btn">Зберегти статуси</button>';
          html += '<div id="case-status-config-status" class="status" style="margin-left:4px;"></div>';
          html += '</div>';
          html += '</div>';

          container.innerHTML = html;

          var saveBtn = document.getElementById('save-case-status-config-btn');
          if (saveBtn) {
            saveBtn.addEventListener('click', function () {
              saveCaseStatusConfig();
            });
          }
        }

        function saveCaseStatusConfig() {
          var container = document.getElementById('case-status-config-editor');
          if (!container) return;

          var statusEl = document.getElementById('case-status-config-status');
          function setStatus(msg, isError) {
            if (!statusEl) return;
            statusEl.textContent = msg || '';
            statusEl.style.color = isError ? '#b91c1c' : '#15803d';
          }

          var rows = container.querySelectorAll('tbody tr[data-status-code]');
          if (!rows || !rows.length) {
            setStatus('Немає рядків для збереження', true);
            return;
          }

          var items = [];
          rows.forEach(function (row) {
            var code = row.getAttribute('data-status-code');
            if (!code) return;
            var labelInput = row.querySelector('.status-label-input');
            var colorInput = row.querySelector('.status-color-input');
            var label = labelInput && labelInput.value ? labelInput.value.trim() : code;
            var color = colorInput && colorInput.value ? normalizeColor(colorInput.value) : '#ffffff';
            items.push({
              code: code,
              label: label || code,
              rowBg: color,
            });
          });

          if (!items.length) {
            setStatus('Немає валідних статусів для збереження', true);
            return;
          }

          // Локально оновлюємо конфіг перед запитом, щоб рядки одразу змінювали колір
          try {
            var map = {};
            var codes = [];
            items.forEach(function (item) {
              var base = caseStatusConfigMap[item.code] || { code: item.code };
              map[item.code] = {
                code: item.code,
                label: item.label || base.label || item.code,
                rowBg: item.rowBg || base.rowBg || '',
              };
              codes.push(item.code);
            });
            if (codes.length) {
              CASE_STATUSES = codes;
              caseStatusConfigMap = map;
              updateCaseStatusCssFromConfig();
              if (typeof updateCaseFiltersLabels === 'function') {
                updateCaseFiltersLabels();
              }
              if (typeof renderCases === 'function') {
                renderCases(lastCases);
              }
            }
          } catch (e) {
            console.error('Failed to apply local case status config', e);
          }

          setStatus('Збереження...', false);

          authedFetch('/projects/current/config', {
            method: 'PATCH',
            body: JSON.stringify({ caseStatuses: items }),
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to save config');
              }
              return res.json();
            })
            .then(function (data) {
              if (data && data.config) {
                applyProjectConfigFromServer(data.config);
              }
              setStatus('Збережено', false);
            })
            .catch(function (err) {
              console.error('Failed to save case status config', err);
              setStatus('Помилка збереження', true);
            });
        }

function updateCaseFiltersLabels() {
          var buttons = document.querySelectorAll('.case-filter-btn');
          if (!buttons || !buttons.length) return;
          buttons.forEach(function (btn) {
            var filter = btn.getAttribute('data-filter');
            if (!filter || filter === 'all') return;
            var meta = getCaseStatusMeta(filter);
            if (!meta || !meta.label) return;
            // ожидаем структуру: "Label <span class='filter-counter'>N</span>"
            var firstNode = btn.firstChild;
            if (firstNode && firstNode.nodeType === Node.TEXT_NODE) {
              firstNode.nodeValue = meta.label + ' ';
            }
          });
        }

var currentCaseFilter = 'all';
        var caseFilterButtons = Array.prototype.slice.call(document.querySelectorAll('.case-filter-btn'));
        console.log('mini-crm admin: filters found', caseFilterButtons.length);

        if (caseFilterButtons && caseFilterButtons.length) {
          caseFilterButtons.forEach(function (btn) {
            btn.addEventListener('click', function () {
              var value = btn.getAttribute('data-filter') || 'all';
              caseFilterButtons.forEach(function (b) {
                b.classList.toggle('active', b === btn);
              });
              applyCaseFilter(value);
            });
          });
        }

        function applyCaseFilter(filter) {
          if (typeof filter === 'string') {
            currentCaseFilter = filter;
          }
          renderCases(lastCases);
        }


        var loginForm = document.getElementById('login-form');
        var loginBtn = document.getElementById('login-btn');
        var logoutBtn = document.getElementById('logout-btn');
        var loginStatus = document.getElementById('login-status');
        var userInfoEl = document.getElementById('user-info');
        var dataCard = document.getElementById('data-card');
        var casesTbody = document.getElementById('cases-tbody');
        var contactsTbody = document.getElementById('contacts-tbody');
        var loginCard = document.getElementById('login-card');
        var tabs = document.querySelectorAll('.tab-btn');
        var casesView = document.getElementById('cases-view');
        var contactsView = document.getElementById('contacts-view');
        var transactionsView = document.getElementById('transactions-view');
        var transactionsTbody = document.getElementById('transactions-tbody');
        var transactionsCountEl = document.getElementById('transactions-count');
        var transactionsDebugEl = document.getElementById('transactions-debug');

        var txTypeFilter = document.getElementById('tx-type-filter');
        var txCategoryFilter = document.getElementById('tx-category-filter');
        var txDateFromFilter = document.getElementById('tx-date-from');
        var txDateToFilter = document.getElementById('tx-date-to');
        var txMinAmountFilter = document.getElementById('tx-min-amount');
        var txMaxAmountFilter = document.getElementById('tx-max-amount');
        var txApplyFiltersBtn = document.getElementById('tx-apply-filters');

        var summaryIncomeEl = document.getElementById('summary-income');
        var summaryExpenseEl = document.getElementById('summary-expense');
        var summaryNetEl = document.getElementById('summary-net');

        var caseModalBackdrop = document.getElementById('case-modal-backdrop');
        var caseModalClose = document.getElementById('case-modal-close');
        var caseModalCancel = document.getElementById('case-modal-cancel');
        var caseModalSave = document.getElementById('case-modal-save');
        var caseModalTitle = document.getElementById('case-modal-title');
        var caseModalMainTitle = document.getElementById('case-modal-main-title');
        var caseModalStatusEl = document.getElementById('case-modal-status');
        var caseModalDescription = document.getElementById('case-modal-description');
        var caseModalContact = document.getElementById('case-modal-contact');
        var caseModalSource = document.getElementById('case-modal-source');
        var caseModalInternalNote = document.getElementById('case-modal-internal-note');
        var caseStatusConfigModalBackdrop = document.getElementById('case-status-config-modal-backdrop');
        var caseStatusConfigClose = document.getElementById('case-status-config-close');
        var openCaseStatusConfigBtn = document.getElementById('open-case-status-config');

        var notificationsConfigModalBackdrop = document.getElementById('notifications-config-modal-backdrop');
        var notificationsConfigClose = document.getElementById('notifications-config-close');
        var notificationsConfigSave = document.getElementById('notifications-config-save');
        var notificationsEmailsInput = document.getElementById('notifications-emails-input');
        var notifyOnLeadCheckbox = document.getElementById('notify-on-lead');
        var notifyOnDonationCheckbox = document.getElementById('notify-on-donation');
        var notifyOnBookingCheckbox = document.getElementById('notify-on-booking');
        var notifyOnFeedbackCheckbox = document.getElementById('notify-on-feedback');
        var openNotificationsConfigBtn = document.getElementById('open-notifications-config');
        var notificationsConfigStatus = document.getElementById('notifications-config-status');

        var currentCaseId = null;
        var currentCaseInitialInternalNote = '';
        var lastCases = [];
        var lastTransactions = [];
        var caseTasksForm = document.getElementById('case-tasks-form');
        var caseTaskInput = document.getElementById('case-task-input');
        var caseTasksList = document.getElementById('case-tasks-list');
        var currentCaseTasks = [];



        function setStatus(message, isError) {
          loginStatus.textContent = message || '';
          loginStatus.className = 'status' + (isError ? ' error' : message ? ' ok' : '');
        }

        function setUserInfo(user) {
          if (!user) {
            userInfoEl.textContent = 'Не авторизовано';
            return;
          }
          userInfoEl.textContent =
            user.email + ' · роль: ' + user.role + ' · проєкт #' + user.projectId;
        }

        function getToken() {
          return window.localStorage.getItem(tokenKey);
        }

        function setToken(token) {
          if (token) {
            window.localStorage.setItem(tokenKey, token);
          } else {
            window.localStorage.removeItem(tokenKey);
          }
        }

        function authedFetch(path, options) {
          var token = getToken();
          if (!token) {
            return Promise.reject(new Error('No token'));
          }
          var headers = Object.assign(
            { 'Content-Type': 'application/json' },
            (options && options.headers) || {}
          );
          headers['Authorization'] = 'Bearer ' + token;
          return fetch(apiBase + path, Object.assign({}, options, { headers: headers }));
        }

        function formatDate(iso) {
          if (!iso) return '';
          try {
            var d = new Date(iso);
            if (Number.isNaN(d.getTime())) return iso;
            return d.toLocaleString();
          } catch (e) {
            return iso;
          }
        }


        
        function formatCurrency(amount, currency) {
          if (amount == null || Number.isNaN(Number(amount))) return '';
          var value = Number(amount);
          var cur = currency || '';
          var formatted = value.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
          return cur ? (formatted + ' ' + cur) : formatted;
        }

function formatContactForModal(contact) {
          if (!contact) return '<span class="muted">нема даних</span>';
          var parts = [];
          if (contact.name) parts.push(contact.name);
          if (contact.email) parts.push(contact.email);
          if (contact.phone) parts.push(contact.phone);
          if (parts.length === 0) return '<span class="muted">нема даних</span>';
          return parts.join(' · ');
        }

        function renderCases(cases) {
          lastCases = Array.isArray(cases) ? cases : [];
          var list = lastCases;

          // лічильники по статусам
          var counts = { all: lastCases.length };
          CASE_STATUSES.forEach(function (code) {
            counts[code] = 0;
          });
          lastCases.forEach(function (c) {
            var st = c.status || 'new';
            if (typeof counts[st] === 'undefined') {
              counts[st] = 0;
            }
            counts[st]++;
          });

          if (caseFilterButtons && caseFilterButtons.length) {
            caseFilterButtons.forEach(function (btn) {
              var f = btn.getAttribute('data-filter') || 'all';
              var span = btn.querySelector('.filter-counter[data-counter-for="' + f + '"]');
              if (span) {
                var value = f === 'all' ? counts.all : (counts[f] || 0);
                span.textContent = value;
              }
            });
          }

          if (currentCaseFilter && currentCaseFilter !== 'all') {
            list = list.filter(function (c) {
              var status = c.status || 'new';
              return status === currentCaseFilter;
            });
          }

          if (!Array.isArray(list) || list.length === 0) {
            casesTbody.innerHTML = '<tr><td colspan="6" class="muted">Немає даних</td></tr>';
            return;
          }

          var rows = list
            .map(function (c) {
              var contact = c.contact || {};
              var contactStr =
                [contact.name, contact.email, contact.phone].filter(Boolean).join(' · ') ||
                '<span class="muted">нема даних</span>';
              var status = c.status || 'new';
              var source = c.source || '–';

              var statuses = CASE_STATUSES.slice();
              if (status && statuses.indexOf(status) === -1) {
                statuses.push(status);
              }

              var selectHtml =
                '<select class="status-select" data-case-id="' +
                c.id +
                '">' +
                statuses
                  .map(function (s) {
                    var selected = s === status ? ' selected' : '';
                    var metaForOption = getCaseStatusMeta(s);
                    var label = metaForOption && metaForOption.label ? metaForOption.label : s;
                    return '<option value="' + s + '"' + selected + '>' + label + '</option>';
                  })
                  .join('') +
                '</select>';

              var notePreview = c.internalNote ? 'є' : '—';
              var rowClass = 'status-row-' + status;
              var meta = getCaseStatusMeta(status);
              var rowStyle = meta && meta.rowBg ? ' style="background:' + meta.rowBg + ';"' : '';

              return (
                '<tr class="case-row ' +
                rowClass +
                '" data-case-id="' +
                c.id +
                '"' +
                rowStyle +
                '>' +
                '<td>' + selectHtml + '</td>' +
                '<td>' +
                (c.title || '') +
                (c.description ? '<div class="muted">' + c.description + '</div>' : '') +
                '</td>' +
                '<td>' + contactStr + '</td>' +
                '<td><span class="pill">' + source + '</span></td>' +
                '<td>' + formatDate(c.createdAt) + '</td>' +
                '<td>' + notePreview + '</td>' +
                '</tr>'
              );
            })
            .join('');

          casesTbody.innerHTML = rows;

          var selects = casesTbody.querySelectorAll('.status-select');
          var rowsEls = casesTbody.querySelectorAll('tr.case-row');
          rowsEls.forEach(function (row) {
            row.addEventListener('click', function (e) {
              if (e.target && e.target.closest && e.target.closest('.status-select')) {
                return;
              }
              var idAttr = row.getAttribute('data-case-id');
              if (!idAttr) return;
              var id = Number(idAttr);
              if (!Number.isFinite(id)) return;
              openCaseModal(id);
            });
          });

          selects.forEach(function (select) {
            select.addEventListener('change', function () {
              var idAttr = select.getAttribute('data-case-id');
              if (!idAttr) return;
              var id = Number(idAttr);
              var newStatus = select.value;
              if (!Number.isFinite(id) || !newStatus) return;

              setStatus('Оновлення статусу кейсу...', false);
              authedFetch('/cases/' + id, {
                method: 'PATCH',
                body: JSON.stringify({ status: newStatus }),
              })
                .then(function (res) {
                  if (!res.ok) {
                    return res
                      .json()
                      .catch(function () { return { error: 'Failed to update case' }; })
                      .then(function (data) {
                        throw new Error(data.error || 'Failed to update case');
                      });
                  }
                  return res.json();
                })
                .then(function (updated) {
                  if (!Array.isArray(lastCases)) return;
                  lastCases = lastCases.map(function (c) {
                    return c.id === updated.id ? updated : c;
                  });
                  renderCases(lastCases);
                  setStatus('Статус кейсу оновлено', false);
                })
                .catch(function (err) {
                  console.error('Failed to update case', err);
                  setStatus(err.message || 'Не вдалося оновити кейс', true);
                });
            });
          });
        }

function renderContacts(contacts) {
          if (!Array.isArray(contacts) || contacts.length === 0) {
            contactsTbody.innerHTML = '<tr><td colspan="4" class="muted">Немає даних</td></tr>';
            return;
          }
          var rows = contacts
            .map(function (c) {
              return (
                '<tr>' +
                '<td>' + (c.name || '<span class="muted">Без імені</span>') + '</td>' +
                '<td>' + (c.email || '<span class="muted">–</span>') + '</td>' +
                '<td>' + (c.phone || '<span class="muted">–</span>') + '</td>' +
                '<td>' + formatDate(c.createdAt) + '</td>' +
                '</tr>'
              );
            })
            .join('');
          contactsTbody.innerHTML = rows;
        }

        
        function renderTransactions(transactions) {
          console.log('renderTransactions called, items:', Array.isArray(transactions) ? transactions.length : 'not array');
          lastTransactions = Array.isArray(transactions) ? transactions : [];
          if (transactionsDebugEl) {
            transactionsDebugEl.textContent = 'DEBUG: отримано ' + lastTransactions.length + ' транзакцій';
          }

          if (!transactionsTbody) return;

                    if (transactionsCountEl) { transactionsCountEl.textContent = 'Всього ' + lastTransactions.length + ' транзакцій'; }

          if (!Array.isArray(lastTransactions) || lastTransactions.length === 0) {
            if (transactionsCountEl) { transactionsCountEl.textContent = 'Немає транзакцій'; }
            transactionsTbody.innerHTML = '<tr><td colspan="7" class="muted">Немає даних</td></tr>';
            return;
          }

          var rows = lastTransactions
            .map(function (t) {
              var type = t.type || '';
              var rowClass = '';
              if (type === 'income') rowClass = 'transaction-row-income';
              else if (type === 'expense') rowClass = 'transaction-row-expense';

              var amountStr = formatCurrency(t.amount, t.currency);
              var typeLabel = type === 'income' ? 'Доходи' : (type === 'expense' ? 'Витрати' : type || '—');
              var category = t.category || '—';
              var description = t.description || '';
              var dateValue = t.happenedAt || t.createdAt;

              var contactStr = '<span class="muted">—</span>';
              if (t.contact) {
                var parts = [];
                if (t.contact.name) parts.push(t.contact.name);
                if (t.contact.email) parts.push('(' + t.contact.email + ')');
                contactStr = parts.join(' ') || '<span class="muted">—</span>';
              }

              var caseStr = '<span class="muted">—</span>';
              if (t.case) {
                var base = '#' + t.case.id;
                if (t.case.title) base += ': ' + t.case.title;
                caseStr = base;
              }

              return (
                '<tr class="' + rowClass + '">' +
                '<td>' + formatDate(dateValue) + '</td>' +
                '<td>' + typeLabel + '</td>' +
                '<td>' + amountStr + '</td>' +
                '<td>' + category + '</td>' +
                '<td>' + (description || '<span class="muted">—</span>') + '</td>' +
                '<td>' + contactStr + '</td>' +
                '<td>' + caseStr + '</td>' +
                '</tr>'
              );
            })
            .join('');

          transactionsTbody.innerHTML = rows;
        }

        function renderTransactionsSummary(summary) {
          if (!summary) {
            if (summaryIncomeEl) summaryIncomeEl.textContent = '—';
            if (summaryExpenseEl) summaryExpenseEl.textContent = '—';
            if (summaryNetEl) summaryNetEl.textContent = '—';
            return;
          }

          var totalIncome = Number(summary.totalIncome || 0);
          var totalExpense = Number(summary.totalExpense || 0);
          var net = Number(summary.net || 0);

          if (summaryIncomeEl) summaryIncomeEl.textContent = formatCurrency(totalIncome);
          if (summaryExpenseEl) summaryExpenseEl.textContent = formatCurrency(totalExpense);
          if (summaryNetEl) summaryNetEl.textContent = formatCurrency(net);
        }

        function loadProjectConfig() {
          return authedFetch('/projects/current')
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to load project');
              }
              return res.json();
            })
            .then(function (data) {
              if (data && data.config) {
                applyProjectConfigFromServer(data.config);
              }
            })
            .catch(function (err) {
              console.error('Failed to load project config', err);
            });
        }

function loadData() {
          Promise.all([
            authedFetch('/cases').then(function (res) {
              if (!res.ok) throw new Error('Failed to load cases');
              return res.json();
            }),
            authedFetch('/contacts').then(function (res) {
              if (!res.ok) throw new Error('Failed to load contacts');
              return res.json();
            }),
            authedFetch('/transactions').then(function (res) {
              if (!res.ok) throw new Error('Failed to load transactions');
              return res.json();
            }),
            authedFetch('/transactions/summary').then(function (res) {
              if (!res.ok) throw new Error('Failed to load transaction summary');
              return res.json();
            }),
          ])
            .then(function (results) {
              renderCases(results[0]);
              renderContacts(results[1]);
              renderTransactions(results[2]);
              renderTransactionsSummary(results[3]);
            })
            .catch(function (err) {
              console.error('Failed to load data', err);
              setStatus('Не вдалося завантажити дані. Перевірте токен / права доступу.', true);
            });
        }

        
        function buildTransactionsQueryFromFilters() {
          var params = [];

          if (txTypeFilter && txTypeFilter.value) {
            params.push('type=' + encodeURIComponent(txTypeFilter.value));
          }
          if (txCategoryFilter && txCategoryFilter.value) {
            params.push('category=' + encodeURIComponent(txCategoryFilter.value.trim()));
          }
          if (txDateFromFilter && txDateFromFilter.value) {
            params.push('dateFrom=' + encodeURIComponent(txDateFromFilter.value));
          }
          if (txDateToFilter && txDateToFilter.value) {
            params.push('dateTo=' + encodeURIComponent(txDateToFilter.value));
          }
          if (txMinAmountFilter && txMinAmountFilter.value) {
            params.push('minAmount=' + encodeURIComponent(txMinAmountFilter.value));
          }
          if (txMaxAmountFilter && txMaxAmountFilter.value) {
            params.push('maxAmount=' + encodeURIComponent(txMaxAmountFilter.value));
          }

          if (!params.length) return '';
          return '?' + params.join('&');
        }

        function reloadTransactionsWithFilters() {
          var query = buildTransactionsQueryFromFilters();
          setStatus('Завантаження транзакцій...', false);

          Promise.all([
            authedFetch('/transactions' + query).then(function (res) {
              if (!res.ok) throw new Error('Failed to load transactions');
              return res.json();
            }),
            authedFetch('/transactions/summary' + query).then(function (res) {
              if (!res.ok) throw new Error('Failed to load transaction summary');
              return res.json();
            }),
          ])
            .then(function (results) {
              renderTransactions(results[0]);
              renderTransactionsSummary(results[1]);
              setStatus('Дані оновлено', false);
            })
            .catch(function (err) {
              console.error('Failed to load filtered transactions', err);
              setStatus('Не вдалося завантажити транзакції', true);
            });
        }

        if (txApplyFiltersBtn) {
          txApplyFiltersBtn.addEventListener('click', function () {
            reloadTransactionsWithFilters();
          });
        }

tabs.forEach(function (btn) {
          btn.addEventListener('click', function () {
            tabs.forEach(function (b) { b.classList.remove('active'); });
            btn.classList.add('active');

            var tab = btn.getAttribute('data-tab');
            if (tab === 'cases') {
              if (casesView) casesView.style.display = '';
              if (contactsView) contactsView.style.display = 'none';
              if (transactionsView) transactionsView.style.display = 'none';
            } else if (tab === 'contacts') {
              if (casesView) casesView.style.display = 'none';
              if (contactsView) contactsView.style.display = '';
              if (transactionsView) transactionsView.style.display = 'none';
            } else if (tab === 'transactions') {
              if (casesView) casesView.style.display = 'none';
              if (contactsView) contactsView.style.display = 'none';
              if (transactionsView) {
                transactionsView.style.display = '';
                try {
                  transactionsView.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } catch (e) {}
              }
              // При переключенні на вкладку "Фінанси" завжди оновлюємо транзакції
              reloadTransactionsWithFilters();
            }
          });
        });

        loginForm.addEventListener('submit', function (e) {
          e.preventDefault();
          setStatus('', false);
          loginBtn.disabled = true;
          var email = (document.getElementById('email')).value;
          var password = (document.getElementById('password')).value;

          fetch(apiBase + '/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, password: password }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res.json().catch(function () {
                  return { error: 'Login failed' };
                }).then(function (data) {
                  throw new Error(data.error || 'Login failed');
                });
              }
              return res.json();
            })
            .then(function (data) {
              setToken(data.token);
              setUserInfo(data.user);
              setStatus('Успішний вхід', false);
              dataCard.style.display = '';
              logoutBtn.style.display = 'inline-flex';
              loadProjectConfig().finally(function () {
                loadData();
              });
            })
            .catch(function (err) {
              console.error('Login error', err);
              setToken(null);
              setUserInfo(null);
              dataCard.style.display = 'none';
              logoutBtn.style.display = 'none';
              setStatus(err.message || 'Помилка входу', true);
            })
            .finally(function () {
              loginBtn.disabled = false;
            });
        });

        logoutBtn.addEventListener('click', function () {
          setToken(null);
          setUserInfo(null);
          dataCard.style.display = 'none';
          logoutBtn.style.display = 'none';
          setStatus('Вийшли з системи', false);
        });

        // Try to restore existing token

        function openCaseModal(id) {
          if (!lastCases || !Array.isArray(lastCases)) return;
          var c = lastCases.find(function (item) { return item.id === id; });
          if (!c) return;
          currentCaseId = id;
          caseModalTitle.textContent = 'Кейс #' + id;
          caseModalMainTitle.textContent = c.title || '';
          var modalStatus = c.status || 'new';
          var modalStatusMeta = getCaseStatusMeta(modalStatus);
          caseModalStatusEl.textContent = (modalStatusMeta && modalStatusMeta.label) || modalStatus;
          caseModalDescription.textContent = c.description || '';
          caseModalContact.innerHTML = formatContactForModal(c.contact || null);
          caseModalSource.textContent = c.source || '–';
          currentCaseInitialInternalNote = c.internalNote || '';
          caseModalInternalNote.value = currentCaseInitialInternalNote;
          caseModalBackdrop.style.display = 'flex';

          currentCaseTasks = [];
          renderCaseTasks();
          loadCaseTasks(id);
        }


        function loadCaseTasks(caseId) {
          if (!caseTasksList) return;
          authedFetch('/cases/' + caseId + '/tasks')
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Failed to load tasks');
              }
              return res.json();
            })
            .then(function (data) {
              if (!Array.isArray(data)) {
                currentCaseTasks = [];
              } else {
                currentCaseTasks = data;
              }
              renderCaseTasks();
            })
            .catch(function (err) {
              console.error('Failed to load tasks', err);
              currentCaseTasks = [];
              renderCaseTasks();
            });
        }

        function renderCaseTasks() {
          if (!caseTasksList) return;
          caseTasksList.innerHTML = '';

          if (!currentCaseTasks || currentCaseTasks.length === 0) {
            var emptyLi = document.createElement('li');
            emptyLi.textContent = 'Поки що немає задач.';
            emptyLi.className = 'case-tasks-empty';
            caseTasksList.appendChild(emptyLi);
            return;
          }

          currentCaseTasks.forEach(function (task) {
            var li = document.createElement('li');
            li.className = 'case-task-item';

            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = !!task.done;
            checkbox.addEventListener('change', function () {
              updateTaskDone(task.id, checkbox.checked);
            });

            var span = document.createElement('span');
            span.textContent = task.title || '';
            if (task.done) {
              span.classList.add('case-task-done');
            }

            var delBtn = document.createElement('button');
            delBtn.type = 'button';
            delBtn.textContent = '✕';
            delBtn.className = 'case-task-delete-btn';
            delBtn.addEventListener('click', function () {
              deleteTask(task.id);
            });

            li.appendChild(checkbox);
            li.appendChild(span);
            li.appendChild(delBtn);

            caseTasksList.appendChild(li);
          });
        }

        function addCaseTask(title) {
          if (!currentCaseId) return;
          setStatus('Створення задачі...', false);
          authedFetch('/cases/' + currentCaseId + '/tasks', {
            method: 'POST',
            body: JSON.stringify({ title: title }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to create task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to create task');
                  });
              }
              return res.json();
            })
            .then(function (task) {
              caseTaskInput.value = '';
              currentCaseTasks.push(task);
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу створено', false);
            })
            .catch(function (err) {
              console.error('Failed to create task', err);
              setStatus(err.message || 'Не вдалося створити задачу', true);
            });
        }

        function updateTaskDone(taskId, done) {
          setStatus('Оновлення задачі...', false);
          authedFetch('/tasks/' + taskId, {
            method: 'PATCH',
            body: JSON.stringify({ done: !!done }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update task');
                  });
              }
              return res.json();
            })
            .then(function (updated) {
              currentCaseTasks = currentCaseTasks.map(function (t) {
                return t.id === updated.id ? updated : t;
              });
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу оновлено', false);
            })
            .catch(function (err) {
              console.error('Failed to update task', err);
              setStatus(err.message || 'Не вдалося оновити задачу', true);
            });
        }

        function deleteTask(taskId) {
          setStatus('Видалення задачі...', false);
          authedFetch('/tasks/' + taskId, {
            method: 'DELETE',
          })
            .then(function (res) {
              if (!res.ok && res.status !== 204) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to delete task' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to delete task');
                  });
              }
            })
            .then(function () {
              currentCaseTasks = currentCaseTasks.filter(function (t) {
                return t.id !== taskId;
              });
              renderCaseTasks();
              syncCaseStatusWithTasks();
              setStatus('Задачу видалено', false);
            })
            .catch(function (err) {
              console.error('Failed to delete task', err);
              setStatus(err.message || 'Не вдалося видалити задачу', true);
            });
        }

        function syncCaseStatusWithTasks() {
          if (!currentCaseId || !Array.isArray(currentCaseTasks)) {
            return;
          }

          var nextStatus;
          if (currentCaseTasks.length === 0) {
            // Якщо задач немає — кейс повертається в стан "new"
            nextStatus = 'new';
          } else {
            var anyOpen = currentCaseTasks.some(function (t) { return !t.done; });
            nextStatus = anyOpen ? 'in_progress' : 'done';
          }

          var c = lastCases.find(function (item) { return item.id === currentCaseId; });
          if (!c || c.status === nextStatus) {
            return;
          }

          setStatus('Оновлення статусу кейсу за задачами...', false);
          authedFetch('/cases/' + currentCaseId, {
            method: 'PATCH',
            body: JSON.stringify({ status: nextStatus }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update case status' } })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update case status');
                  });
              }
              return res.json();
            })
            .then(function () {
              c.status = nextStatus;
              var metaAfterTasks = getCaseStatusMeta(nextStatus);
              caseModalStatusEl.textContent = (metaAfterTasks && metaAfterTasks.label) || nextStatus;
              loadData();
              setStatus('Статус кейсу оновлено за задачами', false);
            })
            .catch(function (err) {
              console.error('Failed to auto-update case status', err);
              setStatus(err.message || 'Не вдалося оновити статус кейсу', true);
            });
        }

        function closeCaseModal() {
          currentCaseId = null;
          caseModalBackdrop.style.display = 'none';
        }
        function openCaseStatusConfigModal() {
          if (caseStatusConfigModalBackdrop) {
            caseStatusConfigModalBackdrop.style.display = 'flex';
          }
          if (typeof renderCaseStatusConfigEditor === 'function') {
            renderCaseStatusConfigEditor();
          }
        }

        function closeCaseStatusConfigModal() {
          if (caseStatusConfigModalBackdrop) {
            caseStatusConfigModalBackdrop.style.display = 'none';
          }
        }

        if (openCaseStatusConfigBtn) {
          openCaseStatusConfigBtn.addEventListener('click', function () {
            openCaseStatusConfigModal();
          });
        }
        if (caseStatusConfigClose) {
          caseStatusConfigClose.addEventListener('click', function () {
            closeCaseStatusConfigModal();
          });
        }


        function openNotificationsConfigModal() {
          if (!notificationsConfigModalBackdrop) return;
          notificationsConfigModalBackdrop.style.display = 'flex';
          if (typeof renderNotificationsConfigEditor === 'function') {
            renderNotificationsConfigEditor();
          }
        }

        function closeNotificationsConfigModal() {
          if (!notificationsConfigModalBackdrop) return;
          notificationsConfigModalBackdrop.style.display = 'none';
        }

        function setNotificationsConfigStatus(message, isError) {
          if (!notificationsConfigStatus) return;
          notificationsConfigStatus.textContent = message || '';
          notificationsConfigStatus.style.color = isError ? '#b91c1c' : '#64748b';
        }

        function renderNotificationsConfigEditor() {
          if (!notificationsEmailsInput) return;
          var config = currentProjectConfig || {};
          var notifications = config.notifications || {};
          var emails = Array.isArray(notifications.emails) ? notifications.emails : [];
          if (!emails.length) {
            emails = ['pavlovsergii106@gmail.com'];
          }
          notificationsEmailsInput.value = emails.join(', ');

          var notifyOnLead =
            typeof notifications.notifyOnLead === 'boolean' ? notifications.notifyOnLead : true;
          var notifyOnDonation =
            typeof notifications.notifyOnDonation === 'boolean' ? notifications.notifyOnDonation : true;
          var notifyOnBooking =
            typeof notifications.notifyOnBooking === 'boolean' ? notifications.notifyOnBooking : true;
          var notifyOnFeedback =
            typeof notifications.notifyOnFeedback === 'boolean' ? notifications.notifyOnFeedback : true;

          if (notifyOnLeadCheckbox) notifyOnLeadCheckbox.checked = !!notifyOnLead;
          if (notifyOnDonationCheckbox) notifyOnDonationCheckbox.checked = !!notifyOnDonation;
          if (notifyOnBookingCheckbox) notifyOnBookingCheckbox.checked = !!notifyOnBooking;
          if (notifyOnFeedbackCheckbox) notifyOnFeedbackCheckbox.checked = !!notifyOnFeedback;

          setNotificationsConfigStatus('', false);
        }

        function parseEmails(raw) {
          if (!raw) return [];
          return raw
            .split(/[;,\s]+/)
            .map(function (s) { return s.trim(); })
            .filter(function (s) { return s.length > 0; });
        }

        async function saveNotificationsConfig() {
          if (!notificationsEmailsInput) return;
          setNotificationsConfigStatus('Збереження...', false);

          var emails = parseEmails(notificationsEmailsInput.value);
          var notifyOnLead = notifyOnLeadCheckbox ? !!notifyOnLeadCheckbox.checked : true;
          var notifyOnDonation = notifyOnDonationCheckbox ? !!notifyOnDonationCheckbox.checked : true;
          var notifyOnBooking = notifyOnBookingCheckbox ? !!notifyOnBookingCheckbox.checked : true;
          var notifyOnFeedback = notifyOnFeedbackCheckbox ? !!notifyOnFeedbackCheckbox.checked : true;

          var caseStatusesPayload = CASE_STATUSES.map(function (code) {
            var meta = caseStatusConfigMap[code] || { code: code, label: code };
            return {
              code: code,
              label: meta.label || code,
              rowBg: meta.rowBg || undefined,
            };
          });

          try {
            await authedFetch('/projects/current/config', {
              method: 'PATCH',
              body: JSON.stringify({
                caseStatuses: caseStatusesPayload,
                notifications: {
                  emails: emails,
                  notifyOnLead: notifyOnLead,
                  notifyOnDonation: notifyOnDonation,
                  notifyOnBooking: notifyOnBooking,
                  notifyOnFeedback: notifyOnFeedback,
                },
              }),
            });
            if (!currentProjectConfig) currentProjectConfig = {};
            currentProjectConfig.notifications = {
              emails: emails,
              notifyOnLead: notifyOnLead,
              notifyOnDonation: notifyOnDonation,
              notifyOnBooking: notifyOnBooking,
              notifyOnFeedback: notifyOnFeedback,
            };
            setNotificationsConfigStatus('Збережено', false);
          } catch (err) {
            console.error('Failed to save notifications config', err);
            setNotificationsConfigStatus('Помилка збереження', true);
          }
        }

        if (openNotificationsConfigBtn) {
          openNotificationsConfigBtn.addEventListener('click', function () {
            openNotificationsConfigModal();
          });
        }
        if (notificationsConfigClose) {
          notificationsConfigClose.addEventListener('click', function () {
            closeNotificationsConfigModal();
          });
        }
        if (notificationsConfigSave) {
          notificationsConfigSave.addEventListener('click', function () {
            saveNotificationsConfig();
          });
        }


caseModalClose.addEventListener('click', function () {
                  closeCaseModal();
        });
        caseModalCancel.addEventListener('click', function () {
          if (!currentCaseId) {
            closeCaseModal();
            return;
          }
          // Відкатити внутрішні нотатки до початкового стану
          caseModalInternalNote.value = currentCaseInitialInternalNote || '';
          // Очистити поле введення нової задачі (якщо щось було набрано)
          if (typeof caseTaskInput !== 'undefined' && caseTaskInput) {
            caseTaskInput.value = '';
          }
          setStatus('Зміни скасовано', false);
        });

        // Закривати модальне вікно по Esc
        document.addEventListener('keydown', function (event) {
          if (event.key === 'Escape' || event.key === 'Esc') {
            if (caseModalBackdrop && caseModalBackdrop.style.display === 'flex') {
              closeCaseModal();
            }
          }
        });

// Клік поза модальним вікном більше не закриває його, щоб випадково не втрачати контекст
        caseModalSave.addEventListener('click', function () {
          if (!currentCaseId) return;
          var note = caseModalInternalNote.value || '';
          setStatus('Збереження нотаток кейсу...', false);
          authedFetch('/cases/' + currentCaseId, {
            method: 'PATCH',
            body: JSON.stringify({ internalNote: note }),
          })
            .then(function (res) {
              if (!res.ok) {
                return res
                  .json()
                  .catch(function () { return { error: 'Failed to update case' }; })
                  .then(function (data) {
                    throw new Error(data.error || 'Failed to update case');
                  });
              }
              return res.json();
            })
            .then(function () {
              setStatus('Нотатки кейсу збережено', false);
              closeCaseModal();
              loadData();
            })
            .catch(function (err) {
              console.error('Failed to save case notes', err);
              setStatus(err.message || 'Не вдалося зберегти нотатки кейсу', true);
            });
        });

        if (caseTasksForm && caseTaskInput) {
          caseTasksForm.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!currentCaseId) return;
            var title = (caseTaskInput.value || '').trim();
            if (!title) return;
            addCaseTask(title);
          });
        }

        var existingToken = getToken();
        if (existingToken) {
          authedFetch('/auth/me')
            .then(function (res) {
              if (!res.ok) throw new Error('Not authenticated');
              return res.json();
            })
            .then(function (data) {
              setUserInfo(data.user);
              dataCard.style.display = '';
              logoutBtn.style.display = 'inline-flex';
              setStatus('Сесія відновлена', false);
              loadProjectConfig().finally(function () {
                loadData();
              });
            })
            .catch(function () {
              setToken(null);
              setUserInfo(null);
            });
        }
      })();
    
    
    </script>
  </body>
</html>
